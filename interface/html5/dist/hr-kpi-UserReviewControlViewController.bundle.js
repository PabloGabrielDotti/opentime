(self.webpackChunktimetrex=self.webpackChunktimetrex||[]).push([["hr-kpi-UserReviewControlViewController"],{7454:(e,i,t)=>{"use strict";t.r(i),t.d(i,{"UserReviewControlViewController":()=>r});class r extends BaseViewController{constructor(e={}){_.defaults(e,{el:"#user_review_control_view_container",type_array:null,status_array:null,term_array:null,severity_array:null,kpi_group_array:null,document_object_type_id:null,kpi_group_api:null,user_review_api:null,kpi_api:null}),super(e)}init(e){this.edit_view_tpl="UserReviewControlEditView.html",this.permission_id="user_review",this.viewId="UserReviewControl",this.script_name="UserReviewControlView",this.table_name_key="user_review_control",this.context_menu_name=$.i18n._("Reviews"),this.navigation_label=$.i18n._("Review")+":",this.api=TTAPI.APIUserReviewControl,this.kpi_group_api=TTAPI.APIKPIGroup,this.user_review_api=TTAPI.APIUserReview,this.kpi_api=TTAPI.APIKPI,this.document_object_type_id=220,this.render(),this.sub_view_mode?this.buildContextMenu(!0):this.buildContextMenu(),this.sub_view_mode||this.initData(),this.setSelectRibbonMenuIfNecessary("UserReviewControl")}getCustomContextMenuModel(){return{groups:{review:{label:$.i18n._("Review"),id:this.viewId+"Review"}},exclude:[ContextMenuIconName.mass_edit],include:[{label:$.i18n._("Print"),id:"pdf_review_print",group:"review",icon:Icons.print}]}}initOptions(){var e=this;this.initDropDownOption("type"),this.initDropDownOption("status"),this.initDropDownOption("term"),this.initDropDownOption("severity"),this.kpi_group_api.getKPIGroup(!1,!1,!1,{onResult:function(i){if((i=Global.clone(i.getResult()))&&i[0]){i[0].name="-- "+$.i18n._("Add KPIs")+" --";var t={};t.name="-- "+$.i18n._("All")+" --",t.level=1,t.id=TTUUID.not_exist_id,i.hasOwnProperty("0")&&i[0].hasOwnProperty("children")?i[0].children.unshift(t):i=[{children:[t],id:0,level:0,name:"-- "+$.i18n._("Add KPIs")+" --"}],i=Global.buildTreeRecord(i),e.kpi_group_array=i}else e.kpi_group_array=[]}})}buildEditViewUI(){super.buildEditViewUI();var e=this,i={"tab_review":{"label":$.i18n._("Review")},"tab_attachment":!0,"tab_audit":!0};this.setTabModel(i),this.navigation.AComboBox({api_class:TTAPI.APIUserReviewControl,id:this.script_name+"_navigation",allow_multiple_selection:!1,layout_name:"global_kpi_review_control",navigation_mode:!0,show_search_inputs:!0}),this.setNavigation();var t=this.edit_view_tab.find("#tab_review"),r=t.find(".first-column"),a=t.find(".second-column"),o=t.find(".forth-column");this.edit_view_tabs[0]=[],this.edit_view_tabs[0].push(r),this.edit_view_tabs[0].push(a);var n=Global.loadWidgetByName(FormItemType.AWESOME_BOX);n.AComboBox({api_class:TTAPI.APIUser,allow_multiple_selection:!1,layout_name:"global_user",show_search_inputs:!0,set_empty:!0,field:"user_id"});var s={permission_section:"user_review"};if(n.setDefaultArgs(s),this.addEditFieldToColumn($.i18n._("Employee"),n,r,""),(n=Global.loadWidgetByName(FormItemType.AWESOME_BOX)).AComboBox({api_class:TTAPI.APIUser,allow_multiple_selection:!1,layout_name:"global_user",show_search_inputs:!0,set_empty:!0,field:"reviewer_user_id"}),this.addEditFieldToColumn($.i18n._("Reviewer"),n,r),(n=Global.loadWidgetByName(FormItemType.COMBO_BOX)).TComboBox({field:"status_id"}),n.setSourceData(e.status_array),this.addEditFieldToColumn($.i18n._("Status"),n,r),(n=Global.loadWidgetByName(FormItemType.COMBO_BOX)).TComboBox({field:"type_id"}),n.setSourceData(e.type_array),this.addEditFieldToColumn($.i18n._("Type"),n,r),(n=Global.loadWidgetByName(FormItemType.COMBO_BOX)).TComboBox({field:"term_id"}),n.setSourceData(e.term_array),this.addEditFieldToColumn($.i18n._("Terms"),n,r),(n=Global.loadWidgetByName(FormItemType.TEXT_INPUT)).TTextInput({field:"rating",width:50}),this.addEditFieldToColumn($.i18n._("Rating"),n,r,""),(n=Global.loadWidgetByName(FormItemType.COMBO_BOX)).TComboBox({field:"severity_id"}),n.setSourceData(e.severity_array),this.addEditFieldToColumn($.i18n._("Severity"),n,a,""),(n=Global.loadWidgetByName(FormItemType.DATE_PICKER)).TDatePicker({field:"start_date"}),this.addEditFieldToColumn($.i18n._("Start Date"),n,a,"",null),(n=Global.loadWidgetByName(FormItemType.DATE_PICKER)).TDatePicker({field:"end_date"}),this.addEditFieldToColumn($.i18n._("End Date"),n,a,"",null),(n=Global.loadWidgetByName(FormItemType.DATE_PICKER)).TDatePicker({field:"due_date"}),this.addEditFieldToColumn($.i18n._("Due Date"),n,a,"",null),(n=Global.loadWidgetByName(FormItemType.TAG_INPUT)).TTagInput({field:"tag",object_type_id:320}),this.addEditFieldToColumn($.i18n._("Tags"),n,a,"",null,null,!0),this.is_add||this.is_edit){(n=Global.loadWidgetByName(FormItemType.AWESOME_BOX)).AComboBox({tree_mode:!0,allow_multiple_selection:!1,layout_name:"global_tree_column",set_empty:!0,field:"group_id"}),n.setSourceData(e.kpi_group_array);var l=t.find(".third-column").css({"float":"left","margin-top":"10px","margin-bottom":"10px"});l.find(".column-form-item-label").css({"float":"left","margin-right":"10px","margin-top":"5px"}).text($.i18n._("Add KPIs from Groups")),l.find(".column-form-item-input").css({"float":"left"}).append(n),this.edit_view_ui_dic[n.getField()]=n,n.bind("formItemChange",(function(i,t,r){e.onFormItemChange(t,r)}))}(n=Global.loadWidgetByName(FormItemType.TEXT_AREA)).TTextArea({field:"note",width:"100%",height:66}),this.addEditFieldToColumn($.i18n._("Note"),n,o,"first_last",null,null,!0)}initInsideEditorUI(){var e=this.edit_view_tab.find("#tab_review").find(".inside-editor-div"),i={serial:"#",name:$.i18n._("Key Performance Indicator")+"<br>("+$.i18n._("Hover for Description")+")",rating:$.i18n._("Result"),note:$.i18n._("Note")};this.editor=Global.loadWidgetByName(FormItemType.INSIDE_EDITOR),this.editor.InsideEditor({addRow:this.insideEditorAddRow,removeRow:this.insideEditorRemoveRow,getValue:this.insideEditorGetValue,setValue:this.insideEditorSetValue,onFormItemChange:this.onInsideFormItemChange,parent_controller:this,api:this.user_review_api,render:"views/hr/kpi/UserReviewViewInsideEditorRender.html",render_args:i,row_render:"views/hr/kpi/UserReviewViewInsideEditorRow.html"}),e.append(this.editor)}addEditFieldToColumn(e,i,t,r,a,o,n,s,l,d){var _=this,m=$(Global.loadWidgetByName(WidgetNamesDic.EDIT_VIEW_FORM_ITEM)),u=m.find(".edit-view-form-item-label-div"),h=m.find(".edit-view-form-item-label"),c=m.find(".edit-view-form-item-input-div");d?(h.parent().append(d),h.remove()):h.text($.i18n._(e)+": ");var p=i;if(Global.isArray(i))for(var v=0;v<i.length;v++)(p=i[v]).css("opacity",0),this.edit_view_ui_dic[p.getField()]=p,p.unbind("formItemChange").bind("formItemChange",(function(e,i,t){_.onFormItemChange(i,t)})),l&&(p.unbind("formItemKeyUp").bind("formItemKeyUp",(function(e,i){_.onFormItemKeyUp(i)})),p.unbind("formItemKeyDown").bind("formItemKeyDown",(function(e,i){_.onFormItemKeyDown(i)})));else p.css("opacity",0),this.edit_view_ui_dic[p.getField()]=p,p.bind("formItemChange",(function(e,i,t){_.onFormItemChange(i,t)})),l&&(p.bind("formItemKeyUp",(function(e,i){_.onFormItemKeyUp(i)})),p.bind("formItemKeyDown",(function(e,i){_.onFormItemKeyDown(i)})));Global.isSet(a)?c.append(a):c.append(p),n&&("note"===p.getField()?(c.css("width","80%"),u.css("height","80"),p.css({"width":"100%","resize":"none"})):(m.bind("resize",(function(){u.height()!==m.height()&&0!==m.height()&&(u.css("height",m.height()),m.unbind("resize"))})),p.bind("setSize",(function(){u.css("height",p.height()+5)})))),o&&(Global.isArray(i)?this.edit_view_form_item_dic[i[0].getField()]=m:this.edit_view_form_item_dic[p.getField()]=m),t.append(m)}buildSearchFields(){super.buildSearchFields();var e={permission_section:"user_review"};this.search_fields=[new SearchField({label:$.i18n._("Employee"),in_column:1,field:"user_id",default_args:e,layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Reviewer"),in_column:1,field:"reviewer_user_id",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Type"),in_column:1,field:"type_id",multiple:!0,basic_search:!0,adv_search:!0,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Tags"),field:"tag",basic_search:!0,adv_search:!0,in_column:1,object_type_id:320,form_item_type:FormItemType.TAG_INPUT}),new SearchField({label:$.i18n._("Status"),in_column:2,field:"status_id",multiple:!0,basic_search:!0,adv_search:!0,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Terms"),in_column:2,field:"term_id",multiple:!0,basic_search:!0,adv_search:!0,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Severity"),in_column:2,field:"severity_id",multiple:!0,basic_search:!0,adv_search:!0,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Start Date"),in_column:1,field:"start_date",basic_search:!1,adv_search:!0,form_item_type:FormItemType.DATE_PICKER}),new SearchField({label:$.i18n._("End Date"),in_column:1,field:"end_date",basic_search:!1,adv_search:!0,form_item_type:FormItemType.DATE_PICKER}),new SearchField({label:$.i18n._("Due Date"),in_column:1,field:"due_date",basic_search:!1,adv_search:!0,form_item_type:FormItemType.DATE_PICKER}),new SearchField({label:$.i18n._("KPI"),in_column:2,field:"kpi_id",layout_name:"global_kpi",api_class:TTAPI.APIKPI,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Created By"),in_column:2,field:"created_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Updated By"),in_column:2,field:"updated_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX})]}removeEditView(){super.removeEditView(),this.editor=null}setEditViewDataDone(){super.setEditViewDataDone(),this.initInsideEditorData()}onFormItemChange(e,i){var t=this;this.setIsChanged(e),this.setMassEditingFieldsWhenFormChange(e);var r=e.getField(),a=e.getValue();switch(r){case"group_id":var o={filter_data:{}};o.filter_data.group_id=[a],this.kpi_api["get"+this.kpi_api.key_name](o,!1,!0,{onResult:function(e){t.setInsideEditorData(e)}});break;default:this.current_edit_record[r]=a,i||this.validate()}}onInsideFormItemChange(e,i){e.clearErrorStyle();var t=e.getField(),r=e.getValue();switch(t){case"rating":var a=parseInt(e.attr("minimum_rate")),o=parseInt(e.attr("maximum_rate"));""!==r&&((r=parseInt(r))>=a&&r<=o?(e.clearErrorStyle(),this.parent_controller.setEditMenu()):(e.setErrorStyle($.i18n._("Rating must between")+" "+a+" "+$.i18n._("and")+" "+o,!0),this.parent_controller.setErrorMenu()))}}initInsideEditorData(){var e=this,i={filter_data:{}};this.current_edit_record.id&&(i.filter_data.user_review_control_id=this.current_edit_record.id,e.user_review_api["get"+e.user_review_api.key_name](i,!0,{onResult:function(i){e.edit_view&&e.setInsideEditorData(i)}}))}setInsideEditorData(e){var i=e.getResult();if(i.length>0){this.editor||this.initInsideEditorUI();var t=1;for(var r in i){var a=i[r],o=!1;if(a.kpi_id||(a.kpi_id=a.id,a.id=!1),this.editor.editor_data){for(var n=0;n<this.editor.editor_data.length;n++){var s=this.editor.editor_data[n];if(a.kpi_id===s.kpi_id){o=!0;break}}o||(t=this.editor.editor_data.length+1,a.serial=t,this.editor.editor_data.push(a))}else a.serial=t,i[r]=a,t++;o||this.editor.addRow(a)}this.editor.editor_data||(this.editor.editor_data=i)}}insideEditorAddRow(e){var i=this;if(e){var t=this.getRowRender(),r=this.getRender(),a=e,o=Global.loadWidgetByName(FormItemType.TEXT);o.TText({field:"serial",width:50}),o.setValue(e.serial?e.serial:null),t.children().eq(0).append(o),(o=Global.loadWidgetByName(FormItemType.TEXT)).TText({field:"name",width:600}),o.setValue(e.name?e.name:null),o.attr("title",e.description?e.description:""),t.children().eq(1).append(o),10==e.type_id?((o=Global.loadWidgetByName(FormItemType.TEXT_INPUT)).TTextInput({field:"rating",width:40}),o.setValue(e.rating?e.rating:null),o.attr({"minimum_rate":e.minimum_rate,"maximum_rate":e.maximum_rate}),o.bind("formItemChange",(function(e,t,r){i.onFormItemChange(t,r)})),a[o.getField()]=o,t.children().eq(2).append(o),this.setWidgetEnableBaseOnParentController(o)):20==e.type_id&&((o=Global.loadWidgetByName(FormItemType.CHECKBOX)).TCheckbox({field:"rating"}),o.setValue(e.rating?e.rating>=1:null),a[o.getField()]=o,t.children().eq(2).append(o),this.setWidgetEnableBaseOnParentController(o)),(o=Global.loadWidgetByName(FormItemType.TEXT_AREA)).TTextArea({field:"note",style:{width:"300px",height:"20px","min-height":"10px"}}),o.setValue(e.note?e.note:null),a[o.getField()]=o,t.children().eq(3).css("text-align","right").append(o),this.setWidgetEnableBaseOnParentController(o),$(r).append(t),this.parent_controller.is_viewing&&t.find(".control-icon").hide(),this.rows_widgets_array.push(a),this.addIconsEvent(t),this.removeLastRowLine()}else;}onSaveResult(e){var i=this;if(e.isValid()){var t=e.getResult();!0===t?i.refresh_id=i.current_edit_record.id:TTUUID.isUUID(t)&&t!=TTUUID.zero_id&&t!=TTUUID.not_exist_id&&(i.refresh_id=t),i.saveInsideEditorData((function(){i.search(),i.onSaveDone(e),i.removeEditView()}))}else i.setErrorMenu(),i.setErrorTips(e)}onEditClick(e,i){var t=this;t.editor&&(t.editor.remove(),t.editor=null),super.onEditClick(e,i)}saveInsideEditorData(e){if(this.editor){var i=this.editor.getValue(this.refresh_id);this.user_review_api.setUserReview(i,{onResult:function(i){e()}})}else e()}insideEditorGetValue(e){for(var i=this.rows_widgets_array.length,t=0;t<i;t++){var r=this.rows_widgets_array[t];r.rating&&(r.rating=r.rating.getValue()),r.note=r.note.getValue(),r.user_review_control_id=e,this.rows_widgets_array[t]=r}return this.rows_widgets_array}_continueDoCopyAsNew(){(this.is_add=!0,LocalCacheData.current_doing_context_action="copy_as_new",Global.isSet(this.edit_view))?(this.current_edit_record.id="",this.edit_view.find(".navigation-div").css("display","none"),this.editor&&(this.editor.remove(),this.editor=null),this.setEditMenu(),this.setTabStatus(),this.is_changed=!1,ProgressBar.closeOverlay()):super._continueDoCopyAsNew()}onSaveAndNewResult(e){var i=this;if(e.isValid()){var t=e.getResult();!0===t?i.refresh_id=i.current_edit_record.id:TTUUID.isUUID(t)&&t!=TTUUID.zero_id&&t!=TTUUID.not_exist_id&&(i.refresh_id=t),i.saveInsideEditorData((function(){i.search(!1),i.editor&&(i.editor.remove(),i.editor=null),i.onAddClick(!0)}))}else i.setErrorTips(e),i.setErrorMenu()}onSaveAndCopyResult(e){var i=this;if(e.isValid()){var t=e.getResult();!0===t?i.refresh_id=i.current_edit_record.id:TTUUID.isUUID(t)&&t!=TTUUID.zero_id&&t!=TTUUID.not_exist_id&&(i.refresh_id=t),i.saveInsideEditorData((function(){i.search(!1),i.editor&&(i.editor.remove(),i.editor=null),i.onCopyAsNewClick()}))}else i.setErrorTips(e),i.setErrorMenu()}onRightArrowClick(){this.editor&&(this.editor.remove(),this.editor=null),super.onRightArrowClick()}onLeftArrowClick(){this.editor&&(this.editor.remove(),this.editor=null),super.onLeftArrowClick()}searchDone(){super.searchDone(),TTPromise.resolve("ReviewView","init")}setDefaultMenuReportRelatedIcons(e,i,t){this.payStubReportIconsValidate()||e.addClass("invisible-image"),i>0&&this.viewOwnerOrChildPermissionValidate()?e.removeClass("disable-image"):e.addClass("disable-image")}setCustomDefaultMenuIcon(e,i,t){switch(e){case"pdf_review_print":t>0&&this.viewOwnerOrChildPermissionValidate()?i.removeClass("disable-image"):i.addClass("disable-image")}}doFormIFrameCall(e){Global.APIFileDownload("APIKPIReport","getKPIReport",e)}onCustomContextClick(e){var i=this;switch(e){case"pdf_review_print":var t,r=[];i.edit_view&&i.current_edit_record.id?r.push(i.current_edit_record.id):(t=this.getGridSelectIdArray(),$.each(t,(function(e,t){var a=i.getRecordFromGridById(t);r.push(a.id)}))),this.doFormIFrameCall({0:{"user_review_control_id":r},1:"pdf_review_print"})}}}r.loadSubView=function(e,i,t){Global.loadViewSource("UserReviewControl","SubUserReviewControlView.html",(function(r){var a=_.template(r);Global.isSet(i)&&i(),Global.isSet(e)&&(e.html(a({})),Global.isSet(t)&&TTPromise.wait("BaseViewController","initialize",(function(){t(sub_user_review_control_view_controller)})))}))}}}]);
//# sourceMappingURL=hr-kpi-UserReviewControlViewController.bundle.js.map?v=be2d9c508c381cc7b99c