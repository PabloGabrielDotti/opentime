(self.webpackChunktimetrex=self.webpackChunktimetrex||[]).push([["company-geo_fence-GEOFenceViewController"],{7191:(e,t,i)=>{"use strict";i.r(t),i.d(t,{"GEOFenceViewController":()=>r});var a=i(5243),o=i.n(a);i(1787),i(3161);class r extends BaseViewController{constructor(e={}){_.defaults(e,{el:"#geo_fence_view_container",type_array:null,company_api:null,drawControl:null,bounds:null,drawnItems:null,search_key_delay:0,start_coordinates:null,map_html_id:null}),super(e)}init(){this.edit_view_tpl="GEOFenceEditView.html",this.permission_id="geo_fence",this.viewId="GEOFence",this.script_name="GEOFenceView",this.table_name_key="geo_fence",this.context_menu_name=$.i18n._("GEO Fence"),this.navigation_label=$.i18n._("GEO Fence")+":",this.api=TTAPI.APIGEOFence,this.company_api=TTAPI.APICompany,this.map&&delete this.map,this.render(),this.buildContextMenu(),this.initData(),this.setSelectRibbonMenuIfNecessary()}getCustomContextMenuModel(){return{groups:{map:{label:$.i18n._("Map"),id:this.viewId+"Navigation"}},exclude:[ContextMenuIconName.export_excel,ContextMenuIconName.mass_edit],include:[{label:$.i18n._("Map"),id:ContextMenuIconName.map,group:"map",icon:Icons.map}]}}onCustomContextClick(e){switch(e){case ContextMenuIconName.map:this.onMapClick()}}onSaveAndContinueClick(){super.onSaveAndContinueClick()}onMapClick(){var e;Global.getProductEdition()>=15&&(e=this.edit_view?[this.current_edit_record]:this.getGridSelectIdArray().length>0?this.getSelectedItems():this.grid.getGridParam("data"),IndexViewController.openEditView(this,"Map",e))}onAddClick(){$(".GEOFenceEditView").remove(),TTPromise.add("init","init"),super.onAddClick();var e=this;TTPromise.wait("init","init",(function(){for(var t in e._selectedShape=!1,e.current_edit_record={},e.edit_view_ui_dic)e.edit_view_ui_dic[t].setValue("");e._map||e._initLeafletMap(),e._map.setView(e.start_coordinates,10)}))}getFilterColumnsFromDisplayColumns(){var e={is_owner:!0,id:!0,is_child:!0,in_use:!0,first_name:!0,last_name:!0,geo_circle:!0,geo_color:!0,geo_polygon:!0,geo_type_id:!0},t=[];if(this.grid&&(t=this.grid.getGridParam("colModel")),t)for(var i=t.length,a=0;a<i;a++){e[t[a].name]=!0}return e}buildEditViewUI(){super.buildEditViewUI();var e,t={"tab_geo_fence":{"label":$.i18n._("GEO Fence")},"tab_audit":!0};this.setTabModel(t),this.navigation.AComboBox({api_class:TTAPI.APIGEOFence,id:this.script_name+"_navigation",allow_multiple_selection:!1,layout_name:"global_geo_fence",navigation_mode:!0,show_search_inputs:!0}),this.setNavigation();var i=this.edit_view_tab.find("#tab_geo_fence").find(".first-column");this.edit_view_tabs[0]=[],this.edit_view_tabs[0].push(i),(e=Global.loadWidgetByName(FormItemType.TEXT_INPUT)).TTextInput({field:"name",width:"100%"}),this.addEditFieldToColumn($.i18n._("Name"),e,i),e.parent().width("45%"),(e=Global.loadWidgetByName(FormItemType.COLOR_PICKER)).TColorPicker({field:"geo_color"}),this.addEditFieldToColumn($.i18n._("Color"),e,i),(e=Global.loadWidgetByName(FormItemType.TEXT_INPUT)).TTextInput({field:"description",width:"100%"}),this.addEditFieldToColumn($.i18n._("Description"),e,i),e.parent().width("45%"),this._initLeafletMap()}_initLeafletMap(){var e;if(this.neeed_save_punches_dic={},this.layers=[],this.line_layers=[],this.circle_layers=[],this.directions_displays=[],this.info_panel_dic={},this.geo_layers=[],this._map&&null!=this._map&&null!=$("#tab_geo_fence:visible #map_container div.google-map")[0]||(this.map_html_id="map_"+(new Date).getTime(),Debug.Text("New Lmap id: "+this.map_html_id,"GEOFenceViewController.js","GEOFenceViewController","_initLeafletMap",10),$("#tab_geo_fence:visible #map_container").html('<div id="'+this.map_html_id+'" class="google-map"></div>'),this._map=o().map(this.map_html_id),Debug.Arr(this._map,"Lmap var","GEOFenceViewController.js","GEOFenceViewController","_initLeafletMap",10)),"timetrex"==APIGlobal.pre_login_data.map_provider){var t=APIGlobal.pre_login_data.map_tile_url+"/{z}/{x}/{y}.png?tt_key="+APIGlobal.pre_login_data.registration_key;e=new(o().TileLayer)(t,{minZoom:3,maxZoom:18,attribution:'Map data by Â©<a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>.',noWrap:!0})}else e=o().tileLayer.provider(APIGlobal.pre_login_data.map_provider);e.on("load",(function(){TTPromise.resolve("Map","render")})),this._map.addLayer(e),this.start_coordinates=this.startMapCoordinates(),this._map.setView(this.start_coordinates,10),this.drawnItems=new(o().FeatureGroup),this.drawnItems.do_not_clear=!0,this._map.addLayer(this.drawnItems),this.drawControl=new(o().Control.Draw)({edit:{featureGroup:this.drawnItems,edit:!1,remove:!1},draw:{polygon:{shapeOptions:{color:"#0F820F"}},circle:{shapeOptions:{color:"#0F820F"}},polyline:!1,rectangle:!1,marker:!1,circlemarker:!1}}),this._map.addControl(this.drawControl);var i=this;this._map.on(o().Draw.Event.DRAWSTART,(function(e){i.removeAllLayers()})),this._map.on(o().Draw.Event.CREATED,(function(e){e.layerType;var t=e.layer;t.editable=!0,t.removable=!0,i.removeAllLayers(),i._selectedShape=t,i.drawnItems.addLayer(t),t.editing.enable(),i.is_changed=!0,i.setEditMenu(),i.validate()})),this._initSearchBox()}_onShapeUpdate(e){var t=e.target;t.editable=!0,t.removable=!0,this._selectedShape=t,this.drawnItems.addLayer(t),t.editing.enable(),this.is_changed=!0,this.setEditMenu()}removeAllLayers(){for(var e in this.drawnItems._layers)if(1==this.drawnItems._layers[e].removable)try{this.drawnItems.removeLayer(this.drawnItems._layers[e])}catch(t){Debug.Text(t.message,"GeoFenceController.js","GeoFenceController","GeoFenceController",10)}}onFormItemChange(e,t){super.onFormItemChange(e,t);var i=e.getField();if("geo_color"==i)for(var a in this.drawControl.options.draw.polygon.shapeOptions.color=this.edit_view_ui_dic[i].val(),this.drawControl.options.draw.circle.shapeOptions.color=this.edit_view_ui_dic[i].val(),this.drawnItems._layers)void 0===this.drawnItems._layers[a].is_search_marker&&this.drawnItems._layers[a].setStyle({fillColor:this.edit_view_ui_dic[i].val(),color:this.edit_view_ui_dic[i].val()})}_initSearchBox(){var e=this;$("#pac-input").bind("focus",(function(e){$(this).select()})),$("#pac-input").bind("keyup",(function(t){13==t.keyCode?$("#suggestion-box div").first().click():(e.search_key_delay=parseInt(Date.now()),window.setTimeout((function(){parseInt(Date.now())-e.search_key_delay>=250&&(e.stop_suggestions=!1,e.searchSuggest())}),300))}))}searchSuggest(){$("#suggestion-box").html("");var e=this;if($("#pac-input").val().length>=3){$("#pac-input").css("border","1px dotted green");var t=APIGlobal.pre_login_data.map_geocode_url+"?q="+encodeURIComponent($("#pac-input").val())+"&format=json&tt_key="+APIGlobal.pre_login_data.registration_key;$.get(t,(function(t){if($("#pac-input").css("border","none"),0==e.stop_suggestions)for(var i in $("#suggestion-box").html(""),t){var a=t[i].display_name,r="<div class='map-suggest' lat='"+t[i].lat+"' lng='"+t[i].lon+"' bound0='"+t[i].boundingbox[0]+"' bound1='"+t[i].boundingbox[1]+"' bound2='"+t[i].boundingbox[2]+"' bound3='"+t[i].boundingbox[3]+"' style='display:block;position:relative;cursor:pointer;padding:7px;background:white;'>"+a+"</div>";$("#suggestion-box").append(r),$("#suggestion-box .map-suggest").bind("click",(function(){e._map.panTo(new(o().LatLng)($(this).attr("lat"),$(this).attr("lng")));var t=$(this).html(),i=$(this).attr("bound0"),a=$(this).attr("bound2"),r=$(this).attr("bound1"),n=$(this).attr("bound3");$("#pac-input").val(t);var s=new(o().latLngBounds)([i,a],[r,n]);e._map.fitBounds(s,{padding:[20,20]});var l=o().icon({iconUrl:"framework/leaflet/images/marker-icon-red.png",shadowUrl:"framework/leaflet/images/marker-shadow.png",iconSize:[25,41],shadowSize:[41,41],iconAnchor:[0,0],shadowAnchor:[0,0],popupAnchor:[12,0]});for(var d in e.drawnItems._layers)null!=e.drawnItems._layers[d].is_search_marker&&1==e.drawnItems._layers[d].is_search_marker&&e.drawnItems.removeLayer(e.drawnItems._layers[d]);var _=o().marker(s.getCenter(),{draggable:!1,icon:l});_.is_marker=!0,_.is_search_marker=!0,_.addTo(e.drawnItems).bindPopup(t).openPopup(),$("#suggestion-box").html(""),$("#suggestion-box").fadeOut("fast"),e.stop_suggestions=!0})),$("#suggestion-box").fadeIn("fast")}}))}}saveLayout(){var e=this;this.user_generic_data_api.setUserGenericData(this.select_layout,{onResult:function(t){if(t.isValid()){var i=t.getResult();TTUUID.isUUID(i)&&i!=TTUUID.zero_id&&i!=TTUUID.not_exist_id&&(e.select_layout.id=i)}}})}centerMap(){this._map.panTo(this.start_coordinates)}uniformVariable(e){if(e.geo_circle=!1,e.geo_type_id=10,e.map_level=!1,this._selectedShape&&null!=this._selectedShape._radius)e.geo_circle={},e.geo_circle.center=[this._selectedShape.getLatLng().lat,this._selectedShape.getLatLng().lng],e.geo_circle.radius=this._selectedShape._mRadius,e.geo_type_id=20,e.map_level=this._map.getZoom();else if(this._selectedShape){for(var t=this._selectedShape.getLatLngs()[0],i=[],a=0;a<t.length;a++)i.push([t[a].lat,t[a].lng]);e.geo_polygon=i,e.geo_type_id=10,e.map_level=this._map.getZoom()}return e}setCurrentEditRecordData(){var e=this;this.user_generic_data_api.getUserGenericData({filter_data:{script:"MapView",deleted:!1}},{onResult:function(t){var i=t.getResult();for(var a in i&&i.length>0?e.select_layout=i[0]:e.select_layout={script:"MapView",is_default:!1,name:Global.default_item,data:{marker_connection_type:"LINE"}},e.current_edit_record)if(e.current_edit_record.hasOwnProperty(a)){var r=e.edit_view_ui_dic[a];Global.isSet(r)&&r.setValue(e.current_edit_record[a])}e.drawnItems&&e.removeAllLayers(),e.bounds=new(o().LatLngBounds),20==e.current_edit_record.geo_type_id&&e.current_edit_record.geo_circle?e._drawCircle(e.current_edit_record.geo_circle):10==e.current_edit_record.geo_type_id&&e.current_edit_record.geo_polygon?e._drawPolygon(e.current_edit_record.geo_polygon):e.centerMap(),e.current_edit_record.map_level=e._map.getZoom(),e.collectUIDataToCurrentEditRecord(),e.setEditViewDataDone()}})}_drawCircle(e){Debug.Text("drawing circle","GEOFenceViewController.js","GEOFenceViewController","_drawCircle",10);var t=new(o().Circle)([parseFloat(e.center[0]),parseFloat(e.center[1])],parseFloat(e.radius),{stroke:!0,fill:!0,opacity:.8,weight:2,color:this.current_edit_record.geo_color?"#"+this.current_edit_record.geo_color:"#0F820F",fillOpacity:.25,fillColor:this.current_edit_record.geo_color?"#"+this.current_edit_record.geo_color:"#0F820F"});t.removable=!0,t.addTo(this.drawnItems),this.is_edit?t.editing.enable():t.editing.disable(),this._map.fitBounds(t.getBounds(),{padding:[20,20]}),this.geo_layers.push(t);var i=this;t.on("edit",(function(e){i._onShapeUpdate(e)}))}_drawPolygon(e){Debug.Text("drawing polygon","GEOFenceViewController.js","GEOFenceViewController","_drawPolygon",10);_.map(e,(function(e){return{lat:parseFloat(e[0]),lng:parseFloat(e[1])}}));var t=new(o().Polygon)(e,{stroke:!0,fill:!0,opacity:.8,weight:2,color:this.current_edit_record.geo_color?"#"+this.current_edit_record.geo_color:"#0F820F",fillOpacity:.25,fillColor:this.current_edit_record.geo_color?"#"+this.current_edit_record.geo_color:"#0F820F"});t.removable=!0,this.is_edit?t.editing.enable():t.editing.disable(),t.addTo(this.drawnItems),this._map.fitBounds(t.getBounds(),{padding:[20,20]}),this.geo_layers.push(t);var i=this;t.on("edit",(function(e){i._onShapeUpdate(e)}))}buildSearchFields(){super.buildSearchFields(),this.search_fields=[new SearchField({label:$.i18n._("Name"),in_column:1,field:"name",multiple:!0,basic_search:!0,form_item_type:FormItemType.TEXT_INPUT}),new SearchField({label:$.i18n._("Created By"),in_column:2,field:"created_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!0,script_name:"EmployeeView",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Updated By"),in_column:2,field:"updated_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!0,script_name:"EmployeeView",form_item_type:FormItemType.AWESOME_BOX})]}setEditMenuMapIcon(e){Global.getProductEdition()<=10&&e.addClass("invisible-image"),e.addClass("disable-image")}setDefaultMenuMapIcon(e,t){Global.getProductEdition()<=10&&e.addClass("invisible-image"),t>0?e.removeClass("disable-image"):e.addClass("disable-image")}setEditViewDataDone(){this.is_edit=!0,super.setEditViewDataDone();var e=this;TTPromise.wait(null,null,(function(){e.edit_view_ui_dic.geo_color&&(e.drawControl.options.draw.polygon.shapeOptions.color=e.edit_view_ui_dic.geo_color.val(),e.drawControl.options.draw.circle.shapeOptions.color=e.edit_view_ui_dic.geo_color.val())}))}onSaveAndContinue(e){this.removeAllLayers(),super.onSaveAndContinue()}setNavigation(){var e=this;this.grid&&(this.navigation.setPossibleDisplayColumns(this.buildDisplayColumnsByColumnModel(this.grid.grid.getGridParam("colModel")),this.buildDisplayColumns(this.default_display_columns)),this.navigation.unbind("formItemChange").bind("formItemChange",(function(t,i){i.getField();var a=i.getValue();a&&(a!==e.current_edit_record.id&&(ProgressBar.showOverlay(),TTPromise.add("Map","render"),e.is_viewing?e.onViewClick(a):e.onEditClick(a)),TTPromise.wait("Map","render",(function(){e.setNavigationArrowsEnabled()})))})))}}}}]);
//# sourceMappingURL=company-geo_fence-GEOFenceViewController.bundle.js.map?v=6aedd7d7548ebc576e57