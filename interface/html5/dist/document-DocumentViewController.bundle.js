(self.webpackChunktimetrex=self.webpackChunktimetrex||[]).push([["document-DocumentViewController","filebrowser-TImage","filebrowser-TImageBrowser"],{1469:()=>{!function(e){e.fn.TImage=function(t){Global.addCss("global/widgets/filebrowser/TImageBrowser.css");var i,n=e.extend({},e.fn.TImage.defaults,t);return this.clearErrorStyle=function(){},this.getField=function(){return i},this.getValue=function(){return null},this.setValue=function(e){if(e){var t=new Date;this.attr("src",e+"&t="+t.getTime())}else this.attr("src","")},this.each((function(){var t=e.meta?e.extend({},n,e(this).data()):n;i=t.field})),this},e.fn.TImage.defaults={},e(document).on("mouseover",".file-browser img",(function(t){var i=e(t.target).parents(".file-browser");if(!e(".file_browser_overlay")[0]&&1==e(t.target).attr("enable-delete")){var n=e(t.target).height(),a=(n-32)/2,o=e('<div class="file_browser_overlay"><img src="theme/default/images/delete-512.png" style="position:absolute;width:32px;height:32px;top:'+a+"px;left:"+a+'px;"></div>');o.css("position","absolute"),o.css("top","0px"),o.css("left","0"),o.css("cursor","pointer"),o.css("height",n+"px"),o.css("width","100%"),o.css("background","rgba(255,255,255,0.85)"),e(t.target).parents(".file-browser").append(o),e(document).on("click",".file_browser_overlay",(function(t){e(t.target).parent().find("img").attr("src");TAlertManager.showConfirmAlert(e.i18n._("This will permanently delete the image. Are you sure?"),"",(function(e){if(e){var t={type:"deleteClick",message:"Delete image clicked.",time:new Date};i.trigger(t)}}))})),e(document).on("mouseleave",".file-browser",(function(){(e(document).off("click",".file_browser_overlay"),e(".file_browser_overlay")[0])&&e(this).find(".file_browser_overlay").off().remove()}))}}))}(jQuery)},3536:()=>{!function(e){e.fn.TImageBrowser=function(t){Global.addCss("global/widgets/filebrowser/TImageBrowser.css");var i,n,a=e.extend({},e.fn.TImageBrowser.defaults,t),o=this,s="filedata",r="",l=177,d=42;this.setEnabled=function(e){e;var t=this.find(".browser-form input");e?(t.removeAttr("disabled"),t.removeClass("disable-element")):(t.attr("disabled",!0),t.removeClass("disable-element").addClass("disable-element"))},this.clearErrorStyle=function(){},this.getFileName=function(){return n.val()},this.getField=function(){return i},this.setEnableDelete=function(e){var t=o.find(".image");e?t.attr("enable-delete",1):t.removeAttr("enable-delete")},this.getValue=function(){return n&&n.val()?"undefined"==typeof FormData?o.find(".browser-form"):new FormData(e(o.find(".browser-form"))[0]):null},this.getImageSrc=function(){return o.find(".image").attr("src")},this.setImage=function(e){var t=o.find(".image");if(!e)return t.attr("src",""),void t.hide();var i=new Date;t.hide(),t.attr("src",e+"&t="+i.getTime()),t.css("height","auto"),t.css("width","auto")};return this.setValue=function(e){e||(e="")},this.each((function(){var t=e.meta?e.extend({},a,e(this).data()):a;i=t.field,t.default_width>0&&(l=t.default_width),t.default_height>0&&(d=t.default_height),Global.isSet(t.name)&&(s=t.name),Global.isSet(r)&&(r=t.accept_filter),n=e(this).find(".browser");var c=e(this).find(".image");c.hide(),c.on("load",(function(){!function(t){var i=e(t).height()>0?e(t).height():t.naturalHeight,n=e(t).width()>0?e(t).width():t.naturalWidth;i>d&&e(t).css("height",d),n>l&&(e(t).css("width",l),e(t).css("height","auto")),o.trigger("setSize"),i<5?e(t).hide():e(t).show()}(this)})),r?n.attr("accept",r):(r="image/*",n.attr("accept","image/*")),n.attr("id","file_browser"),n.attr("name",s),Global.isSet(t.changeHandler)&&o.bind("imageChange",t.changeHandler),Global.isSet(t.deleteImageHandler)&&this.find(".file-browser").on("deleteClick",(function(){t.deleteImageHandler()})),n.bind("change",(function(){if(c.hide(),"undefined"!=typeof FileReader){var e=this.files?this.files:[];if(!e.length||!window.FileReader)return;if("image/*"===r){var t=new FileReader;t.readAsDataURL(e[0]),t.onloadend=function(){var e=this.result;c.attr("src",e)}}}o.trigger("imageChange",[o])}))})),this},e.fn.TImageBrowser.defaults={}}(jQuery)},1214:(e,t,i)=>{"use strict";i.r(t),i.d(t,{"DocumentViewController":()=>n});i(1469),i(3536);class n extends BaseViewController{constructor(e={}){_.defaults(e,{el:"#document_view_container",status_array:null,document_group_array:null,document_group_api:null,document_revision_api:null,document_attach_api:null,sub_document_revision_view_controller:null,sub_revision_view_controller:null,document_object_type_id:null}),super(e)}init(e){this.edit_view_tpl="DocumentEditView.html",this.permission_id="document",this.viewId="Document",this.script_name="DocumentView",this.table_name_key="document",this.context_menu_name=$.i18n._("Documents"),this.navigation_label=$.i18n._("Document")+":",this.api=TTAPI.APIDocument,this.document_group_api=TTAPI.APIDocumentGroup,this.document_revision_api=TTAPI.APIDocumentRevision,this.document_attach_api=TTAPI.APIDocumentAttachment,this.render(),this.sub_view_mode?this.buildContextMenu(!0):this.buildContextMenu(),this.sub_view_mode||this.initData()}getCustomContextMenuModel(){return{groups:{download:{label:$.i18n._("Download"),id:this.script_name+"download"}},exclude:[ContextMenuIconName.copy],include:[{label:$.i18n._("Download"),id:ContextMenuIconName.download,group:"download",icon:Icons.download},{label:$.i18n._("View"),id:ContextMenuIconName.view_file,group:"download",icon:Icons.view}]}}setDefaultMenu(e){if(this.context_menu_array){Global.isSet(e)&&e||this.selectContextMenu(),this.setTotalDisplaySpan();for(var t=this.context_menu_array.length,i=this.getGridSelectIdArray().length,n=0;n<t;n++){var a=$(this.context_menu_array[n]),o=$(a.find(".ribbon-sub-menu-icon")).attr("id");switch(a.removeClass("invisible-image"),a.removeClass("disable-image"),o){case ContextMenuIconName.add:this.setDefaultMenuAddIcon(a,i);break;case ContextMenuIconName.edit:this.setDefaultMenuEditIcon(a,i);break;case ContextMenuIconName.view:this.setDefaultMenuViewIcon(a,i);break;case ContextMenuIconName.mass_edit:this.setDefaultMenuMassEditIcon(a,i);break;case ContextMenuIconName.copy:this.setDefaultMenuCopyIcon(a,i);break;case ContextMenuIconName.delete_icon:this.setDefaultMenuDeleteIcon(a,i);break;case ContextMenuIconName.delete_and_next:this.setDefaultMenuDeleteAndNextIcon(a,i);break;case ContextMenuIconName.save:this.setDefaultMenuSaveIcon(a,i);break;case ContextMenuIconName.save_and_next:this.setDefaultMenuSaveAndNextIcon(a,i);break;case ContextMenuIconName.save_and_continue:this.setDefaultMenuSaveAndContinueIcon(a,i);break;case ContextMenuIconName.save_and_new:this.setDefaultMenuSaveAndAddIcon(a,i);break;case ContextMenuIconName.save_and_copy:this.setDefaultMenuSaveAndCopyIcon(a,i);break;case ContextMenuIconName.copy_as_new:this.setDefaultMenuCopyAsNewIcon(a,i);break;case ContextMenuIconName.cancel:this.setDefaultMenuCancelIcon(a,i);break;case ContextMenuIconName.download:case ContextMenuIconName.view_file:this.setDefaultMenuDownIcon(a,i);break;case ContextMenuIconName.export_excel:this.setDefaultMenuExportIcon(a)}}this.setContextMenuGroupVisibility()}}setDefaultMenuDownIcon(e,t,i){1===t?e.removeClass("disable-image"):e.addClass("disable-image")}initOptions(){var e=this;this.initDropDownOption("status"),this.document_group_api.getDocumentGroup("",!1,!1,{onResult:function(t){t=t.getResult(),t=Global.buildTreeRecord(t),e.sub_view_mode||!e.sub_view_mode&&e.basic_search_field_ui_dic.group_id&&(e.basic_search_field_ui_dic.group_id.setSourceData(t),e.adv_search_field_ui_dic.group_id.setSourceData(t)),e.document_group_array=t}})}getSubViewFilter(e){return 0===e.length&&(e={}),this.sub_view_mode&&Global.isSet(this.document_object_type_id)&&(e.object_type_id=this.document_object_type_id),e}buildSearchFields(){super.buildSearchFields(),this.search_fields=[new SearchField({label:$.i18n._("Status"),in_column:1,field:"status_id",multiple:!0,basic_search:!0,adv_search:!0,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Name"),in_column:1,field:"name",multiple:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.TEXT_INPUT}),new SearchField({label:$.i18n._("Description"),in_column:1,field:"description",multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.TEXT_INPUT}),new SearchField({label:$.i18n._("File Name"),in_column:1,field:"remote_file_name",multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.TEXT_INPUT}),new SearchField({label:$.i18n._("Tags"),field:"tag",basic_search:!0,adv_search:!0,in_column:1,object_type_id:700,form_item_type:FormItemType.TAG_INPUT}),new SearchField({label:$.i18n._("Group"),in_column:2,multiple:!0,field:"group_id",layout_name:"global_tree_column",tree_mode:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Template"),field:"template",basic_search:!0,adv_search:!0,in_column:2,form_item_type:FormItemType.CHECKBOX}),new SearchField({label:$.i18n._("Private"),field:"private",basic_search:!(!PermissionManager.validate("document","view")||!PermissionManager.validate("document","view_private")),adv_search:!(!PermissionManager.validate("document","view")||!PermissionManager.validate("document","view_private")),in_column:2,form_item_type:FormItemType.CHECKBOX}),new SearchField({label:$.i18n._("Attachments"),field:"is_attachment",basic_search:!1,adv_search:!!(PermissionManager.validate("document","view")&&PermissionManager.validate("document","view_private")&&PermissionManager.validate("document","edit")&&PermissionManager.validate("user","edit")),in_column:2,form_item_type:FormItemType.CHECKBOX}),new SearchField({label:$.i18n._("Created By"),in_column:2,field:"created_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Updated By"),in_column:2,field:"updated_by",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX})]}buildEditViewUI(){super.buildEditViewUI();var e={"tab_document":{"label":$.i18n._("Document")},"tab_revision":{"label":$.i18n._("Revision"),"init_callback":"initSubDocumentRevisionView","display_on_mass_edit":!1},"tab_audit":!0};this.setTabModel(e),this.navigation.AComboBox({api_class:TTAPI.APIDocument,id:this.script_name+"_navigation",allow_multiple_selection:!1,layout_name:"global_document",navigation_mode:!0,show_search_inputs:!0}),this.setNavigation();var t=this.edit_view_tab.find("#tab_document").find(".first-column");this.edit_view_tabs[0]=[],this.edit_view_tabs[0].push(t);var i=Global.loadWidgetByName(FormItemType.COMBO_BOX);i.TComboBox({field:"status_id"}),i.setSourceData(this.status_array),this.addEditFieldToColumn($.i18n._("Status"),i,t,""),(i=Global.loadWidgetByName(FormItemType.TEXT_INPUT)).TTextInput({field:"name",width:"100%"}),this.addEditFieldToColumn($.i18n._("Name"),i,t),i.parent().width("45%"),(i=Global.loadWidgetByName(FormItemType.TEXT_INPUT)).TTextInput({field:"revision",width:114}),this.addEditFieldToColumn($.i18n._("Revision"),i,t,"",null,!0),i=Global.loadWidgetByName(FormItemType.FILE_BROWSER),this.file_browser=i.TImageBrowser({field:"file",name:"filedata",accept_filter:"*"}),this.addEditFieldToColumn($.i18n._("File"),i,t,"",null,!0,!0),(i=Global.loadWidgetByName(FormItemType.AWESOME_BOX)).AComboBox({tree_mode:!0,allow_multiple_selection:!1,layout_name:"global_tree_column",field:"group_id",set_empty:!0}),i.setSourceData(this.document_group_array),this.addEditFieldToColumn($.i18n._("Group"),i,t),(i=Global.loadWidgetByName(FormItemType.CHECKBOX)).TCheckbox({field:"template"}),this.addEditFieldToColumn($.i18n._("Template"),i,t),(i=Global.loadWidgetByName(FormItemType.CHECKBOX)).TCheckbox({field:"private"}),this.addEditFieldToColumn($.i18n._("Private"),i,t),(i=Global.loadWidgetByName(FormItemType.TEXT_AREA)).TTextArea({field:"description"}),this.addEditFieldToColumn($.i18n._("Description"),i,t,"",null,!1,!0),(i=Global.loadWidgetByName(FormItemType.TAG_INPUT)).TTagInput({field:"tag",object_type_id:700}),this.addEditFieldToColumn($.i18n._("Tags"),i,t,"",null,null,!0)}isEditChange(){this.current_edit_record.id||this.is_mass_editing?(this.detachElement("revision"),this.detachElement("file")):(this.attachElement("revision"),this.attachElement("file")),this.editFieldResize()}setEditViewDataDone(){super.setEditViewDataDone(),this.isEditChange()}onCustomContextClick(e){switch(e){case ContextMenuIconName.view_file:this.onDownloadClick()}}doFormIFrameCall(){var e=ServiceCaller.getURLByObjectType("file_download")+"&object_type=document&parent_id="+this.current_edit_record.id;Global.isSet(this.document_object_type_id)&&(e=e+"&parent_object_type_id="+this.document_object_type_id),e=e+"&object_id="+this.current_edit_record.document_revision_id,Global.APIFileDownload(null,null,null,e)}onDownloadClick(){if(this.edit_view&&this.current_edit_record.id)this.doFormIFrameCall();else{var e,t={},i=this.getGridSelectIdArray();i.length>0&&(e=i[0]),t.filter_data={},t.filter_data.id=[e],t.filter_data.object_type_id=this.document_object_type_id;var n=this.api["get"+this.api.key_name](t,{async:!1}).getResult();n||(n=[]),n=n[0],this.current_edit_record=n,this.doFormIFrameCall()}}getAPIFilters(){var e=super.getAPIFilters();return e.filter_data.object_type_id=this.document_object_type_id,e}onAddResult(e){var t=this,i=e.getResult();i||(i=[]),i.company=LocalCacheData.current_company.name,i.revision="1.0",t.sub_view_mode&&t.parent_key&&(i[t.parent_key]=t.parent_value),t.current_edit_record=i,t.initEditView()}onCustomContextClick(e){switch(e){case ContextMenuIconName.download:case ContextMenuIconName.view_file:this.onDownloadClick()}}setAttachmentBinding(e,t){var i=this,n=e.getResult();if(0!=TTUUID.isUUID(n))if(i.sub_view_mode){var a={};a.object_type_id=i.document_object_type_id,a.object_id=i.parent_value,a.document_id=n,i.document_attach_api.setDocumentAttachment(a,{onResult:()=>{super[t](e)}})}else super[t](e);else super[t](e)}handleSaveResult(e,t){var i,n=e.getResult(),a=this;if(i=a.current_edit_record.id||this.is_mass_editing?null:a.file_browser.getValue(),1==e.isValid()&&i){var o={};o.document_id=n,o.revision=this.current_edit_record.revision,a.document_revision_api["set"+a.document_revision_api.key_name](o,{onResult:function(o){if(o.isValid()){var s="object_type=document_revision&object_id="+o.getResult();Global.isSet(a.document_object_type_id)&&(s=s+"&parent_object_type_id="+a.document_object_type_id),a.api.uploadFile(i,s,{onResult:function(i){a.setAttachmentBinding(e,t)}})}else a.api["delete"+a.api.key_name]([n],{onResult:function(){}}),TAlertManager.showErrorAlert(o)}})}else a.setAttachmentBinding(e,t)}onSaveResult(e){return this.handleSaveResult(e,"onSaveResult")}onSaveAndContinueResult(e){return this.handleSaveResult(e,"onSaveAndContinueResult")}onSaveAndNewResult(e){return this.handleSaveResult(e,"onSaveAndNewResult")}onSaveAndCopyResult(e){return this.handleSaveResult(e,"onSaveAndCopyResult")}setEditMenu(){this.selectContextMenu();for(var e=this.context_menu_array.length,t=0;t<e;t++){var i=$(this.context_menu_array[t]),n=$(i.find(".ribbon-sub-menu-icon")).attr("id");if(i.removeClass("disable-image"),this.is_mass_editing)switch(n){case ContextMenuIconName.save:this.setEditMenuSaveIcon(i);break;case ContextMenuIconName.cancel:break;default:i.addClass("disable-image")}else switch(n){case ContextMenuIconName.add:this.setEditMenuAddIcon(i);break;case ContextMenuIconName.edit:this.setEditMenuEditIcon(i);break;case ContextMenuIconName.view:this.setEditMenuViewIcon(i);break;case ContextMenuIconName.mass_edit:this.setEditMenuMassEditIcon(i);break;case ContextMenuIconName.copy:this.setEditMenuCopyIcon(i);break;case ContextMenuIconName.delete_icon:this.setEditMenuDeleteIcon(i);break;case ContextMenuIconName.delete_and_next:this.setEditMenuDeleteAndNextIcon(i);break;case ContextMenuIconName.save:this.setEditMenuSaveIcon(i);break;case ContextMenuIconName.save_and_continue:this.setEditMenuSaveAndContinueIcon(i);break;case ContextMenuIconName.save_and_new:this.setEditMenuSaveAndAddIcon(i);break;case ContextMenuIconName.save_and_next:this.setEditMenuSaveAndNextIcon(i);break;case ContextMenuIconName.save_and_copy:this.setEditMenuSaveAndCopyIcon(i);break;case ContextMenuIconName.copy_as_new:this.setEditMenuCopyAndAddIcon(i);break;case ContextMenuIconName.cancel:break;case ContextMenuIconName.download:case ContextMenuIconName.view_file:this.setEditMenuDownloadIcon(i);break;case ContextMenuIconName.export_excel:this.setDefaultMenuExportIcon(i)}}this.setContextMenuGroupVisibility()}setEditMenuDownloadIcon(e,t){this.current_edit_record&&this.current_edit_record.id||e.addClass("disable-image")}getGridSetup(){var e=this,t={container_selector:this.sub_view_mode?".edit-view-tab-bar":".view",sub_grid_mode:!1,onGridResize:!0,onSelectRow:function(){e.onGridSelectRow()},onCellSelect:function(){e.onGridSelectRow()},onSelectAll:function(){e.onGridSelectAll()},ondblClickRow:function(t){e.onGridDblClickRow(t)},onRightClickRow:function(t){e.getGridSelectIdArray().indexOf(t)<0&&(e.grid.grid.resetSelection(),e.grid.grid.setSelection(t),e.onGridSelectRow())},height:200};return this.sub_view_mode&&(t.setGridSize=function(){e.baseViewSubTabGridResize("tab_attachment")}),t}removeEditView(){super.removeEditView(),this.sub_revision_view_controller=null}initSubDocumentRevisionView(){var e=this;if(this.current_edit_record.id){if(this.sub_revision_view_controller)return this.sub_revision_view_controller.buildContextMenu(!0),this.sub_revision_view_controller.setDefaultMenu(),e.sub_revision_view_controller.parent_key="document_id",e.sub_revision_view_controller.parent_value=e.current_edit_record.id,e.sub_revision_view_controller.parent_edit_record=e.current_edit_record,e.sub_revision_view_controller.parent_view_controller=e,void e.sub_revision_view_controller.initData();Global.loadScript("views/document/DocumentRevisionViewController.js",(function(){var n=e.edit_view_tab.find("#tab_revision").find(".first-column-sub-view");Global.trackView("SubDocumentRevisionView"),TTPromise.wait("BaseViewController","initialize",(function(){DocumentRevisionViewController.loadSubView(n,t,i)}))}))}else TTPromise.resolve("BaseViewController","onTabShow");function t(){}function i(t){e.sub_revision_view_controller=t,e.sub_revision_view_controller.parent_key="document_id",e.sub_revision_view_controller.parent_value=e.current_edit_record.id,e.sub_revision_view_controller.parent_edit_record=e.current_edit_record,e.sub_revision_view_controller.parent_view_controller=e,e.sub_revision_view_controller.initData()}}searchDone(){TTPromise.resolve("initSubDocumentView","init"),super.searchDone()}}n.loadSubView=function(e,t,i){Global.loadViewSource("Document","SubDocumentView.html",(function(n){var a=_.template(n);Global.isSet(t)&&t(),Global.isSet(e)&&(e.html(a({})),Global.isSet(i)&&TTPromise.wait("BaseViewController","initialize",(function(){i(sub_document_view_controller)})))}))}}}]);
//# sourceMappingURL=document-DocumentViewController.bundle.js.map?v=10e55a78c6937b6435b3