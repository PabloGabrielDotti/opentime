(self.webpackChunktimetrex=self.webpackChunktimetrex||[]).push([["attendance-schedule-ScheduleViewController","switch_button-SwitchButton"],{6618:(e,t,i)=>{"use strict";i.r(t),i.d(t,{"SwitchButtonIcon":()=>a}),function(e){e.fn.SwitchButton=function(t){Global.addCss("global/widgets/switch_button/SwitchButton.css");var i=e.extend({},e.fn.SwitchButton.defaults,t),a=this,s=null,r=!0;return this.getEnabled=function(){return r},this.setEnable=function(e){r=e,e?this.removeClass("disable-element"):this.removeClass("disable-element").addClass("disable-element")},this.getValue=function(e){return e?s&&s.hasClass("selected")?1:0:!(!s||!s.hasClass("selected"))},this.setValue=function(e){s&&(s.removeClass("selected"),e&&s.addClass("selected"))},this.setIcon=function(e){s.addClass(e)},this.each((function(){var t=e.meta?e.extend({},i,e(this).data()):i;s=e("<div></div>"),a.append(s),t.tooltip&&s.attr("title",t.tooltip),a.setIcon(t.icon),s.click((function(e){if(!r)return e.stopImmediatePropagation(),void e.stopPropagation();a.setValue(!a.getValue())}))})),this},e.fn.SwitchButton.defaults={}}(jQuery);var a=function(){};a.daily_total="daily",a.weekly_total="weekly",a.all_employee="all-employee",a.strict_range="strict-range",a.wages="strict-range"},6620:(e,t,i)=>{"use strict";i.r(t),i.d(t,{"ScheduleViewController":()=>s});var a=i(6618);class s extends BaseViewController{constructor(e={}){_.defaults(e,{el:"#schedule_view_container",user_group_api:null,status_array:null,user_group_array:null,toggle_button:null,start_date_picker:null,start_date:null,end_date:null,full_schedule_data:null,schedule_columns:null,full_format:"ddd-MMM-DD-YYYY",weekly_format:"ddd, MMM DD",final_schedule_data_array:[],has_date_array:[],no_date_array:[],shift_key_name_array:[],select_cells_Array:[],select_all_shifts_array:[],select_shifts_array:[],select_recurring_shifts_array:[],all_employee_btn:null,daily_totals_btn:null,weekly_totals_btn:null,strict_range_btn:null,month_date_row_array:null,month_date_row_tr_ids:null,month_date_row_position:null,month_current_header_number:0,day_header_width:0,day_hour_width:40,select_drag_menu_id:"",is_override:!1,scroll_position:0,selected_user_ids:[],prev_total_time:0,prev_status_id:null,is_mass_adding:!1,calculate_cell_number:0,scroll_interval:null,scroll_unit:0,holiday_data_dic:{},absence_policy_api:null,year_mode_original_date:null,events:{}}),super(e)}init(e){this.permission_id="schedule",this.script_name="ScheduleView",this.viewId="Schedule",this.table_name_key="schedule",this.context_menu_name=$.i18n._("Schedules"),this.navigation_label=$.i18n._("Schedule")+":",this.api=TTAPI.APISchedule,this.user_group_api=TTAPI.APIUserGroup,this.absence_policy_api=TTAPI.APIAbsencePolicy,this.company_api=TTAPI.APICompany,this.user_api=TTAPI.APIUser,this.currency_api=TTAPI.APICurrency,Global.getProductEdition()>=20&&(this.job_api=TTAPI.APIJob,this.job_item_api=TTAPI.APIJobItem),this.api_absence_policy=TTAPI.APIAbsencePolicy,this.scroll_position=0,this.initPermission(),this.render(),this.buildContextMenu(),this.initData(),this.setSelectRibbonMenuIfNecessary()}jobUIValidate(e){return e||(e=this.permission_id),!!(PermissionManager.validate("job","enabled")&&PermissionManager.validate(e,"edit_job")&&Global.getProductEdition()>=20)}jobItemUIValidate(e){return e||(e=this.permission_id),!(!PermissionManager.validate("job_item","enabled")||!PermissionManager.validate(e,"edit_job_item"))}branchUIValidate(e){return e||(e=this.permission_id),!!PermissionManager.validate(e,"edit_branch")}departmentUIValidate(e){return e||(e=this.permission_id),!!PermissionManager.validate(e,"edit_department")}initPermission(){super.initPermission(),this.show_search_tab=!0,this.jobUIValidate()?this.show_job_ui=!0:this.show_job_ui=!1,this.jobItemUIValidate()?this.show_job_item_ui=!0:this.show_job_item_ui=!1,this.branchUIValidate()?this.show_branch_ui=!0:this.show_branch_ui=!1,this.departmentUIValidate()?this.show_department_ui=!0:this.show_department_ui=!1}initData(){var e=this;Global.removeViewTab(this.viewId),ProgressBar.showOverlay(),this.initOptions(),this.default_display_columns=[],PermissionManager.validate(this.permission_id,"edit_branch")&&this.default_display_columns.push("branch"),PermissionManager.validate(this.permission_id,"edit_department")&&this.default_display_columns.push("department"),Global.getProductEdition()>=20&&(PermissionManager.validate(this.permission_id,"edit_job")&&this.default_display_columns.push("job"),PermissionManager.validate(this.permission_id,"edit_job_item")&&this.default_display_columns.push("job_item"));var t=new Date;1==Global.UNIT_TEST_MODE&&(LocalCacheData.last_schedule_selected_date="15-Feb-18");var i=Global.getLoginUserDateFormat(),a=t.format(i);LocalCacheData.last_schedule_selected_date?this.setDatePickerValue(LocalCacheData.last_schedule_selected_date):LocalCacheData.current_select_date&&Global.strToDate(LocalCacheData.current_select_date,"YYYY-MM-DD")?(this.setDatePickerValue(Global.strToDate(LocalCacheData.current_select_date,"YYYY-MM-DD").format()),LocalCacheData.current_select_date=""):this.setDatePickerValue(a),this.setMoveOrDropMode(ContextMenuIconName.move),this.getAllColumns((function(){e.initLayout()}))}setToggleButtonValue(e){this.toggle_button&&(this.toggle_button.setValue(e),this.setToggleButtonUrl())}setToggleButtonUrl(){var e=this.getMode();this.start_date_picker.getDefaultFormatValue();this.edit_view||Global.setURLToBrowser(Global.getBaseURL()+"#!m="+this.viewId+"&mode="+e)}setDatePickerValue(e){this.start_date_picker.setValue(e),LocalCacheData.last_schedule_selected_date=e}getAllColumns(e){var t=this;this.api.getOptions("columns",{onResult:function(i){var a=i.getResult();t.all_columns=Global.buildColumnArray(a),t.api.getOptions("group_columns",{onResult:function(i){for(var s=Global.buildColumnArray(a),r=i.getResult(),l=[],d=s.length,o=r.length,_=0;_<o;_++)for(var n=r[_],c=0;c<d;c++){var h=s[c];if(h.value===n){l.push(h);break}}t.all_columns=l,t.column_selector.setUnselectedGridData(t.all_columns),e&&e()}})}})}initLayout(){var e=this;e.getAllLayouts((function(){e.setSelectLayout(),e.search(!0,!0)}))}initOptions(){var e=this;this.initDropDownOption("status","",this.api),this.user_group_api.getUserGroup("",!1,!1,{onResult:function(t){t=t.getResult(),t=Global.buildTreeRecord(t),e.user_group_array=t,e.basic_search_field_ui_dic.group_ids&&e.basic_search_field_ui_dic.group_ids.setSourceData(t),e.adv_search_field_ui_dic.group_ids&&e.adv_search_field_ui_dic.group_ids.setSourceData(t)}})}getSelectDate(){var e=this.start_date_picker.getValue();return"Invalid date"==e&&(e=new Date),e}getGridSelectIdArray(){for(var e=[],t=this.select_all_shifts_array.length,i=0;i<t;i++){var a=this.select_all_shifts_array[i];a.id&&a.id!=TTUUID.zero_id&&a.id!=TTUUID.not_exist_id&&e.push(a.id)}return e}getSelectedItem(){var e=null;return this.edit_view?e=this.current_edit_record:this.select_all_shifts_array.length>0&&(e=this.select_all_shifts_array[0]),e?Global.clone(e):null}_continueDoCopyAsNew(){var e=this;if(LocalCacheData.current_doing_context_action="copy_as_new",Global.isSet(this.edit_view)){this.current_edit_record.id="",this.edit_view.find(".navigation-div").css("display","none"),this.setCurrentEditRecordData(),this.setEditMenu(),this.setTabStatus(),this.is_changed=!1,ProgressBar.closeOverlay()}else{var t={},i=this.getGridSelectIdArray();if(!(i.length>0)){var a=Global.clone(e.select_all_shifts_array[0]);return a=e.resetSomeFields(a),e.current_edit_record=a,e.openEditView(),void e.initEditView()}var s=i[0];t.filter_data={},t.filter_data.id=[s],this.api["get"+this.api.key_name](t,{onResult:function(t){var i=t.getResult();if(!i||!0===i)return TAlertManager.showAlert($.i18n._("Record does not exist")),void e.onCancelClick();e.openEditView(),(i=i[0]).id="",e.sub_view_mode&&e.parent_key&&(i[e.parent_key]=e.parent_value),e.current_edit_record=i,e.initEditView()}})}}onViewClick(e,t){this.setCurrentEditViewState("view");var i=this.getViewSelectedRecordId(e);if(!Global.isFalseOrNull(i)){this.setCurrentSelectedRecord(i),this.openEditView();var a=this.getAPIFilters();return this.doViewAPICall(a)}TTPromise.add("Schedule","init"),this.openEditView();var s=Global.clone(this.select_all_shifts_array[0]);s=this.resetSomeFields(s),this.current_edit_record=s;var r=this;TTPromise.wait("Schedule","init",(function(){r.initEditView()}))}getCommonFields(){var e;return $.each(this.select_all_shifts_array,(function(t,i){if(!e)return e=Global.clone(i),!0;for(var a in i)e[a]!==i[a]&&delete e[a]})),e}onMassEditClick(){var e,t=this,i={};function a(e){t.api.getOptions("unique_columns",{onResult:function(i){t.unique_columns=i.getResult(),t.api.getOptions("linked_columns",{onResult:function(i){t.linked_columns=i.getResult(),t.sub_view_mode&&t.parent_key&&(e[t.parent_key]=t.parent_value),t.current_edit_record=e,t.is_mass_editing=!0,t.initEditView()}})}})}LocalCacheData.current_doing_context_action="mass_edit",this.mass_edit_record_ids=[],e=this.getGridSelectIdArray(),t.openEditView(),$.each(e,(function(e,i){t.mass_edit_record_ids.push(i)})),t.selected_user_ids=[],$.each(this.select_all_shifts_array,(function(e,i){var a=i;a.hasOwnProperty("user_id")&&t.selected_user_ids.push(a.user_id)})),i.filter_data={},i.filter_data.id=this.mass_edit_record_ids,this.mass_edit_record_ids.length===this.select_all_shifts_array.length?this.api["getCommon"+this.api.key_name+"Data"](i,{onResult:function(e){var t=e.getResult();t||(t=[]),a(t)}}):a(this.getCommonFields())}onEditClick(e,t){if(TTPromise.add("Schedule","init"),this.setCurrentEditViewState("edit"),this.openEditView(),e=this.getEditSelectedRecordId(e),!Global.isFalseOrNull(e)){this.setCurrentSelectedRecord(e);var i=this.getAPIFilters();return this.doEditAPICall(i)}this.openEditView();var a=Global.clone(this.select_all_shifts_array[0]);a=this.resetSomeFields(a),this.current_edit_record=a,this.current_edit_record.user_ids=[this.current_edit_record.user_id],this.is_viewing=!1;var s=this;TTPromise.wait("Schedule","init",(function(){s.initEditView()}))}doDeleteAPICall(e,t){if(t||(t={onResult:function(e){ProgressBar.closeOverlay(),i.call(this,e),e.isValid()?(this.onDeleteDone(e),this.edit_view&&this.removeEditView()):TAlertManager.showErrorAlert(e)}.bind(this)}),e&&e.length>0)return this.api["delete"+this.api.key_name](e,t);function i(e){for(var t=[],i=0;i<this.select_cells_Array.length;i++)this.select_cells_Array[i].shift&&(this.select_cells_Array[i].shift.status_id="20",t.push(this.select_cells_Array[i].shift));t.length>0?this.api.setSchedule(t,{onResult:function(){this.search()}.bind(this)}):e.isValid()&&this.search()}i.call(this,{isValid:function(){return!1}})}getCustomContextMenuModel(){var e={groups:{drag_and_drop:{label:$.i18n._("Drag & Drop"),id:this.viewId+"drag_and_drop"}},exclude:[ContextMenuIconName.export_excel,ContextMenuIconName.save_and_next,ContextMenuIconName.delete_and_next,ContextMenuIconName.copy],include:[{label:$.i18n._("Move"),id:ContextMenuIconName.move,group:"drag_and_drop",icon:Icons.move,permission_result:!0},{label:$.i18n._("Copy"),id:ContextMenuIconName.drag_copy,group:"drag_and_drop",icon:Icons.copy,permission_result:!0},{label:$.i18n._("Swap"),id:ContextMenuIconName.swap,group:"drag_and_drop",icon:Icons.swap,permission_result:!0},{label:$.i18n._("Overwrite"),id:ContextMenuIconName.override,group:"drag_and_drop",icon:Icons.override,permission_result:!0},{label:$.i18n._("Edit<br>Employee"),id:ContextMenuIconName.edit_employee,group:"navigation",icon:Icons.employee,permission_result:!0},{label:$.i18n._("TimeSheet"),id:ContextMenuIconName.timesheet,group:"navigation",icon:Icons.timesheet,permission_result:!0},{label:$.i18n._("Find<br>Available"),id:ContextMenuIconName.find_available,group:"other",icon:Icons.find_available,permission_result:!0},{label:$.i18n._("Import"),id:ContextMenuIconName.import_icon,group:"other",icon:Icons.import_icon,permission_result:PermissionManager.checkTopLevelPermission("ImportCSVSchedule"),sort_order:8e3}]};PermissionManager.validate("punch","add")&&(PermissionManager.validate("punch","edit")||PermissionManager.validate("punch","edit_child"))&&e.include.push({label:$.i18n._("Auto<br>Punch"),id:"AutoPunch",group:"other",icon:Icons.in_out,permission_result:!0,permission:!0}),PermissionManager.validate("request","add")&&e.include.push({label:$.i18n._("Add<br>Request"),id:"AddRequest",group:"other",icon:Icons.request,permission_result:!0,permission:!0});var t={label:$.i18n._("Print"),id:ContextMenuIconName.print,group:"other",icon:Icons.print,type:RibbonSubMenuType.NAVIGATION,items:[{label:$.i18n._("Individual Schedules"),id:"pdf_schedule"}],permission_result:!0,permission:!0};return(PermissionManager.validate("schedule","view")||PermissionManager.validate("schedule","view_child"))&&t.items.push({label:$.i18n._("Group - Combined"),id:"pdf_schedule_group_combined"},{label:$.i18n._("Group - Separated"),id:"pdf_schedule_group"},{label:$.i18n._("Group - Separated (Page Breaks)"),id:"pdf_schedule_group_pagebreak"}),e.include.push(t),e}onReportMenuClick(e){this.onNavigationClick(e)}onCustomContextClick(e){switch(e){case ContextMenuIconName.move:case ContextMenuIconName.drag_copy:case ContextMenuIconName.swap:this.setMoveOrDropMode(e);break;case ContextMenuIconName.override:this.onOverrideClick();break;case ContextMenuIconName.edit_employee:case ContextMenuIconName.timesheet:this.onNavigationClick(e);break;case ContextMenuIconName.find_available:this.onFindAvailableClick(e);break;case"AutoPunch":this.addPunchesFromScheduledShifts(e);break;case"AddRequest":this.addRequestFromScheduledShifts(e);break;case ContextMenuIconName.import_icon:this.onImportClick()}}addRequestFromScheduledShifts(e){if(Global.getProductEdition()<=10)return TAlertManager.showAlert(Global.getUpgradeMessage()),!1;if(t&&t.length<=0)return!1;var t=this.select_cells_Array,i=t[0]?t[0]:null,a=t[t.length-1]?t[t.length-1]:null;if(!i||!a)return!1;var s=this.api.getScheduleDefaultData(this.select_cells_Array,{async:!1}).getResult(),r=10,l=40,d=!1,o=!1,_=!1,n=!1,c=!1,h=!1,u=!1;for(var m in t){null==i.shift&&t[m].shift&&(i=t[m]);var p=new Date(t[m].time_stamp_num);switch(p.getDay()){case 0:u=!0;break;case 1:d=!0;break;case 2:o=!0;break;case 3:_=!0;break;case 4:n=!0;break;case 5:c=!0;break;case 6:h=!0}p=null}if(s.mon=d,s.tue=o,s.wed=_,s.thu=n,s.fri=c,s.sat=h,s.sun=u,i&&i.date)var b=i.date;if(a&&a.date)var g=a.date;i&&i.shift&&10==i.shift.status_id&&i.shift.user_id&&i.shift.user_id!=TTUUID.zero_id&&(r=20,l=30),s.status_id=r,s.type_id=l,s.user_id=LocalCacheData.getLoginUser().id,s.full_name=LocalCacheData.getLoginUser().full_name,b&&(s.date_stamp=b,s.start_date=b),g&&(s.end_date=g),i.start_time&&(s.start_time=i.start_time),i.end_time&&(s.end_time=i.end_time),i.branch_id&&(s.branch_id=i.branch_id),i.department_id&&(s.department_id=i.department_id),i.job_id&&(s.job_id=i.job_id),i.job_item_id&&(s.job_item_id=i.job_item_id),IndexViewController.openEditView(this,"Request",s,"openAddView")}addPunchesFromScheduledShifts(e){if(Global.getProductEdition()<=10)return TAlertManager.showAlert(Global.getUpgradeMessage()),!1;if(null==this.select_cells_Array||this.select_cells_Array.length<1)return TAlertManager.showAlert("No schedules selected. You can't autopunch no schedules."),!1;var t=this.select_cells_Array,i={},a=[];i.schedule=[],i.recurring=[];for(var s=0;s<t.length;s++)null!=t[s].shift&&(t[s].shift.id&&t[s].shift.id!=TTUUID.zero_id&&t[s].shift.id!=TTUUID.not_exist_id?i.schedule.push(t[s].shift.id):t[s].shift.recurring_schedule_id&&t[s].shift.recurring_schedule_id!=TTUUID.not_exist_id&&i.recurring.push(t[s].shift.recurring_schedule_id),a.push(t[s].shift.user_id));this.api.addPunchesFromScheduledShifts(i,{onResult:function(e){e.isValid()?UserGenericStatusWindowController.open(e.getAttributeInAPIDetails("user_generic_status_batch_id"),[LocalCacheData.getLoginUser().id]):TAlertManager.showErrorAlert(e)}})}getSelectEmployee(){var e=this.select_cells_Array[0];return e&&e.user_id!=TTUUID.zero_id?e.user_id&&e.user_id!=TTUUID.zero_id&&(e={user_id:e.user_id}):e={user_id:LocalCacheData.getLoginUser().id},this.edit_view&&this.current_edit_record&&(e.user_id=this.current_edit_record.user_id),e.user_id}onFindAvailableClick(){if(Global.getProductEdition()<=10)TAlertManager.showAlert(Global.getUpgradeMessage());else{for(var e=this,t={selected:[]},i=this.select_all_shifts_array.length,a=0;a<i;a++){var s=this.select_all_shifts_array[a];t.selected.push(s)}LocalCacheData.extra_filter_for_next_open_view={},LocalCacheData.extra_filter_for_next_open_view.filter_data=t,IndexViewController.openWizard("FindAvailableWizard",null,(function(i){e.onFindAvailableClose(i,t.selected)}))}}onFindAvailableClose(e,t){for(var i=this,a=t.length,s=0;s<a;s++){var r=t[s];r.user_id=e,r.replaced_id=r.id,delete r.id}this.api.setSchedule(t,{onResult:function(e){e.isValid()||TAlertManager.showErrorAlert(e),i.search()}})}onImportClick(){var e=this;IndexViewController.openWizard("ImportCSVWizard","Schedule",(function(){e.search()}))}onNavigationClick(e){var t;if(this.checkScheduleData())switch(e){case ContextMenuIconName.edit_employee:IndexViewController.openEditView(this,"Employee",this.getSelectEmployee());break;case ContextMenuIconName.timesheet:var i={filter_data:{}};i.user_id=this.getSelectEmployee(),this.edit_view?i.base_date=this.current_edit_record.date_stamp:i.base_date=this.start_date_picker.getValue(),Global.addViewTab(this.viewId,$.i18n._("Schedules"),window.location.href),IndexViewController.goToView("TimeSheet",i);break;case"pdf_schedule":case"pdf_schedule_group_combined":case"pdf_schedule_group":case"pdf_schedule_group_pagebreak":if((i=Global.convertLayoutFilterToAPIFilter(this.select_layout))||(i={}),i.time_period={},i.time_period.time_period="custom_date",i.time_period.start_date=this.full_schedule_data.schedule_dates.start_display_date,i.time_period.end_date=this.full_schedule_data.schedule_dates.end_display_date,i.time_period.start_date==i.time_period.end_date){var a=new Date(new Date(this.start_date.getTime()).setDate(this.start_date.getDate()+6));i.time_period.end_date=a.format()}t={0:i,1:e},this.doFormIFrameCall(t)}}doFormIFrameCall(e){Global.APIFileDownload("APIScheduleSummaryReport","getScheduleSummaryReport",e)}setScheduleGridDragAble(){switch(this.getMode()){case l.DAY:case l.WEEK:case l.MONTH:case l.YEAR:this.setWeekModeDragAble()}var e=this;$(".schedule-grid-div").off("dragover").on("dragover",(function(t){var i=$(".schedule-grid-div"),a=i.offset().top,s=t.originalEvent.clientY,r=i.height();s>a+r?(e.scroll_unit=s-(a+r),e.scroll_interval||(e.scroll_interval=setInterval((function(){var t=e.grid.grid.parent().parent();t.scrollTop(t.scrollTop()+e.scroll_unit)}),50))):s<a+15&&s>a-50?(e.scroll_unit=a+15-s,e.scroll_interval||(e.scroll_interval=setInterval((function(){var t=e.grid.grid.parent().parent();t.scrollTop(t.scrollTop()-e.scroll_unit)}),50))):(clearInterval(e.scroll_interval),e.scroll_interval=null)})),$(".schedule-grid-div").off("dragend").on("dragend",(function(t){e.scroll_interval&&(clearInterval(e.scroll_interval),e.scroll_interval=null)})),$(".schedule-grid-div td").unbind("dragenter").bind("dragenter",(function(e){e.preventDefault(),$(".schedule-drag-over").removeClass("schedule-drag-over"),($(this).attr("draggable")||$(this).parents("td").attr("draggable"))&&$(this).addClass("schedule-drag-over"),console.log("enter")}))}setWeekModeDragAble(){var e=this,t=this.grid.grid.find(".date-column").parents("td");t.attr("draggable",!0),t.unbind("dragstart").bind("dragstart",(function(t){var i=t.target;if(e.select_all_shifts_array.length<1||!$(i).hasClass("ui-state-highlight")||!e.select_drag_menu_id)return!1;for(var a=$("<div class='drag-holder-div'></div>"),s=e.select_all_shifts_array.length,r=0;r<s;r++){var l=e.select_all_shifts_array[r],d=$("<span class='drag-span'></span>");20==l.status_id?d.text(e.getAbsenceCellValue(l)):d.text(l.start_time+" - "+l.end_time),a.append(d)}return $("body").find(".drag-holder-div").remove(),$("body").append(a),t.originalEvent.dataTransfer.setData("Text","schedule"),t.originalEvent.dataTransfer.setDragImage&&t.originalEvent.dataTransfer.setDragImage(a[0],0,0),!0})),t.unbind("drop").bind("drop",(function(t){t.preventDefault(),t.stopPropagation&&t.stopPropagation(),$(".drag-holder-div").remove();var i=!1,a=!1,s=[],d=[],o=[],_=t.currentTarget,n=e.select_cellls_and_shifts_array;if(n){var c,h;c=_.parentNode.rowIndex-1,h=_.cellIndex;var u,m,p=0,b=0,g=e.grid.grid.getGridParam("colModel");a=e.select_drag_menu_id===ContextMenuIconName.move;for(var f=n.length,v=0;v<f;v++){var y,w=n[v];if(0===v?(u=w.row_id,m=w.cell_index):(i||(p=w.row_id-u),b=w.cell_index-m),w.shift){if((y=w.shift).branch_id=y.branch?y.branch_id:"",y.department_id=y.department?y.department_id:"",y.job_id=y.job_id?y.job_id:"",y.job_item_id=y.job_item_id?y.job_item_id:"",x=c+p,!((M=h+b)>g.length-1)&&(k=e.getDataByCellIndex(x,M),(E=e.schedule_source[x])&&E.user_id||(i=!0),E)){if(E.type===r.DATE)break;if(!k||i){var T;if(g)if(e.getMode()===l.MONTH){var C=e.getCellRelatedDate(x,g,M,g[M].name);C&&(T=C.format())}else T=Global.strToDate(g[M].name,e.full_format).format();if(!T||"Invalid date"==T)continue;k={},E.user_id?(k.user_id=E.user_id,k.branch=E.branch,k.branch_id=E.branch?E.branch_id:"",k.schedule_policy_id=E.schedule_policy_id,k.department_id=E.department?E.department_id:"",k.department=E.department,k.job_id=E.job_id?E.job_id:"",k.job=E.job,k.job_item_id=E.job_item_id?E.job_item_id:"",k.job_item=E.job_item,k.date_stamp=T,k.start_date_stamp=T):((k=y).date_stamp=T,k.start_date_stamp=T)}var D=Global.clone(y);if(e.select_drag_menu_id!==ContextMenuIconName.swap)D.id="",D.date_stamp=k.date_stamp,D.start_date_stamp=k.start_date_stamp,D.user_id=k.user_id,D.branch_id=k.branch?k.branch_id:TTUUID.not_exist_id,D.department_id=k.department?k.department_id:TTUUID.not_exist_id,D.job_id=k.job_id?k.job_id:TTUUID.not_exist_id,D.job_item_id=k.job_item_id?k.job_item_id:TTUUID.not_exist_id,e.is_override&&(D.overwrite=!0),s.push(D),y.id&&y.id!=TTUUID.zero_id?d.push(y.id):y.user_id!=TTUUID.zero_id&&y.user_id!=TTUUID.not_exist_id?(y.status_id="20",o.push(y)):y.user_id==TTUUID.zero_id&&(a=!1);else{var I=Global.clone(D),A=Global.clone(k);if(!A.start_date)continue;for(var S in k)"id"!==S&&"user_id"!==S&&"date_stamp"!==S&&"start_date_stamp"!==S&&"branch_id"!==S&&"department_id"!==S&&"job_id"!==S&&"job_item_id"!==S&&"branch"!==S&&"department"!==S&&"job"!==S&&"job_item"!==S&&"schedule_policy_id"!==S&&(k[S]=I[S],D[S]=A[S]);k.branch_id=k.branch?k.branch_id:TTUUID.not_exist_id,k.department_id=k.department?k.department_id:TTUUID.not_exist_id,k.job_id=k.job_id?k.job_id:TTUUID.not_exist_id,k.job_item_id=k.job_item_id?k.job_item_id:TTUUID.not_exist_id,s.push(k),s.push(D)}}}else{var x=c+p,M=h+b;if(M>g.length-1)continue;var k=e.getDataByCellIndex(x,M),E=e.schedule_source[x];E&&E.user_id||(i=!0)}}s.length>0&&e.api.setSchedule(s,{onResult:function(t){t.isValid()?a?d.length>0?e.api.deleteSchedule(d,{onResult:function(){o.length>0?e.api.setSchedule(o,{onResult:function(){e.search()}}):e.search()}}):o.length>0?e.api.setSchedule(o,{onResult:function(){e.search()}}):e.search():e.search():TAlertManager.showErrorAlert(t)}})}})),t.unbind("dragenter").bind("dragenter",(function(e){e.preventDefault()})),t.unbind("dragover").bind("dragover",(function(e){e.preventDefault()})),t.unbind("dragend").bind("dragend",(function(e){$(".drag-holder-div").remove(),$(".schedule-drag-over").removeClass("schedule-drag-over")}))}resetSomeFields(e){return e.branch_id=e.branch?e.branch_id:"",e.department_id=e.department?e.department_id:"",e.job_id=e.job?e.job_id:"",e.job_item_id=e.job_item?e.job_item_id:"",e}_createParametersForAdd(){var e,t=[];if(this.select_cells_Array.length>0)for(var i=0,a=this.select_cells_Array.length;i<a;i++){var s=this.select_cells_Array[i];(e={}).user_id=s.user_id,e.branch_id=s.branch_id,e.department_id=s.department_id,e.job_id=s.job_id,e.job_item_id=s.job_item_id,e.date=s.date,t.push(e)}if(t.length<1){var r=LocalCacheData.getLoginUser();(e={}).user_id=r.id,e.branch_id=r.branch_id,e.department_id=r.department_id,e.job_id=r.job_id,e.job_item_id=r.job_item_id,e.date=this.getSelectDate(),t.push(e)}return t}onAddClick(e){var t,i=this;this.setCurrentEditViewState("new"),this.select_cells_Array.length>1&&(this.is_mass_adding=!0),i.openEditView(),t=e?[{user_id:this.current_edit_record.user_id,branch_id:this.current_edit_record.branch_id,department_id:this.current_edit_record.department_id,job_id:this.current_edit_record.job_id,job_item_id:this.current_edit_record.job_item_id,date:this.current_edit_record.date_stamp}]:this._createParametersForAdd(),this.api["get"+this.api.key_name+"DefaultData"](t,{onResult:function(a){var s,r=a.getResult();if(s=r,i.select_cells_Array.length>=1)for(var l=0,d=t.length;l<d;l++){var o=t[l];0==l?(s.branch_id=o.branch_id,s.department_id=o.department_id,s.job_id=o.job_id,s.job_item_id=o.job_item_id):(s.branch_id!==o.branch_id&&"-2"!==s.branch_id?s.branch_id="-2":o.branch_id,s.department_id!==o.department_id&&"-2"!==s.department_id?s.department_id="-2":o.department_id,s.job_id!==o.job_id&&"-2"!==s.job_id?s.job_id="-2":o.job_id,s.job_item_id!==o.job_item_id&&"-2"!==s.job_item_id?s.job_item_id="-2":o.job_item_id)}if(e){var _=Global.strToDate(i.current_edit_record.date_stamp);s.date_stamp=new Date(new Date(_.getTime()).setDate(_.getDate()+1)).format()}else s.date_stamp=i.getSelectDate();s.start_date_stamp||(s.start_date_stamp=s.date_stamp),s.id="",i.sub_view_mode&&i.parent_key&&(r[i.parent_key]=i.parent_value),i.current_edit_record=s,i.initEditView()}})}openEditView(){this.edit_view||this.initEditViewUI("Schedule","ScheduleEditView.html"),this.previous_absence_policy_id=!1}setEditViewWidgetsMode(){var e={};for(var t in this.edit_view_ui_dic)if(this.edit_view_ui_dic.hasOwnProperty(t)){var i=this.edit_view_ui_dic[t];i.css("opacity",1);var a=i.parent().parent().parent(),s=a.parent().attr("id");a.hasClass("v-box")||e[s]||(e[s]=!0),this.is_viewing?Global.isSet(i.setEnabled)&&i.setEnabled(!1):Global.isSet(i.setEnabled)&&i.setEnabled(!0)}}setJobValueWhenUserChanged(e,t,i){var a=this;if(a.current_edit_record){this.edit_view_ui_dic.user_ids&&this.edit_view_ui_dic.user_ids.is(":visible")?(i.user_id=this.edit_view_ui_dic.user_ids.getValue(),1==i.user_id.length?i.user_id=i.user_id[0]:i.user_id=!1):i.user_id=this.current_edit_record.user_id;var s=a.edit_view_ui_dic[t];s.getValue();s.setSourceData(null),s.setCheckBox(!0),this.edit_view_ui_dic.job_item_quick_search.setCheckBox(!0);var r={};r.filter_data=i,a.edit_view_ui_dic[t].setDefaultArgs(r)}}onFormItemChange(e,t){var i=this;this.setIsChanged(e),this.setMassEditingFieldsWhenFormChange(e);var a=e.getField(),s=e.getValue();switch(this.current_edit_record[a]=s,a){case"job_id":Global.getProductEdition()>=20&&(this.edit_view_ui_dic.job_quick_search.setValue(e.getValue(!0)&&e.getValue(!0).manual_id?e.getValue(!0).manual_id:""),this.setJobItemValueWhenJobChanged(e.getValue(!0),"job_item_id",{status_id:10,job_id:this.current_edit_record.job_id}),this.edit_view_ui_dic.job_quick_search.setCheckBox(!0));break;case"job_item_id":Global.getProductEdition()>=20&&(this.edit_view_ui_dic.job_item_quick_search.setValue(e.getValue(!0)&&e.getValue(!0).manual_id?e.getValue(!0).manual_id:""),this.edit_view_ui_dic.job_item_quick_search.setCheckBox(!0));break;case"job_quick_search":case"job_item_quick_search":Global.getProductEdition()>=20&&this.onJobQuickSearch(a,s);break;case"status_id":this.onTypeChange(!0);break;case"user_id":case"user_ids":return this.setEditMenu(),this.setAbsencePolicyWhenUserChanged(),void(Global.getProductEdition()>=20&&this.edit_view_ui_dic.job_id&&this.setJobValueWhenUserChanged(this.edit_view_ui_dic.job_id.getValue(!0),"job_id",{status_id:10,user_id:this.edit_view_ui_dic[a].getValue()}));case"start_date_stamps":this.setEditMenu(),this.current_edit_record.start_date_stamp=s}if("absence_policy_id"==a&&(this.previous_absence_policy_id=this.current_edit_record.absence_policy_id),"date_stamp"===a||"start_date_stamps"===a||"start_date_stamp"===a||"start_time"===a||"end_time"===a||"schedule_policy_id"===a||"absence_policy_id"===a)if(""!==this.current_edit_record.date_stamp&&""!==this.current_edit_record.start_time&&""!==this.current_edit_record.end_time){var r=this.current_edit_record.date_stamp+" "+this.current_edit_record.start_time,l=this.current_edit_record.date_stamp+" "+this.current_edit_record.end_time,d=this.current_edit_record.schedule_policy_id,o=this.current_edit_record.user_id;this.api.getScheduleTotalTime(r,l,d,o,{onResult:function(e){i.edit_view&&i.current_edit_record&&i.edit_view_ui_dic.total_time&&(e=e?e.getResult():i.current_edit_record.total_time?i.current_edit_record.total_time:0,i.current_edit_record.total_time=e,e=Global.getTimeUnit(e),i.edit_view_ui_dic.total_time.setValue(e),i.onAvailableBalanceChange())}})}else this.onAvailableBalanceChange();t||this.validate()}setAbsencePolicyWhenUserChanged(){var e=this,t=e.edit_view_ui_dic.absence_policy_id;t.setSourceData(null);var i=t.getValue(),a={};a.filter_data={id:i},a=this.setAbsencePolicyFilter(a),i?e.absence_policy_api.getAbsencePolicy(a,{onResult:function(a){null!==e.current_edit_record&&void 0!==e.current_edit_record&&(a.getResult().length>0?(t.setValue(i),e.current_edit_record.absence_policy_id=i):(t.setValue(!1),e.current_edit_record.absence_policy_id=!1),e.onAvailableBalanceChange(),e.validate())}}):(this.onAvailableBalanceChange(),this.validate())}validate(){var e=this,t={};if(this.is_mass_adding)t=[],$.each(this.select_cells_Array,(function(i,a){if(a.hasOwnProperty("user_id")&&a.hasOwnProperty("date")&&a.date){var s=Global.clone(e.current_edit_record);delete s.user_ids,delete s.start_dates,s.id="",s.user_id=a.user_id,s.start_date_stamp=a.date,s=e.buildMassAddRecord(s),t.push(s)}}));else if(this.is_mass_editing){for(var i in this.edit_view_ui_dic)if(this.edit_view_ui_dic.hasOwnProperty(i)){var a=this.edit_view_ui_dic[i];Global.isSet(a.isChecked)&&a.isChecked()&&a.getEnabled()&&(t[i]=a.getValue())}if(this.mass_edit_record_ids.length>0){var s=t;t=[],$.each(this.mass_edit_record_ids,(function(i,a){var r=Global.clone(s);r.id=a,r=e.processAddRecord(r),t.push(r)})),$.each(this.select_all_shifts_array,(function(i,a){if(!a.id||a.id==TTUUID.zero_id){var r=Global.clone(a);for(var l in s)r[l]=s[l];r=e.processAddRecord(r),t.push(r)}})),t=this.getRecordsFromUserIDs(t)}else{var r=[];$.each(this.select_all_shifts_array,(function(i,a){if(!a.id||a.id==TTUUID.zero_id){var s=Global.clone(a);for(var l in t)s[l]=t[l];s=e.processAddRecord(s),r.push(s)}})),r.length<1?this.select_cells_Array.length>0&&(e.processAddRecord(t),t=this.getRecordsFromUserIDs([t])):(t=r,t=this.getRecordsFromUserIDs(t))}}else if(this.current_edit_record&&this.current_edit_record.start_date_stamp&&(this.current_edit_record.start_date_stamp.indexOf(" - ")>0||"array"===$.type(this.current_edit_record.start_date_stamp))){this.current_edit_record.start_date_stamp.indexOf(" - ")>0&&(this.current_edit_record.start_date_stamp=this.parserDatesRange(this.current_edit_record.start_date_stamp)),t=[];for(var l=0;l<this.current_edit_record.start_date_stamp.length;l++){var d=Global.clone(e.current_edit_record);d.start_date_stamp=this.current_edit_record.start_date_stamp[l],this.select_cells_Array.length>0&&e.processAddRecord(d),t.push(d)}t=this.getRecordsFromUserIDs(t)}else t=Global.clone(this.current_edit_record),this.select_cells_Array.length>0&&e.processAddRecord(t),t=this.getRecordsFromUserIDs([t]);this.api["validate"+this.api.key_name](t,{onResult:function(t){e.validateResult(t)}})}getRecordsFromUserIDs(e){for(var t=[],i=0;i<e.length;i++){var a=e[i];if(a.user_ids&&a.user_ids.length>0)for(var s=0;s<a.user_ids.length;s++){var r=a.user_ids[s];Global.isObject(r)&&r.id&&(r=r.id);var l=Global.clone(a);l.user_id=r,t.push(l)}else this.current_edit_record&&this.current_edit_record.id&&this.current_edit_record.id!=TTUUID.zero_id||this.is_mass_editing||(a.user_id=TTUUID.zero_id),t.push(a)}return t}onSaveAndCopy(e){var t=this;Global.isSet(e)||(e=!1),this.is_add=!0,this.is_changed=!1,LocalCacheData.current_doing_context_action="save_and_copy";var i=this.current_edit_record;if(i=this.processAddRecord(i),i=this.getRecordsFromUserIDs([i]),this.current_edit_record.start_date_stamp.indexOf(" - ")>0||"array"===$.type(this.current_edit_record.start_date_stamp)){this.current_edit_record.start_date_stamp.indexOf(" - ")>0&&(this.current_edit_record.start_date_stamp=this.parserDatesRange(this.current_edit_record.start_date_stamp)),i=[];for(var a=0;a<this.current_edit_record.start_date_stamp.length;a++){var s=Global.clone(t.current_edit_record);s.start_date_stamp=this.current_edit_record.start_date_stamp[a],s=this.processAddRecord(s),i.push(s)}i=this.getRecordsFromUserIDs(i)}this.clearNavigationData(),this.api["set"+this.api.key_name](i,!1,!1,e,{onResult:function(e){if(t.current_edit_record){var i=t.current_edit_record.start_date_stamp;"array"===$.type(i)&&(i=i[i.length-1]);var a=Global.strToDate(i),s=new Date(new Date(a.getTime()).setDate(a.getDate()+1));t.current_edit_record.start_date_stamp=s.format(),t.onSaveAndCopyResult(e)}}})}onSaveAndNewClick(e){var t=this;Global.isSet(e)||(e=!1),this.setCurrentEditViewState("new");var i=this.current_edit_record;if(i=this.processAddRecord(i),i=this.getRecordsFromUserIDs([i]),this.current_edit_record.start_date_stamp.indexOf(" - ")>0||"array"===$.type(this.current_edit_record.start_date_stamp)){this.current_edit_record.start_date_stamp.indexOf(" - ")>0&&(this.current_edit_record.start_date_stamp=this.parserDatesRange(this.current_edit_record.start_date_stamp)),i=[];for(var a=0;a<this.current_edit_record.start_date_stamp.length;a++){var s=Global.clone(t.current_edit_record);s.start_date_stamp=this.current_edit_record.start_date_stamp[a],s=this.processAddRecord(s),i.push(s)}i=this.getRecordsFromUserIDs(i)}this.api["set"+this.api.key_name](i,!1,e,{onResult:function(e){t.onSaveAndNewResult(e)}})}buildSelectedCellsRecord(){var e=this,t=[];return $.each(this.select_cells_Array,(function(i,a){if(a.hasOwnProperty("user_id")&&a.hasOwnProperty("date")&&a.date){var s=Global.clone(e.current_edit_record);delete s.user_ids,delete s.start_dates,s.id="",s.user_id=a.user_id,s.start_date_stamp=a.date,s=e.buildMassAddRecord(s),t.push(s)}})),t}buildMassAddRecord(e){for(var t=this._createParametersForAdd(),i=0,a=t.length;i<a;i++){var s=t[i];e.user_id===s.user_id&&("-2"==e.branch_id?e.branch_id=s.branch_id:e.branch_id,"-2"==e.department_id?e.department_id=s.department_id:e.department_id,"-2"==e.job_id?e.job_id=s.job_id:e.job_id,"-2"==e.job_item_id?e.job_item_id=s.job_item_id:e.job_item_id)}return e}processAddRecord(e){for(var t=this._createParametersForAdd(),i=0,a=t.length;i<a;i++){var s=t[i];"-2"==e.branch_id?e.branch_id=s.branch_id:e.branch_id,"-2"==e.department_id?e.department_id=s.department_id:e.department_id,"-2"==e.job_id?e.job_id=s.job_id:e.job_id,"-2"==e.job_item_id?e.job_item_id=s.job_item_id:e.job_item_id;break}return e}getSelectedId(e,t,i){for(var a=0,s=i.length;a<s;a++){var r=i[a];e.user_id===r.user_id&&(e[t]=r[t])}}onSaveAndContinue(e){var t=this;Global.isSet(e)||(e=!1),this.is_changed=!1,this.is_add=!1,LocalCacheData.current_doing_context_action="save_and_continue";var i=this.current_edit_record;if(i=this.processAddRecord(i),i=this.uniformVariable(i),this.current_edit_record.start_date_stamp&&(this.current_edit_record.start_date_stamp.indexOf(" - ")>0||"array"===$.type(this.current_edit_record.start_date_stamp))){this.current_edit_record.start_date_stamp.indexOf(" - ")>0&&(this.current_edit_record.start_date_stamp=this.parserDatesRange(this.current_edit_record.start_date_stamp)),i=[];for(var a=0;a<this.current_edit_record.start_date_stamp.length;a++){var s=Global.clone(t.current_edit_record);s.start_date_stamp=this.current_edit_record.start_date_stamp[a],s=this.processAddRecord(s),i.push(s)}i=this.getRecordsFromUserIDs(i)}else i=this.getRecordsFromUserIDs([i]);this.api["set"+this.api.key_name](i,!1,e,{onResult:function(e){t.previous_absence_policy_id=!1,t.onSaveAndContinueResult(e)}})}onSaveClick(e){var t,i=this;if(Global.isSet(e)||(e=!1),LocalCacheData.current_doing_context_action="save",this.is_mass_adding)t=this.buildSelectedCellsRecord();else if(this.is_mass_editing){var a=this.getChangedFields();t=[],$.each(this.mass_edit_record_ids,(function(e,s){var r=Global.clone(a);r.id=s,r=i.processAddRecord(r),t.push(r)})),$.each(this.select_all_shifts_array,(function(e,s){if(!s.id||s.id==TTUUID.zero_id){var r=Global.clone(s);for(var l in a)r[l]=a[l];r=i.processAddRecord(r),t.push(r)}}))}else if(this.current_edit_record.start_date_stamp.indexOf(" - ")>0||"array"===$.type(this.current_edit_record.start_date_stamp)){this.current_edit_record.start_date_stamp.indexOf(" - ")>0&&(this.current_edit_record.start_date_stamp=this.parserDatesRange(this.current_edit_record.start_date_stamp)),t=[];for(var s=0;s<this.current_edit_record.start_date_stamp.length;s++){var r=Global.clone(i.current_edit_record);r.start_date_stamp=this.current_edit_record.start_date_stamp[s],r=i.processAddRecord(r),t.push(r)}t=this.getRecordsFromUserIDs(t)}else t=this.current_edit_record,t=i.processAddRecord(t),t=this.getRecordsFromUserIDs([t]);this.api["set"+this.api.key_name](t,!1,e,{onResult:function(e){if(e.isValid()){var t=e.getResult();!0===t&&i.current_edit_record?i.refresh_id=i.current_edit_record.id:TTUUID.isUUID(t)&&t!=TTUUID.zero_id&&t!=TTUUID.not_exist_id&&(i.refresh_id=t),i.search(),i.previous_absence_policy_id=!1,i.removeEditView()}else i.setErrorTips(e),i.setErrorMenu()}})}removeEditView(){super.removeEditView(),this.selected_user_ids=[],this.is_mass_adding=!1}setEditMenuSaveAndContinueIcon(e,t){this.saveAndContinueValidate(e),(this.is_mass_editing||this.is_viewing||this.is_mass_adding||this.isMassEmployeeOrDate())&&e.addClass("disable-image")}isMassEmployeeOrDate(){return!!(this.current_edit_record&&this.current_edit_record.start_date_stamps&&(this.current_edit_record.start_date_stamps.indexOf(" - ")>0||"array"===$.type(this.current_edit_record.start_date_stamps)&&this.current_edit_record.start_date_stamps.length>1))||!!(this.current_edit_record&&this.current_edit_record.user_ids&&this.current_edit_record.user_ids.length>1)}setEditMenuSaveAndAddIcon(e,t){this.saveAndNewValidate(e),(this.is_viewing||this.is_mass_editing||this.is_mass_adding)&&e.addClass("disable-image")}setEditMenuSaveAndCopyIcon(e,t){this.saveAndCopyValidate(e),(this.is_viewing||this.is_mass_editing||this.is_mass_adding)&&e.addClass("disable-image")}onTypeChange(e){20==this.current_edit_record.status_id?this.attachElement("absence_policy_id"):this.detachElement("absence_policy_id")}setEditViewData(){super.setEditViewData(),this.onTypeChange(!1)}checkOpenPermission(){return!!(Global.getProductEdition()>=15&&PermissionManager.validate("schedule","view_open"))}getOtherFieldReferenceField(){return"note"}buildEditViewUI(){var e,t,i=this;this.edit_view_close_icon=this.edit_view.find(".close-icon"),this.edit_view_close_icon.hide(),this.edit_view_close_icon.click((function(){i.onCloseIconClick()}));var a={"tab_schedule":{"label":$.i18n._("Schedule")},"tab_audit":!0};this.setTabModel(a);var s=this.edit_view_tab.find("#tab_schedule").find(".first-column");Global.getProductEdition();(e=Global.loadWidgetByName(FormItemType.AWESOME_BOX)).AComboBox({api_class:TTAPI.APIUser,allow_multiple_selection:!1,layout_name:"global_user",show_search_inputs:!0,set_empty:!this.checkOpenPermission(),set_open:this.checkOpenPermission(),field:"user_id"});var r={permission_section:"schedule"};if(e.setDefaultArgs(r),this.addEditFieldToColumn($.i18n._("Employee"),e,s,"",null,!0),(e=Global.loadWidgetByName(FormItemType.AWESOME_BOX)).AComboBox({api_class:TTAPI.APIUser,allow_multiple_selection:!0,layout_name:"global_user",show_search_inputs:!0,set_empty:!this.checkOpenPermission(),set_open:this.checkOpenPermission(),addition_source_function:function(e,t){return i.onEmployeeSourceCreate(e,t)},field:"user_ids"}),(r={}).permission_section="schedule",e.setDefaultArgs(r),this.addEditFieldToColumn($.i18n._("Employee"),e,s,"",null,!0),(e=Global.loadWidgetByName(FormItemType.COMBO_BOX)).TComboBox({field:"status_id"}),e.setSourceData(i.status_array),this.addEditFieldToColumn($.i18n._("Status"),e,s),(e=Global.loadWidgetByName(FormItemType.DATE_PICKER)).TDatePicker({field:"start_date_stamp",validation_field:"date_stamp"}),this.addEditFieldToColumn($.i18n._("Date"),e,s,"",null,!0),(e=Global.loadWidgetByName(FormItemType.DATE_PICKER)).TRangePicker({field:"start_date_stamps"}),this.addEditFieldToColumn($.i18n._("Date"),e,s,"",null,!0),(e=Global.loadWidgetByName(FormItemType.AWESOME_BOX)).AComboBox({allow_multiple_selection:!0,layout_name:"global_option_column",show_search_inputs:!1,set_empty:!0,field:"start_dates"}),this.addEditFieldToColumn($.i18n._("Date"),e,s,"",null,!0),(e=Global.loadWidgetByName(FormItemType.TIME_PICKER)).TTimePicker({field:"start_time"}),this.addEditFieldToColumn($.i18n._("In"),e,s,"",null,!0),(e=Global.loadWidgetByName(FormItemType.TIME_PICKER)).TTimePicker({field:"end_time"}),this.addEditFieldToColumn($.i18n._("Out"),e,s,"",null,!0),(e=Global.loadWidgetByName(FormItemType.TEXT)).TText({field:"total_time"}),e.css("cursor","pointer"),this.addEditFieldToColumn($.i18n._("Total"),e,s),(e=Global.loadWidgetByName(FormItemType.AWESOME_BOX)).AComboBox({api_class:TTAPI.APISchedulePolicy,allow_multiple_selection:!1,layout_name:"global_schedule",show_search_inputs:!0,set_empty:!0,field:"schedule_policy_id"}),this.addEditFieldToColumn($.i18n._("Schedule Policy"),e,s),(e=Global.loadWidgetByName(FormItemType.AWESOME_BOX)).AComboBox({api_class:TTAPI.APIAbsencePolicy,allow_multiple_selection:!1,layout_name:"global_absences",show_search_inputs:!0,set_empty:!0,field:"absence_policy_id"}),e.customSearchFilter=function(e){return i.setAbsencePolicyFilter(e)},this.addEditFieldToColumn($.i18n._("Absence Policy"),e,s,"",null,!0),(e=Global.loadWidgetByName(FormItemType.TEXT)).TText({field:"available_balance"}),t=$("<div class='widget-h-box'></div>"),this.available_balance_info=$('<img class="available-balance-info" src="'+Global.getRealImagePath("images/infox16x16.png")+'">'),t.append(e),t.append(this.available_balance_info),this.addEditFieldToColumn($.i18n._("Available Balance"),e,s,"",t,!0),(!this.current_edit_record||this.current_edit_record.user_ids&&this.current_edit_record.user_ids.length>1)&&this.detachElement("available_balance"),(e=Global.loadWidgetByName(FormItemType.AWESOME_BOX)).AComboBox({api_class:TTAPI.APIBranch,allow_multiple_selection:!1,layout_name:"global_branch",show_search_inputs:!0,set_empty:!0,field:"branch_id",addition_source_function:function(e,t){return i.onSourceDataCreate(e,t)},added_items:[{value:TTUUID.not_exist_id,label:Global.default_item},{value:"-2",label:Global.selected_item}]}),this.addEditFieldToColumn($.i18n._("Branch"),e,s,"",null,!0),this.show_branch_ui||this.detachElement("branch_id"),(e=Global.loadWidgetByName(FormItemType.AWESOME_BOX)).AComboBox({api_class:TTAPI.APIDepartment,allow_multiple_selection:!1,layout_name:"global_department",show_search_inputs:!0,set_empty:!0,field:"department_id",addition_source_function:function(e,t){return i.onSourceDataCreate(e,t)},added_items:[{value:TTUUID.not_exist_id,label:Global.default_item},{value:"-2",label:Global.selected_item}]}),this.addEditFieldToColumn($.i18n._("Department"),e,s,"",null,!0),this.show_department_ui||this.detachElement("department_id"),Global.getProductEdition()>=20){(e=Global.loadWidgetByName(FormItemType.AWESOME_BOX)).AComboBox({api_class:TTAPI.APIJob,allow_multiple_selection:!1,layout_name:"global_job",show_search_inputs:!0,set_empty:!0,setRealValueCallBack:function(e){e&&l.setValue(e.manual_id)},field:"job_id",addition_source_function:function(e,t){return i.onSourceDataCreate(e,t)},added_items:[{value:TTUUID.not_exist_id,label:Global.default_item},{value:"-2",label:Global.selected_item}]}),t=$("<div class='widget-h-box'></div>");var l=Global.loadWidgetByName(FormItemType.TEXT_INPUT);l.TTextInput({field:"job_quick_search",disable_keyup_event:!0}),l.addClass("job-coder"),t.append(l),t.append(e),this.addEditFieldToColumn($.i18n._("Job"),[e,l],s,"",t,!0),this.show_job_ui||this.detachElement("job_id"),(e=Global.loadWidgetByName(FormItemType.AWESOME_BOX)).AComboBox({api_class:TTAPI.APIJobItem,allow_multiple_selection:!1,layout_name:"global_job_item",show_search_inputs:!0,set_empty:!0,setRealValueCallBack:function(e){e&&d.setValue(e.manual_id)},field:"job_item_id",addition_source_function:function(e,t){return i.onSourceDataCreate(e,t)},added_items:[{value:TTUUID.not_exist_id,label:Global.default_item},{value:"-2",label:Global.selected_item}]}),t=$("<div class='widget-h-box'></div>");var d=Global.loadWidgetByName(FormItemType.TEXT_INPUT);d.TTextInput({field:"job_item_quick_search",disable_keyup_event:!0}),d.addClass("job-coder"),t.append(d),t.append(e),this.addEditFieldToColumn($.i18n._("Task"),[e,d],s,"",t,!0),this.show_job_item_ui||this.detachElement("job_item_id")}(e=Global.loadWidgetByName(FormItemType.TEXT_AREA)).TTextArea({field:"note",width:"100%"}),this.addEditFieldToColumn($.i18n._("Note"),e,s,"",null,null,!0),e.parent().width("45%"),TTPromise.resolve("Schedule","init")}setDefaultMenuDeleteIcon(e,t,i){this.deletePermissionValidate(i)&&!this.edit_only_mode||e.addClass("invisible-image"),t>0&&this.deleteOwnerOrChildPermissionValidate(i)?e.removeClass("disable-image"):e.addClass("disable-image")}onAvailableBalanceChange(){20==this.current_edit_record.status_id&&this.current_edit_record.hasOwnProperty("absence_policy_id")&&this.current_edit_record.absence_policy_id&&!this.is_mass_editing?this.getAvailableBalance():this.detachElement("available_balance")}parserDatesRange(e){for(var t=e.split(" - "),i=[],a=Global.strToDate(t[0]),s=Global.strToDate(t[1]),r=a;r.getTime()<s.getTime();)i.push(r.format()),r=new Date(new Date(r.getTime()).setDate(r.getDate()+1));return i.push(t[1]),i}getSelectUsersArray(){for(var e=[],t=this.select_cells_Array,i=t.length,a={},s=0;s<i;s++){var r=t[s];r.user_id||(r.user_id=TTUUID.zero_id),a[r.user_id]=!0}for(var l in a)e.push(l);return 0===e.length&&e.push(this.getDefaultUser()),e}getSelectDateArray(){for(var e=[],t=this.select_cells_Array,i=t.length,a={},s=0;s<i;s++){var r=t[s];r.date&&(a[r.date]=!0)}for(var l in a)e.push(l);return e}getAvailableBalance(){var e=this,t=this.current_edit_record.user_id,i=this.current_edit_record.total_time,a=this.current_edit_record.start_date_stamp;if(0==this.previous_absence_policy_id&&(this.previous_absence_policy_id=this.current_edit_record.absence_policy_id),this.is_mass_adding){if(this.current_edit_record.user_ids.length>1)return void this.detachElement("available_balance");if(!(t=this.current_edit_record.user_ids[0]))return void this.detachElement("available_balance");i*=this.current_edit_record.start_dates.length,a=this.current_edit_record.start_dates[this.current_edit_record.start_dates.length-1]}else if((a.indexOf(" - ")>0||"array"===$.type(a))&&(a.indexOf(" - ")>0&&(a=this.parserDatesRange(a)),a.length>0&&(i*=a.length,a=a[a.length-1])),!(this.current_edit_record&&this.current_edit_record.id&&this.current_edit_record.id!=TTUUID.zero_id||this.is_mass_editing)){if(this.current_edit_record.user_ids.length<1||this.current_edit_record.user_ids.length>1)return void this.detachElement("available_balance");if(!(t=this.current_edit_record.user_ids[0]))return void this.detachElement("available_balance")}this.current_edit_record&&this.current_edit_record.id&&10==this.prev_status_id&&20==this.edit_view_ui_dic.status_id.getValue()&&(this.prev_total_time=0),this.current_edit_record.absence_policy_id!=TTUUID.zero_id?this.api_absence_policy.getProjectedAbsencePolicyBalance(this.current_edit_record.absence_policy_id,t,a,i,this.prev_total_time,this.previous_absence_policy_id,{onResult:function(t){e.getBalanceHandler(t,a)}}):this.getBalanceHandler(!1,a)}buildSearchAndLayoutUI(){var e=this.search_panel.find("div #saved_layout_content_div"),t=$(Global.loadWidget("global/widgets/search_panel/FormItem.html")),i=t.find(".form-item-label"),a=t.find(".form-item-input-div"),s=Global.loadWidget("global/widgets/awesomebox/ADropDown.html");this.column_selector=$(s),this.column_selector=this.column_selector.ADropDown({display_show_all:!1,id:"column_selector",key:"value",allow_drag_to_order:!0,display_close_btn:!1,display_column_settings:!1,static_height:150}),i.text($.i18n._("Display Columns")+":"),a.append(this.column_selector),e.append(t),e.append("<div class='clear-both-div'></div>"),this.column_selector.setColumns([{name:"label",index:"label",label:$.i18n._("Column Name"),width:100,sortable:!1}]),i=(t=$(Global.loadWidget("global/widgets/search_panel/FormItem.html"))).find(".form-item-label"),a=t.find(".form-item-input-div"),i.text($.i18n._("Save Search As")+": "),this.save_search_as_input=Global.loadWidget("global/widgets/text_input/TTextInput.html"),this.save_search_as_input=$(this.save_search_as_input),this.save_search_as_input.TTextInput();var r=$("<input class='t-button' style='margin-left: 5px' type='button' value='"+$.i18n._("Save")+"'></input>");a.append(this.save_search_as_input),a.append(r);var l=this;r.click((function(){l.onSaveNewLayout()})),this.previous_saved_layout_div=$("<div class='previous-saved-layout-div'></div>"),a.append(this.previous_saved_layout_div),i=$("<span style='margin-left: 5px' >"+$.i18n._("Previous Saved Searches")+":</span>"),this.previous_saved_layout_div.append(i),this.previous_saved_layout_selector=$("<select style='margin-left: 5px' class='t-select'>");var d=$("<input class='t-button' style='margin-left: 5px' type='button' value='"+$.i18n._("Update")+"'></input>"),o=$("<input class='t-button' style='margin-left: 5px' type='button' value='"+$.i18n._("Delete")+"'></input>");d.click((function(){l.onUpdateLayout()})),o.click((function(){l.onDeleteLayout()})),this.previous_saved_layout_div.append(this.previous_saved_layout_selector),this.previous_saved_layout_div.append(d),this.previous_saved_layout_div.append(o),e.append(t),this.previous_saved_layout_div.css("display","none")}setCurrentEditRecordData(){for(var e in this.is_mass_adding?(this.attachElement("start_dates"),this.detachElement("start_date_stamp"),this.detachElement("start_date_stamps"),this.attachElement("user_ids"),this.detachElement("user_id"),this.edit_view_ui_dic.start_dates.setEnabled(!1),this.edit_view_ui_dic.user_ids.setEnabled(!1)):(this.detachElement("start_dates"),this.current_edit_record.id&&this.current_edit_record.id!=TTUUID.zero_id||this.is_mass_editing?(this.attachElement("start_date_stamp"),this.detachElement("start_date_stamps"),this.detachElement("user_ids"),this.attachElement("user_id")):(this.attachElement("start_date_stamps"),this.detachElement("start_date_stamp"),this.current_edit_record.start_date_stamps=this.current_edit_record.start_date_stamp,this.attachElement("user_ids"),this.detachElement("user_id"))),this.prev_total_time=0,this.current_edit_record.id&&this.current_edit_record.id!=TTUUID.zero_id&&(this.prev_status_id=this.current_edit_record.status_id),this.current_edit_record){var t=this.edit_view_ui_dic[e];if(Global.isSet(t))switch(e){case"user_ids":if(t.is(":visible")){var i=this.getSelectUsersArray();this.current_edit_record[e]=i,t.setValue(i)}break;case"start_dates":var a=this.getSelectDateArray();this.current_edit_record[e]=a,a=Global.buildRecordArray(a),t.setSourceData(a),t.setValue(a);break;case"total_time":this.current_edit_record.id&&this.current_edit_record.id!=TTUUID.zero_id&&(this.prev_total_time=this.current_edit_record[e]);var s=this.current_edit_record.date_stamp+" "+this.current_edit_record.start_time,r=this.current_edit_record.date_stamp+" "+this.current_edit_record.end_time,l=this.current_edit_record.schedule_policy_id,d=this.current_edit_record.user_id,o=this.api.getScheduleTotalTime(s,r,l,d,{async:!1});o=!!o&&o.getResult(),this.current_edit_record.total_time=o,t.setValue(Global.getTimeUnit(o));break;case"job_id":if(Global.getProductEdition()>=20){d=!1;d=this.edit_view_ui_dic.user_ids&&this.edit_view_ui_dic.user_ids.is(":visible")?1==(d=this.getSelectUsersArray()).length&&d[0]:this.current_edit_record.user_id,(_={}).filter_data={status_id:10,user_id:d},t.setDefaultArgs(_),t.setValue(this.current_edit_record[e])}break;case"job_item_id":var _;if(Global.getProductEdition()>=20)(_={}).filter_data={status_id:10,job_id:this.current_edit_record.job_id},t.setDefaultArgs(_),t.setValue(this.current_edit_record[e]);break;case"job_quick_search":case"job_item_quick_search":break;default:t.setValue(this.current_edit_record[e])}}this.onAvailableBalanceChange(),this.setEditViewDataDone()}setAbsencePolicyFilter(e){return e.filter_data||(e.filter_data={}),this.is_mass_editing?this.edit_view_ui_dic.user_id.isChecked()?e.filter_data.user_id=this.current_edit_record.user_id:e.filter_data.user_id=this.selected_user_ids:this.current_edit_record&&this.current_edit_record.id&&this.current_edit_record.id!=TTUUID.zero_id?e.filter_data.user_id=this.current_edit_record.user_id:e.filter_data.user_id=this.current_edit_record.user_ids,e.filter_columns&&(e.filter_columns.absence_policy=!0),e}setDefaultMenuCopyIcon(e,t,i){this.copyPermissionValidate()&&!i||e.addClass("invisible-image"),t>=1?e.removeClass("disable-image"):e.addClass("disable-image")}setDefaultMenuSaveAndAddIcon(e,t,i){(!this.addPermissionValidate()&&!this.editPermissionValidate()||i)&&e.addClass("invisible-image"),e.addClass("disable-image")}setDefaultMenuSaveAndCopyIcon(e,t,i){(!this.addPermissionValidate()&&!this.editPermissionValidate()||i)&&e.addClass("invisible-image"),e.addClass("disable-image")}setDefaultMenuCopyAsNewIcon(e,t,i){this.copyAsNewPermissionValidate()&&!i||e.addClass("invisible-image"),1===t?e.removeClass("disable-image"):e.addClass("disable-image")}setEditMenu(){this.selectContextMenu();for(var e=this.context_menu_array.length,t=0;t<e;t++){var i=$(this.context_menu_array[t]),a=$(i.find(".ribbon-sub-menu-icon")).attr("id");if(i.removeClass("disable-image"),this.is_mass_editing||this.is_mass_adding)switch(a){case ContextMenuIconName.save:this.setEditMenuSaveIcon(i);break;case ContextMenuIconName.cancel:break;default:i.addClass("disable-image")}else switch(a){case ContextMenuIconName.add:this.setEditMenuAddIcon(i);break;case ContextMenuIconName.edit:this.setEditMenuEditIcon(i);break;case ContextMenuIconName.view:this.setEditMenuViewIcon(i);break;case ContextMenuIconName.mass_edit:this.setEditMenuMassEditIcon(i);break;case ContextMenuIconName.copy:this.setEditMenuCopyIcon(i);break;case ContextMenuIconName.delete_icon:this.setEditMenuDeleteIcon(i);break;case ContextMenuIconName.delete_and_next:this.setEditMenuDeleteAndNextIcon(i);break;case ContextMenuIconName.save:this.setEditMenuSaveIcon(i);break;case ContextMenuIconName.save_and_continue:this.setEditMenuSaveAndContinueIcon(i);break;case ContextMenuIconName.save_and_new:this.setEditMenuSaveAndAddIcon(i);break;case ContextMenuIconName.save_and_next:this.setEditMenuSaveAndNextIcon(i);break;case ContextMenuIconName.save_and_copy:this.setEditMenuSaveAndCopyIcon(i);break;case ContextMenuIconName.copy_as_new:this.setEditMenuCopyAndAddIcon(i);break;case ContextMenuIconName.cancel:break;case ContextMenuIconName.import_icon:this.setEditMenuImportIcon(i);break;case ContextMenuIconName.find_available:this.setEditMenuFindAvailableIcon(i)}}this.setContextMenuGroupVisibility()}_getGridSelectedLength(){return this.select_all_shifts_array.length}setDefaultMenu(e){if(this.context_menu_array&&(Global.isSet(e)&&e||this.selectContextMenu(),this.context_menu_array)){for(var t=this.context_menu_array.length,i=this._getGridSelectedLength(),a=!1,s=0;s<t;s++){var r=$(this.context_menu_array[s]),l=$(r.find(".ribbon-sub-menu-icon")).attr("id");switch(r.removeClass("disable-image"),r.removeClass("invisible-image"),l){case ContextMenuIconName.add:this.setDefaultMenuAddIcon(r,i);break;case ContextMenuIconName.edit:this.setDefaultMenuEditIcon(r,i);break;case ContextMenuIconName.view:this.setDefaultMenuViewIcon(r,i);break;case ContextMenuIconName.mass_edit:this.setDefaultMenuMassEditIcon(r,i);break;case ContextMenuIconName.copy:this.setDefaultMenuCopyIcon(r,i,a);break;case ContextMenuIconName.delete_icon:this.setDefaultMenuDeleteIcon(r,i);break;case ContextMenuIconName.save:this.setDefaultMenuSaveIcon(r,i);break;case ContextMenuIconName.save_and_continue:this.setDefaultMenuSaveAndContinueIcon(r,i);break;case ContextMenuIconName.save_and_new:this.setDefaultMenuSaveAndAddIcon(r,i,a);break;case ContextMenuIconName.save_and_copy:this.setDefaultMenuSaveAndCopyIcon(r,i,a);break;case ContextMenuIconName.copy_as_new:this.setDefaultMenuCopyAsNewIcon(r,i,a);break;case ContextMenuIconName.move:this.movePermissionValidate()||r.addClass("invisible-image");break;case ContextMenuIconName.drag_copy:this.copyPermissionValidate()||r.addClass("invisible-image");break;case ContextMenuIconName.swap:this.editPermissionValidate()||r.addClass("invisible-image");break;case ContextMenuIconName.override:this.editPermissionValidate()||this.movePermissionValidate()||this.copyPermissionValidate()||r.addClass("invisible-image");break;case ContextMenuIconName.cancel:this.setDefaultMenuCancelIcon(r,i);break;case ContextMenuIconName.edit_employee:this.setDefaultMenuEditEmployeeIcon(r,i);break;case ContextMenuIconName.import_icon:this.setDefaultMenuImportIcon(r,i);break;case ContextMenuIconName.timesheet:this.setDefaultMenuEditTimesheetIcon(r,i);break;case ContextMenuIconName.find_available:this.setDefaultMenuFindAvailabletIcon(r,i);break;case"AutoPunch":this.setAutoPunchIcon(r,i);break;case"AddRequest":this.setAddRequestIcon(r,i)}}this.setContextMenuGroupVisibility()}}enableAddRequestButton(){var e=[];if(!this.select_cellls_and_shifts_array)return!1;var t=this.select_cellls_and_shifts_array.length;if(1==t)return!0;if(0==t)return!1;for(var i=(e=this.select_cells_Array)[0],a=1;a<e.length;a++){if(e[a].user_id&&i.user_id!=e[a].user_id)return Debug.Text("mismatch on user_id","ScheduleViewController.js","ScheduleViewController","enableAddRequestButton",10),!1;if(null!=e[a].shift)if(i.shift&&e[a].shift){if(i.shift.start_time!=e[a].shift.start_time)return Debug.Text("mismatch on start_time","ScheduleViewController.js","ScheduleViewController","enableAddRequestButton",10),!1;if(i.shift.end_time!=e[a].shift.end_time)return Debug.Text("mismatch on end_time","ScheduleViewController.js","ScheduleViewController","enableAddRequestButton",10),!1;if(i.shift.branch_id!=e[a].shift.branch_id)return Debug.Text("mismatch on branch_id","ScheduleViewController.js","ScheduleViewController","enableAddRequestButton",10),!1;if(i.shift.department_id!=e[a].shift.department_id)return Debug.Text("mismatch on department_id","ScheduleViewController.js","ScheduleViewController","enableAddRequestButton",10),!1;if(i.shift.job_id!=e[a].shift.job_id)return Debug.Text("mismatch on job_id","ScheduleViewController.js","ScheduleViewController","enableAddRequestButton",10),!1;if(i.shift.job_item_id!=e[a].shift.job_item_id)return Debug.Text("mismatch on job_item_id","ScheduleViewController.js","ScheduleViewController","enableAddRequestButton",10),!1;if(i.shift.schedule_policy_id!=e[a].shift.schedule_policy_id)return Debug.Text("mismatch on schedule_policy_id","ScheduleViewController.js","ScheduleViewController","enableAddRequestButton",10),!1;if(i.shift.status_id!=e[a].shift.status_id)return Debug.Text("mismatch on status_id","ScheduleViewController.js","ScheduleViewController","enableAddRequestButton",10),!1;if(20==i.shift.status_id&&i.shift.absence_policy_id!=e[a].shift.absence_policy_id)return Debug.Text("mismatch on absence_policy_id","ScheduleViewController.js","ScheduleViewController","enableAddRequestButton",10),!1}else null==i.shift&&e[a].shift&&(i=e[a])}return Debug.Text("All Selected Schedules Match","ScheduleViewController.js","ScheduleViewController","enableAddRequestButton",10),!0}setAutoPunchIcon(e,t){t>0?e.removeClass("disable-image"):e.addClass("disable-image")}setEditMenuFindAvailableIcon(e){e.addClass("disable-image")}setDefaultMenuFindAvailabletIcon(e,t,i){this.editChildPermissionValidate()||e.addClass("invisible-image"),t>=1?e.removeClass("disable-image"):e.addClass("disable-image")}setDefaultMenuEditTimesheetIcon(e,t,i){1===this.select_cells_Array.length&&TTUUID.isUUID(this.select_cells_Array[0].user_id)&&this.select_cells_Array[0].user_id!=TTUUID.zero_id?e.removeClass("disable-image"):e.addClass("disable-image")}setDefaultMenuEditEmployeeIcon(e,t,i){this.editChildPermissionValidate("user")||e.addClass("invisible-image"),1===this.select_cells_Array.length&&TTUUID.isUUID(this.select_cells_Array[0].user_id)&&this.select_cells_Array[0].user_id!=TTUUID.zero_id?e.removeClass("disable-image"):e.addClass("disable-image")}onUpdateLayout(){var e=$(this.previous_saved_layout_selector).children("option:selected").attr("value"),t=$(this.previous_saved_layout_selector).children("option:selected").text(),i=this.getSearchPanelDisplayColumns(),a=this.getValidSearchFilter(),s={};s.id=e,s.data={},s.data.display_columns=i,s.data.filter_data=a,s.data.mode=Global.upCaseFirstLetter(this.getMode()),s.data.strictRange=this.strict_range_btn.getValue(),s.data.weeklyTotals=this.weekly_totals_btn.getValue(),s.data.dailyTotals=this.daily_totals_btn.getValue(),s.data.showAllEmp=this.all_employee_btn.getValue();var r=this;this.user_generic_data_api.setUserGenericData(s,{onResult:function(e){e.isValid()&&(r.clearViewLayoutCache(),r.need_select_layout_name=t,r.initLayout())}})}onSaveNewLayout(e){if(Global.isSet(e))var t=e;else t=this.save_search_as_input.getValue();if(t&&!(t.length<1)){var i=this.getSearchPanelDisplayColumns(),a=this.getValidSearchFilter(),s={};s.script=this.script_name,s.name=t,s.is_default=!1,s.data={},s.data.display_columns=i,s.data.filter_data=a,s.data.mode=Global.upCaseFirstLetter(this.getMode()),s.data.strictRange=this.strict_range_btn.getValue(),s.data.weeklyTotals=this.weekly_totals_btn.getValue(),s.data.dailyTotals=this.daily_totals_btn.getValue(),s.data.showAllEmp=this.all_employee_btn.getValue();var r=this;this.user_generic_data_api.setUserGenericData(s,{onResult:function(e){e.isValid()?(r.clearViewLayoutCache(),r.need_select_layout_name=t,r.initLayout()):TAlertManager.showErrorAlert(e)}})}}onClearSearch(){var e=!1;if(!(this.search_panel.getLayoutsArray()&&this.search_panel.getLayoutsArray().length>0))return this.clearSearchPanel(),this.filter_data=null,this.temp_adv_filter_data=null,this.temp_basic_filter_data=null,this.column_selector.setSelectGridData(this.default_display_columns),void this.onSaveNewLayout(BaseViewController.default_layout_name);var t=$(this.previous_saved_layout_selector).children("option:contains('"+BaseViewController.default_layout_name+"')").attr("value"),i=BaseViewController.default_layout_name;this.clearSearchPanel(),this.filter_data=null,this.temp_adv_filter_data=null,this.temp_basic_filter_data=null,e=!0;var a=this.getSearchPanelDisplayColumns(),s=this.getValidSearchFilter();if(e){var r={};r.id=t,r.data={},r.data.display_columns=a,r.data.filter_data=s}r.data.mode=this.getMode();var l=this;this.user_generic_data_api.setUserGenericData(r,{onResult:function(e){e.isValid()&&(l.clearViewLayoutCache(),l.need_select_layout_name=i,l.initLayout())}})}getSearchPanelDisplayColumns(){var e=[],t=this.column_selector.getSelectItems();return t&&t.length>0&&$.each(t,(function(t,i){e.push(i.value)})),e}onSearch(){if(this.temp_adv_filter_data=null,this.temp_basic_filter_data=null,this.getSearchPanelFilter(),this.search_panel.getLayoutsArray()&&this.search_panel.getLayoutsArray().length>0){var e=$(this.previous_saved_layout_selector).children("option:contains('"+BaseViewController.default_layout_name+"')").attr("value");if(e){var t=BaseViewController.default_layout_name,i=this.getSearchPanelDisplayColumns(),a=this.getValidSearchFilter(),s={};s.id=e,s.data={},s.data.display_columns=i,s.data.filter_data=a,s.data.mode=Global.upCaseFirstLetter(this.getMode()),s.data.strictRange=this.strict_range_btn.getValue(),s.data.weeklyTotals=this.weekly_totals_btn.getValue(),s.data.dailyTotals=this.daily_totals_btn.getValue(),s.data.showAllEmp=this.all_employee_btn.getValue(),ProgressBar.showOverlay();var r=this;this.user_generic_data_api.setUserGenericData(s,{onResult:function(e){e.isValid()&&(r.clearViewLayoutCache(),r.need_select_layout_name=t,r.initLayout())}})}else this.onSaveNewLayout(BaseViewController.default_layout_name)}else this.onSaveNewLayout(BaseViewController.default_layout_name)}setSelectLayout(){var e=this;this.select_layout||(this.select_layout={id:""},this.select_layout.data={filter_data:{},filter_sort:{}},this.select_layout.data.display_columns=this.default_display_columns);var t=this.select_layout.data,i=this.buildDisplayColumns(t.display_columns);Global.isSet(t.mode)?e.setToggleButtonValue(t.mode.toLowerCase()):LocalCacheData.getAllURLArgs()&&LocalCacheData.getAllURLArgs().mode?e.setToggleButtonValue(LocalCacheData.getAllURLArgs().mode):e.setToggleButtonValue(l.WEEK),this.column_selector.setSelectGridData(i);var a=this.search_panel.getLayoutsArray();if(this.previous_saved_layout_selector.empty(),a&&a.length>0){this.previous_saved_layout_div.css("display","inline");for(var s=a.length,r=0;r<s;r++){var d=a[r];this.previous_saved_layout_selector.append($('<option value="'+d.id+'"></option>').text(d.name))}$(this.previous_saved_layout_selector.find("option")).filter((function(){return $(this).attr("value")===e.select_layout.id})).prop("selected",!0).attr("selected",!0)}else this.previous_saved_layout_div.css("display","none");LocalCacheData.default_filter_for_next_open_view&&(this.select_layout.data.filter_data=LocalCacheData.default_filter_for_next_open_view.filter_data,this.setDatePickerValue(LocalCacheData.default_filter_for_next_open_view.select_date),this.select_layout.data.mode="Week",e.setToggleButtonValue(t.mode.toLowerCase()),LocalCacheData.default_filter_for_next_open_view=null),this.filter_data=this.select_layout.data.filter_data,this.setSearchPanelFilter(!0)}getMode(){if(this.toggle_button)return this.toggle_button.getValue()}search(e,t){this.clearSelection(),this.setActionsButtonStatus(),this.final_schedule_data_array=[];var i,a=this,s=Global.convertLayoutFilterToAPIFilter(this.select_layout),r=this.getMode();this.all_employee_btn.getValue()&&(s.include_all_users=!0);var d=this.strict_range_btn.getValue();t||!this.end_date||void 0===e&&void 0===t?(i=this.start_date_picker.getValue(),r===l.YEAR&&(this.year_mode_original_date=i)):i=d?r===l.YEAR?this.year_mode_original_date?this.year_mode_original_date:this.start_date_picker.getValue():r===l.MONTH?new Date(new Date(a.end_date.getTime()).setDate(a.end_date.getDate()-15)).format():a.end_date.format():a.start_date.format(),ProgressBar.showOverlay(),LocalCacheData.last_schedule_selected_date=i,this.api.getCombinedSchedule({filter_data:s},i,r,d,{onResult:function(t){a.full_schedule_data=t.getResult(),!0!==a.full_schedule_data&&a.full_schedule_data&&a.full_schedule_data.schedule_dates&&(a.start_date=Global.strToDate(a.full_schedule_data.schedule_dates.start_display_date),a.end_date=Global.strToDate(a.full_schedule_data.schedule_dates.end_display_date),a.buildCalendars(),e&&(a.setDefaultMenu(!0),a.autoOpenEditViewIfNecessary()),a.searchDone(),a.setWeekModeDragAble())}})}searchDone(){$(".button-rotate").removeClass("button-rotate"),TTPromise.resolve("init","init")}getLastDateOfRow(e){return e[(0==LocalCacheData.getLoginUserPreference().start_week_day?7:LocalCacheData.getLoginUserPreference().start_week_day)-1+"_time"]}setActionsButtonStatus(){var e=this.getMode();switch(this.weekly_totals_btn.setEnable(!0),this.strict_range_btn.setEnable(!0),this.daily_totals_btn.setEnable(!0),this.all_employee_btn.setEnable(!0),e){case l.DAY:this.weekly_totals_btn.setEnable(!1),this.strict_range_btn.setEnable(!1);break;case l.WEEK:case l.MONTH:break;case l.YEAR:this.weekly_totals_btn.setEnable(!1),this.daily_totals_btn.setEnable(!1)}}onOverrideClick(){var e=$("#"+ContextMenuIconName.override);e.hasClass("selected-menu")?(e.removeClass("selected-menu"),this.is_override=!1):(e.addClass("selected-menu"),this.is_override=!0)}setMoveOrDropMode(e){var t=$("#"+ContextMenuIconName.drag_copy),i=$("#"+ContextMenuIconName.move),a=$("#"+ContextMenuIconName.swap);$("#"+ContextMenuIconName.override);t.removeClass("selected-menu"),i.removeClass("selected-menu"),a.removeClass("selected-menu");var s=!1,r=!1;this.copyPermissionValidate()||(s=!0),this.movePermissionValidate()||(r=!0),this.editPermissionValidate(),r&&e===ContextMenuIconName.move?t.addClass("selected-menu"):$("#"+e).addClass("selected-menu"),this.select_drag_menu_id=s&&r?null:e}setHolidayDataDic(){if(this.full_schedule_data.holiday_data)for(var e=0;e<this.full_schedule_data.holiday_data.length;e++){var t=this.full_schedule_data.holiday_data[e],i=Global.strToDate(t.date_stamp).format(this.weekly_format);this.holiday_data_dic[i]=t}}buildCalendars(e){this.grid_div=$(this.el).find(".schedule-grid-div"),this.setHolidayDataDic(),this.buildScheduleColumns(),this.buildScheduleSource(),this.buildScheduleGrid(),this.setGridColumnsWidth(),this.setGridSize(),this.setYearGroupHeader(),this.showGridBorders();if(this.grid){this.grid.clearGridData();var t=0;if(e||this.grid.grid.css("opacity",0),this.schedule_source){var i=this;s();var a=setInterval((function(){t<i.schedule_source.length?s():function(){e||i.grid.grid.css("opacity",1);clearInterval(a),i.getMode!==l.YEAR&&i.setScheduleGridRowSpan();i.highLightSelectDay(),i.setMonthDateRowPosition(),i.setScheduleGridDragAble(),i.setScrollPosition(),i.setMonthDateRowBackGround(),i.setWeeklyTotalHeader()}()}),10)}}function s(){for(var e=t;e<t+200&&e<i.schedule_source.length;e++){var a=i.schedule_source[e];i.grid.grid.addRowData(e+1,a)}t=e}}getDefaultUser(){return this.schedule_source&&1===this.schedule_source.length&&""!=this.schedule_source[0].user_id?this.schedule_source[0].user_id:this.schedule_source&&1===this.schedule_source.length&&"object"==typeof this.filter_data&&"object"==typeof this.filter_data.include_user_ids&&this.filter_data.include_user_ids.value&&1===this.filter_data.include_user_ids.value.length?this.filter_data.include_user_ids.value[0]:this.current_edit_record.user_id&&""!=this.current_edit_record.user_id?this.current_edit_record.user_id:LocalCacheData.getLoginUser().id}setWeeklyTotalHeader(){var e=this.weekly_totals_btn.getValue();if($(".size-tr").remove(),$(".group-tr").remove(),e&&this.weekly_totals_btn.getEnabled()){var t=$($(this.el).find("table[aria-labelledby=gbox_"+this.ui_id+"_grid]")),i=$('<tr class="size-tr" ></tr>'),a=$('<tr class="group-column-tr group-tr" ></tr>'),s=$('<th class="group-column-th"  ><span class="group-column-label"></span></th>'),r=t.find(".jqgfirstrow");!function(){for(var e=r.children().length,t=0;t<e;t++){var a=$('<th class="" style="border-right: 1px solid #dddddd" ></th>'),s=r.children().eq(t);a.css("width",s.css("width")),a.height(0),i.append(a)}}(),l(this.grid.grid.getGridParam("colModel").length-5,""),l(5,$.i18n._("Total")),i.insertBefore(t.find(".ui-jqgrid-labels")),a.insertBefore(t.find(".ui-jqgrid-labels")),this.setGridHeight()}function l(e,t){var i=s.clone();i.children(0).text(t),i.attr("colspan",e),a.append(i)}}setMonthDateRowBackGround(){this.getMode()===l.MONTH&&$(this.el).find(".month-date-cell").parent().css("background-color","#375979")}setScrollPosition(){this.scroll_position>0&&this.grid.grid.parent().parent().scrollTop(this.scroll_position)}setYearGroupHeader(){if(this.getMode()===l.YEAR){$(".schedule-year-group-header").remove();var e=$($(this.el).find("table[aria-labelledby=gbox_"+this.ui_id+"_grid]")[0]),t=$('<tr class="group-column-tr schedule-year-group-header" ></tr>'),i=$('<th class="group-column-th"  ><span class="group-column-label"></span></th>'),a=t.clone();$(e.children()[0]).prepend(a);for(var s=e.find("th"),r=s.length,d=0;d<r;d++){var o=$(s[d]),_=o.clone();_.attr("id",""),_.empty(),_.attr("row",""),_.height(0),a.append(_)}var n=$($(e.children()[0]).children()[0]),c=this.select_layout.data.display_columns.length+1;a=t.clone(),(_=i.clone()).attr("colspan",c),a.append(_),a.insertAfter(n);var h=null,u=null,m=0;for(d=c;d<r;d++){var p=(o=$(s[d])).attr("id").split("_"),b=p[p.length-1];if("shifts"===b||"absences"===b||"total_time"===b||"total_time_wage"===b)var g="-1";else g=Global.strToDate(b,this.full_format).getMonth();if(Global.isSet(h)){var f=Global.strToDate(u,this.full_format).format("MMM");if(g===h&&d!==r-1)m+=1;else if(d===r-1?g===h||isNaN(g)?(m+=1,(_=i.clone()).children(0).text(f),_.attr("colspan",m),a.append(_)):(_.children(0).text(f),_.attr("colspan",m),a.append(_),h=g,u=b,m=1,(_=i.clone()).children(0).text(f),_.attr("colspan",m),a.append(_)):((_=i.clone()).children(0).text(f),_.attr("colspan",m),a.append(_),h=g,u=b,m=1),"-1"===g){(_=i.clone()).children(0).text(""),_.attr("colspan",r-d),a.append(_);break}}else h=g,u=b,m=1}}}setMonthDateRowPosition(){if(this.getMode()===l.MONTH){var e=this;this.month_date_row_position={};var t=0;for(var i in this.month_date_row_tr_ids)this.month_date_row_position[t]=this.grid.grid.find("#"+i).position().top,t+=1;this.grid.grid.parent().parent().scroll((function(){var t=$(this).scrollTop(),i=e.start_date.getDay();if(t<e.month_date_row_position[0]&&0!==e.month_current_header_number){e.month_date_row_tr_ids={},e.month_current_header_number=0;for(var a=0;a<7;a++){var s=new Date(new Date(e.start_date.getTime()).setDate(e.start_date.getDate()+a)).format(e.weekly_format),r=$(e.el).find("#"+e.ui_id+"_grid_"+l),l=(i+a)%7;$(e.el).find("#jqgh_"+e.ui_id+"_grid_"+l).text(s),r.removeClass("highlight-header")}e.highLightSelectDay()}else t>e.month_date_row_position[0]&&t<e.month_date_row_position[1]&&1!==e.month_current_header_number?d(0,1):t>e.month_date_row_position[1]&&t<e.month_date_row_position[2]&&2!==e.month_current_header_number?d(1,2):t>e.month_date_row_position[2]&&t<e.month_date_row_position[3]&&3!==e.month_current_header_number?d(2,3):t>e.month_date_row_position[3]&&4!==e.month_current_header_number&&d(3,4);function d(t,a){e.month_date_row_tr_ids={},e.month_current_header_number=a;for(var s=e.month_date_row_array[t],r=0;r<7;r++){var l=(i+r)%7,d=$(e.el).find("#jqgh_"+e.ui_id+"_grid_"+l),o=$(e.el).find("#"+e.ui_id+"_grid_"+l);o.removeClass("highlight-header");var _=s[l+"_full_date"];$(e.el).find("#"+e.ui_id+"_grid_"+_).hasClass("highlight-header")&&o.addClass("highlight-header"),d.html(s[l])}}}))}}setGridHeight(){var e=$("body").height();if(e-=$("#topContainer").height(),e-=$(".search-panel").height(),e-=$(".control-bar").height(),e-=this.grid.grid.parents(".ui-jqgrid-jquery-ui").find(".ui-jqgrid-htable").height(),e-=55,this.getMode()!=l.DAY){var t=$(".schedule-view .grid-div .ui-jqgrid-bdiv");t&&t.length>0&&t[0].scrollWidth>$(".view").width()+2&&(e-=15)}return this.grid.setGridHeight(e),e}setGridColumnsWidth(){switch(this.getMode()){case l.DAY:var e,t=10,i=this.schedule_source;for(var a in this.schedule_columns)if(1==this.schedule_columns[a].is_static_size||"scrollbar_spacer"==this.schedule_columns[a].name)this.schedule_columns[a].fixed=!0,"scrollbar_spacer"!=this.schedule_columns[a].name&&(e=a);else{var s=Global.calculateTextWidth(this.schedule_columns[a].label)+t;if(i&&i.length>0)for(var r in i){(n=Global.calculateTextWidth(i[r][this.schedule_columns[a].name]))>s&&(s=n)}this.schedule_columns[a].width=s,this.schedule_columns[a].fixed=!0}this.calculateScheduleWidth(),$(".day_hour_div .day_hour_span").width(this.day_hour_width);var d=this.day_hour_width*$(".day_hour_div .day_hour_span").length;this.schedule_columns[e].width=d,this.grid.setGridColumnsWidth(this.schedule_columns),this.grid.setGridWidth($(".view").width());break;default:t=10;var o=0,_=$(".view").width();i=this.schedule_source;for(var a in this.schedule_columns){if(!this.schedule_columns[a].is_static_size||0==this.schedule_columns[a].is_static_size){s=Global.calculateTextWidth(this.schedule_columns[a].label,{padding:t});if(i&&i.length>0)for(var r in i){var n;(n=Global.calculateTextWidth(i[r][this.schedule_columns[a].name],{padding:t}))>s&&(s=n)}this.schedule_columns[a].width=s,this.schedule_columns[a].fixed=!0}o+=this.schedule_columns[a].width}this.schedule_columns[0]&&o<_&&(this.schedule_columns[0].width+=_-o),this.grid.setGridColumnsWidth(this.schedule_columns),this.getMode()==l.YEAR&&this.setYearGroupHeader()}this.setGridHeight()}buildScheduleSource(){this.no_date_array=[],this.has_date_array=[],this.final_schedule_data_array=[];var e=this.getMode();this.no_date_array=this.buildNoDateArray(),this.has_date_array=this.buildHasDateArray();this.has_date_array.length;var t=this.buildSortFields();switch(this.has_date_array.sort(Global.m_sort_by(t)),this.no_date_array.sort(Global.m_sort_by(t)),e!==l.MONTH&&(this.final_schedule_data_array=this.no_date_array.concat(this.has_date_array)),this.getMode()){case l.WEEK:this.buildWeeklySource();break;case l.MONTH:this.buildMonthSource();break;case l.YEAR:this.buildYearlySource();break;case l.DAY:this.buildDailySource()}}buildShiftKey(e){for(var t="",i=0;i<this.shift_key_name_array.length;i++){var a=this.shift_key_name_array[i],s=this.shift_key_name_array[i].replace("_id","");t="user"!==s?e[s]?e[a]+"-"+t:"0-"+t:e[a]+"-"+t}return t}buildMonthSource(){for(var e=this,t=0,i=0,a=this.month_date_row_array[t],s=this.start_date.getDay(),l=a[s+"_time"],d=[],o=this.has_date_array.slice(),_=0;_<5;_++){for(var n=[],c=o.length,h=!1,u=0;u<c;u++){var m=o[u];Global.strToDate(m.date_stamp).getTime()<l&&(o.splice(u,1),u-=1,c-=1,n.push(m))}if(this.all_employee_btn.getValue())if(0===_)n=this.no_date_array.slice().concat(n);else n=this.buildMonthWeekNoDateArray(n).slice().concat(n);if(d[i]=n,t>2?h=!0:2!==t||this.month_date_row_array[3].hasOwnProperty(0)||(h=!0),h){i+=1;var p=this.getLastDateOfRow(this.month_date_row_array[t]),b=new Date(p);l=new Date(b.setDate(b.getDate()+1)).getTime()}else t+=1,i+=1,l=(a=this.month_date_row_array[t])[s+"_time"]}function g(t,i){if(i.length<1)f(t);else{var a={},s=i.length,r=!1;if(t===e.month_date_row_array.length-1)r=!0;else var l=e.month_date_row_array[t+1],d=0;for(var o=0;o<s;o++){var _,n=i[o];if(n.date_stamp)_=Global.strToDate(n.date_stamp).getDay();var c=e.buildShiftKey(n);if(a[c]){for(var h=!1,u=0;u<a[c].length;u++){var m=a[c][u];if(!(p=e.schedule_source[m])[_]){_>=0&&(20==n.status_id?p[_]=e.getAbsenceCellValue(n):p[_]=n.start_time+" - "+n.end_time,p[_+"_data"]=n),h=!0;break}}if(!h){(p={}).user_full_name=n.user_full_name,p.last_name=n.last_name,p.user_id=n.user_id,p.branch_id=n.branch_id,p.department_id=n.department_id,p.schedule_policy_id=n.schedule_policy_id,p.job_id=n.job_id,p.job_item_id=n.job_item_id,g=(b=e.select_layout.data.display_columns).length;for(v=0;v<g;v++)p[y=b[v]]=n[y]?n[y]:"";_>=0&&(20==n.status_id?p[_]=e.getAbsenceCellValue(n):p[_]=n.start_time+" - "+n.end_time,p[_+"_data"]=n),r?(e.schedule_source.push(p),a[c].push(e.schedule_source.length-1)):(d=e.schedule_source.indexOf(l),e.schedule_source.splice(d,0,p),a[c].push(d))}}else{var p={};p.user_full_name=n.user_full_name,p.last_name=n.last_name,p.user_id=n.user_id,p.branch_id=n.branch_id,p.department_id=n.department_id,p.schedule_policy_id=n.schedule_policy_id,p.job_id=n.job_id,p.job_item_id=n.job_item_id;for(var b=e.select_layout.data.display_columns,g=b.length,v=0;v<g;v++){var y=b[v];p[y]=n[y]?n[y]:""}_>=0&&(20==n.status_id?p[_]=e.getAbsenceCellValue(n):p[_]=n.start_time+" - "+n.end_time,p[_+"_data"]=n),r?(e.schedule_source.push(p),a[c]=[e.schedule_source.length-1]):(d=e.schedule_source.indexOf(l),e.schedule_source.splice(d,0,p),a[c]=[d])}}i.length>0&&f(t,!0)}}function f(t,i){if(i&&(t+=1),-1===t)var a=0;else{var s=e.month_date_row_array[t];a=i?s?e.schedule_source.indexOf(s):e.schedule_source.length:e.schedule_source.indexOf(s)+1}var l=e.getEmptyWeeklyRow();l.type=r.EMPTY,e.schedule_source.splice(a,0,l)}g(-1,d[0]),g(0,d[1]),g(1,d[2]),g(2,d[3]),g(3,d[4]),this.showDailyTotal(),this.showWeeklyTotal()}buildYearlySource(){var e=this,t={};this.schedule_source=[];var i=this.final_schedule_data_array.length;if(i<1)!function(){var t={user_full_name:"",last_name:"",user_id:"",branch_id:""};t.type=r.EMPTY,e.schedule_source.push(t)}();else{for(var a=0;a<i;a++){var s=this.final_schedule_data_array[a],l="";if(s.date_stamp)l=Global.strToDate(s.date_stamp).format(this.full_format);var d=this.buildShiftKey(s);if(t[d]){for(var o=!1,_=0;_<t[d].length;_++){var n=t[d][_];if(!(c=this.schedule_source[n])[l]){l&&(c[l]=10==s.status_id?"S":"A",c[l+"_data"]=s),o=!0;break}}if(!o){(c={}).user_full_name=s.user_full_name,c.last_name=s.last_name,c.user_id=s.user_id,c.branch_id=s.branch_id,c.department_id=s.department_id,c.schedule_policy_id=s.schedule_policy_id,c.job_id=s.job_id,c.job_item_id=s.job_item_id,u=(h=this.select_layout.data.display_columns).length;for(m=0;m<u;m++)c[p=h[m]]=s[p]?s[p]:"";l&&(c[l]=10==s.status_id?"S":"A",c[l+"_data"]=s),this.schedule_source.push(c),t[d].push(this.schedule_source.length-1)}}else{var c={};c.user_full_name=s.user_full_name,c.last_name=s.last_name,c.user_id=s.user_id,c.branch_id=s.branch_id,c.department_id=s.department_id,c.schedule_policy_id=s.schedule_policy_id,c.job_id=s.job_id,c.job_item_id=s.job_item_id;for(var h=this.select_layout.data.display_columns,u=h.length,m=0;m<u;m++){var p=h[m];c[p]=s[p]?s[p]:""}l&&(c[l]=10==s.status_id?"S":"A",c[l+"_data"]=s),this.schedule_source.push(c),t[d]=[this.schedule_source.length-1]}}this.showWeeklyTotal()}}buildDailyHeaders(){var e=this,t=this.schedule_columns[this.select_layout.data.display_columns.length+1],i=-1,a=-1,s="",r="",l="",d="",o=this.has_date_array.length;if(0===o){var _=this.api.getScheduleDefaultData({async:!1}).getResult(),n=e.getSelectDate();return s=n+" "+_.start_time,r=n+" "+_.end_time,void u()}for(var c=0;c<o;c++){var h=this.has_date_array[c];(-1===i||h.start_time_stamp<i)&&(i=h.start_time_stamp,s=h.start_date,l=h.start_time),(-1===a||h.end_time_stamp>a)&&(a=h.end_time_stamp,r=h.end_date,d=h.end_time)}function u(){var i=new Date(Global.strToDateTime(s).getTime()-36e5);r=Global.strToDateTime(r);var a=6e4*i.getMinutes(),l=$("<div class='day_hour_span'></div>");a>0&&(i=new Date(i.getTime()-a)),e.day_mode_start_date_time=i;var d=(r.getTime()-i.getTime())/36e5,o=$("<div class='day_hour_div'></div>"),_=$("<div class='day-column'></div>"),n=e.start_date.format(e.weekly_format);n=e.setHolidayHeader(n,!0),_.text(n);for(var c=$('<div style="padding:0px !important"></div>'),h="",u="hA",m=0;m<d;m++){var p=l.clone();p=p.text(i.format(u)),m<d-1?h=h+i.format(u)+"|":h+=i.format(u),c.append(p),i=new Date(i.getTime()+36e5)}o.append(_),o.append(c),e.buildTotalShiftDic(h),t.label=o[0].outerHTML,t.width=e.day_hour_width*d+40,e.day_header_width=t.width}s=Global.getStandardDateTimeStr(s,l),r=Global.getStandardDateTimeStr(r,d),u()}buildTotalShiftDic(e){var t=e.split("|");this.total_shifts_dic={};for(var i=0;i<t.length;i++){var a={sort_order:i,key:t[i],value:0};this.total_shifts_dic[t[i]]=a}}buildDailySource(){var e=this;this.buildDailyHeaders();var t={};this.schedule_source=[];var i=this.final_schedule_data_array.length;if(i<1)!function(){var t=e.getEmptyWeeklyRow();t.type=r.EMPTY,e.schedule_source.push(t)}();else{for(var a=0;a<i;a++){var s=this.final_schedule_data_array[a],l="";if(s.date_stamp)l=Global.strToDate(s.date_stamp).format(this.full_format);var d=this.buildShiftKey(s);if(t[d]){for(var o=!1,_=0;_<t[d].length;_++){var n=t[d][_];if(!(c=this.schedule_source[n])[l]){l&&(20==s.status_id?c[l]=e.getAbsenceCellValue(s):c[l]=s.start_time+" - "+s.end_time,c[l+"_data"]=s),o=!0;break}}if(!o){(c={}).user_full_name=s.user_full_name,c.last_name=s.last_name,c.user_id=s.user_id,c.branch_id=s.branch_id,c.department_id=s.department_id,c.schedule_policy_id=s.schedule_policy_id,c.job_id=s.job_id,c.job_item_id=s.job_item_id,c.total=Global.getTimeUnit(s.total_time),u=(h=this.select_layout.data.display_columns).length;for(m=0;m<u;m++){c[p=h[m]]=s[p]?s[p]:""}l&&(20==s.status_id?c[l]=e.getAbsenceCellValue(s):c[l]=s.start_time+" - "+s.end_time,c[l+"_data"]=s),this.schedule_source.push(c),t[d].push(this.schedule_source.length-1)}}else{var c={};c.user_full_name=s.user_full_name,c.last_name=s.last_name,c.user_id=s.user_id,c.branch_id=s.branch_id,c.department_id=s.department_id,c.schedule_policy_id=s.schedule_policy_id,c.job_id=s.job_id,c.job_item_id=s.job_item_id,c.total=Global.getTimeUnit(s.total_time);for(var h=this.select_layout.data.display_columns,u=h.length,m=0;m<u;m++){var p;c[p=h[m]]=s[p]?s[p]:""}l&&(20==s.status_id?c[l]=e.getAbsenceCellValue(s):c[l]=s.start_time+" - "+s.end_time,c[l+"_data"]=s),this.schedule_source.push(c),t[d]=[this.schedule_source.length-1]}}this.showDailyTotal()}}buildWeeklySource(){var e=this,t={};this.schedule_source=[];var i=this.final_schedule_data_array.length;if(i<1)!function(){var t=e.getEmptyWeeklyRow();t.type=r.EMPTY,e.schedule_source.push(t)}();else{for(var a=0;a<i;a++){var s=this.final_schedule_data_array[a],l="";if(s.date_stamp){var d=Global.strToDate(s.date_stamp);l=d?d.format(this.full_format):null}var o=this.buildShiftKey(s);if(t[o]){for(var _=!1,n=0;n<t[o].length;n++){var c=t[o][n];if(!(h=this.schedule_source[c])[l]){l&&(20==s.status_id?h[l]=e.getAbsenceCellValue(s):h[l]=s.start_time+" - "+s.end_time,h[l+"_data"]=s),_=!0;break}}if(!_){(h={}).user_full_name=s.user_full_name,h.last_name=s.last_name,h.user_id=s.user_id,h.branch_id=s.branch_id,h.department_id=s.department_id,h.schedule_policy_id=s.schedule_policy_id,h.job_id=s.job_id,h.job_item_id=s.job_item_id,m=(u=this.select_layout.data.display_columns).length;for(p=0;p<m;p++)h[b=u[p]]=s[b]?s[b]:"";l&&(20==s.status_id?h[l]=e.getAbsenceCellValue(s):h[l]=s.start_time+" - "+s.end_time,h[l+"_data"]=s),this.schedule_source.push(h),t[o].push(this.schedule_source.length-1)}}else{var h={};h.user_full_name=s.user_full_name,h.last_name=s.last_name,h.user_id=s.user_id,h.branch_id=s.branch_id,h.department_id=s.department_id,h.schedule_policy_id=s.schedule_policy_id,h.job_id=s.job_id,h.job_item_id=s.job_item_id;for(var u=this.select_layout.data.display_columns,m=u.length,p=0;p<m;p++){var b=u[p];h[b]=s[b]?s[b]:""}l&&(20==s.status_id?h[l]=e.getAbsenceCellValue(s):h[l]=s.start_time+" - "+s.end_time,h[l+"_data"]=s),this.schedule_source.push(h),t[o]=[this.schedule_source.length-1]}}this.showDailyTotal(),this.showWeeklyTotal()}}getAbsenceCellValue(e){return e.absence_policy?e.note?"*"+e.absence_policy:e.absence_policy:e.note?"*N/A":"N/A"}buildSortFields(){var e=[];if(this.select_layout&&this.select_layout.data){var t=this.select_layout.data.display_columns;t.length>0&&(e=t.slice())}return e.push("user_full_name"),e.push({name:"start_time_stamp",primer:parseFloat,reverse:!1}),e}buildMonthWeekNoDateArray(e){for(var t={},i=[],a=0,s=e.length;a<s;a++){t[(l=Global.clone(e[a])).user_id]=!0}for(var r in this.all_user_map){var l;if(!t[r])(l=Global.clone(this.all_user_map[r])).date_stamp=!1,i.push(l)}return i}buildNoDateArray(){var e,t=[],i=[],a=this.full_schedule_data.schedule_data;for(var s in a)(e={}).value=a[s],e.sort_key=s,i.push(e);for(var r=i.length,l=0;l<r;l++){var d=i[l];for(var o in d.value){var _=d.value[o];(_=this.replaceFalseToEmptyStringForSortFields(_)).date_stamp||t.push(d.value[o])}}return t}buildHasDateArray(){var e=[];this.all_user_map={};var t,i=[],a=this.full_schedule_data.schedule_data;for(var s in a)(t={}).value=a[s],t.sort_key=s,i.push(t);for(var r=i.length,l=0;l<r;l++){var d=i[l];for(var o in d.value){var _=d.value[o];_=this.replaceFalseToEmptyStringForSortFields(_),this.all_user_map[_.user_id]=Global.clone(_),_.date_stamp&&e.push(d.value[o])}}return e}replaceFalseToEmptyStringForSortFields(e){return e.branch||(e.branch=""),e.department||(e.department=""),e.default_branch||(e.default_branch=""),e.default_department||(e.default_department=""),e.job||(e.job=""),e.job_item||(e.job_item=""),e.title||(e.title=""),e}checkIsSelectedCell(e,t){for(var i=0,a=this.select_cells_Array.length;i<a;i++){var s=this.select_cells_Array[i];if(s.row_id.toString()===e.toString()&&s.cell_index.toString()===t.toString())return!0}return!1}buildScheduleGrid(){var e=this,t="grid";this.grid?(this.grid.grid.jqGrid("GridUnload",!0),delete this.grid,this.grid=null):($(this.el).find("#grid").attr("id",this.ui_id+"_grid"),t=this.ui_id+"_grid"),t=this.ui_id+"_grid",this.schedule_columns&&0!=this.schedule_columns.length||this.buildScheduleColumns(),this.grid=new TTGrid(t,{draggble:!0,altRows:!0,data:[],datatype:"local",sortable:!1,scrollOffset:0,rowNum:1e4,hoverrows:!1,multiselectPosition:"none",ondblClickRow:function(){e.onGridDblClickRow()},onSelectRow:function(e,t,i){return $(this).find("#"+e).removeClass("ui-state-highlight").attr("aria-selected",!0),!1},onRightClickRow:function(t,i,a,s){if(!e.checkIsSelectedCell(t,a)){var r=$(s.target).closest("td,th").html();$(this).find("#"+t).removeClass("ui-state-highlight").attr("aria-selected",!0),e.onCellSelect("timesheet_grid",t,a,r,this,s)}},onCellSelect:function(t,i,a,s){e.onCellSelect("timesheet_grid",t,i,a,this,s)},colNames:[],viewrecords:!0,winMultiSelect:!1,setGridSize:function(){e.setGridHeight()},onResizeGrid:function(){e.onResizeGrid()}},this.schedule_columns),this.grid.grid.parent().parent().scrollLeft(1e3),this.grid.grid.parent().parent().scroll((function(t){e.scroll_position=$(t.target).scrollTop()})),this.bindGridColumnEvents()}onResizeGrid(){this.getMode()==l.DAY?this.buildCalendars():this.setGridColumnsWidth(),this.setGridHeight()}bindGridColumnEvents(){var e=this.grid.getGridParam("colModel");if(e){var t=e.length;this.t_grid_header_array=[];for(var i=0;i<t;i++){var a=e[i],s=$($(this.el).find("#gbox_"+this.ui_id+"_grid").find("div #jqgh_"+this.ui_id+"_grid_"+a.name));this.t_grid_header_array.push(s.TGridHeader()),s.bind("click",d)}var r=this}function d(e){var t=$(this).attr("id");if("cb"!==(t=t.substring(10+r.ui_id.length+1,t.length))&&"punch_info"!==t){var i;if(r.getMode()===l.MONTH){var a=r.grid.getGridParam("colModel");i=r.getCellRelatedDate(1,a,$(this).parent().index(),t)}else i=Global.strToDate(t,r.full_format);i&&i.getYear()>0&&(r.setDatePickerValue(i.format(Global.getLoginUserDateFormat())),r.highLightSelectDay())}}}buildMonthCell(e,t,i,a){var s=this.grid.getGridParam("colModel"),l=t.colModel,d=$("<div class='schedule-content-div'></div>");a&&d.addClass("date-column");var o=$("<span class='schedule-time' ></span>"),_=i[l.name+"_data"],n=i[l.name+"_full_date"];switch(i.type){case r.TOTAL:if(o=$("<span class='schedule-time total'></span>"),-1===this.select_layout.data.display_columns.indexOf(l.index)&&-1===["user_full_name","shifts","absences","total_time","total_time_wage"].indexOf(l.index)){if(!e)e={shifts:0,absences:0,total_time:0,total_time_wage:0};var c=$("<span class='schedule-time total'></span>"),h=LocalCacheData.getCurrentCurrencySymbol();o.text("S: "+e.shifts+" A: "+e.absences),c.text(Global.getTimeUnit(e.total_time)+" = "+h+Global.MoneyRound(e.total_time_wage)),d.prepend(c),d.prepend(o),d.css("height","auto")}else o.text(e),d.prepend(o),t.pos===s.length-1&&d.css("padding-right","15px");break;case r.DATE:o.addClass("date"),d.addClass("month-date-cell"),e?(o.html(e),d.attr("id",this.ui_id+"_grid_"+n)):(o.addClass("empty-date"),o.text(".")),d.prepend(o);break;case r.EMPTY:Global.isSet(e)||o.text(""),o.addClass("empty"),d.prepend(o);break;default:Global.isSet(_)&&((!Global.isSet(_.id)||!_.id||_.id&&_.id==TTUUID.zero_id)&&o.addClass("no-id"),20==_.status_id&&o.addClass("red"),_.user_id===TTUUID.zero_id&&d.addClass("yellow-outline")),Global.isSet(e)?(Global.isSet(_)&&_.note&&-1==e.indexOf("*")&&(e="*"+e),o.text(e),t.pos===s.length-1&&d.css("padding-right","15px")):o.text(""),d.prepend(o)}return d.get(0).outerHTML}buildYearCell(e,t,i,a){this.grid.getGridParam("colModel");var s=t.colModel,l=$("<div class='schedule-content-div'></div>");if(e&&1==e.length&&i.user_full_name==$.i18n._("OPEN")&&l.addClass("yellow-outline"),a&&l.addClass("date-column"),!e)return l.get(0).outerHTML;var d=$("<span class='schedule-time'></span>"),o=i[s.name+"_data"];switch(i.type){case r.EMPTY:d.addClass("empty"),l.prepend(d);break;default:s.index>=0&&("A"===e?d.addClass("absence-cell"):o&&(!o.id||o.id&&o.id==TTUUID.zero_id)&&d.addClass("no-id")),Global.isSet(e)?d.text(e):d.text(""),l.prepend(d)}return l[0].outerHTML}calculateScheduleWidth(){var e=0;for(var t in this.schedule_columns)this.schedule_columns[t].is_static_size&&"total"!=this.schedule_columns[t].name&&"scrollbar_spacer"!=this.schedule_columns[t].name||(e+=this.schedule_columns[t].width);return this.day_hour_width=($(".view").innerWidth()-e)/$(".day_hour_div .day_hour_span").length,Debug.Text("Day Hour Width: "+this.day_hour_width+" Static Width: "+e,"ScheduleViewController.js","ScheduleViewController","calculateScheduleWidth",10),this.day_hour_width<40&&(this.day_hour_width=40),this.day_hour_width}buildDayCell(e,t,i,a){var s=t.colModel,l=$("<div class='schedule-content-div'></div>");a&&l.addClass("date-column");var d=$("<span class='schedule-time'></span>"),o=i[s.index+"_data"];switch(i.type){case r.TOTAL:if(e&&Global.isSet(e.total_time)){var _=$("<div  style='text-align: left'></div>"),n=LocalCacheData.getCurrentCurrencySymbol();if((d=$("<span class='schedule-time total'></span>")).text("S: "+e.shifts+" A: "+e.absences+" "+Global.getTimeUnit(e.total_time)+" = "+n+e.total_time_wage),l.prepend(d),e.total_shifts_dic){var c=[];for(var h in e.total_shifts_dic)c.push(e.total_shifts_dic[h]);c=c.sort((function(e,t){return Global.compare(e,t,"sort_order")}));for(var u=0;u<c.length;u++){o=c[u];var m=$('<span class="day_hour_span"></span>');m.text(o.value),m.width(this.day_hour_width),_.append(m)}l.prepend(_)}l.css("height","auto")}else e?((d=$("<span class='schedule-time total'></span>")).text(e),l.prepend(d)):1==s.display_total_column&&(n=LocalCacheData.getCurrentCurrencySymbol(),(d=$("<span class='schedule-time total'></span>")).text("S: 0 A: 0 00:00 = "+n+"0.00"),l.prepend(d),l.css("height","auto"));break;case r.EMPTY:Global.isSet(e)||d.text(""),d.addClass("empty"),l.prepend(d);break;default:if(Global.isSet(o)){l.removeClass("schedule-content-div").addClass("schedule-content-day-div"),t.rowId%2==0?d.removeClass("schedule-time").addClass("schedule-day-time even"):d.removeClass("schedule-time").addClass("schedule-day-time");var p=this.getDayShiftWidth(o);d.width(p),d.css("left",this.getDayShiftOffset(o)),Global.isSet(o.id)&&o.id&&o.id!=TTUUID.zero_id||d.addClass("no-day-id"),20==o.status_id&&(d.removeClass("even"),d.addClass("red-bg")),o.user_id===TTUUID.zero_id&&l.addClass("yellow-outline")}Global.isSet(e)?(Global.isSet(o)&&o.note&&-1==e.indexOf("*")&&(e="*"+e),d.text(e)):d.text(""),l.prepend(d)}return l.get(0).outerHTML}getDayShiftOffset(e){return(Global.strToDateTime(Global.getStandardDateTimeStr(e.start_date,e.start_time)).getTime()-this.day_mode_start_date_time.getTime())/36e5*this.day_hour_width}getDayShiftWidth(e){var t=Global.strToDateTime(Global.getStandardDateTimeStr(e.start_date,e.start_time));return(Global.strToDateTime(Global.getStandardDateTimeStr(e.end_date,e.end_time)).getTime()-t.getTime())/36e5*this.day_hour_width}buildWeekCell(e,t,i,a){var s=this.grid.getGridParam("colModel"),l=t.colModel,d=$("<div class='schedule-content-div'></div>");a&&d.addClass("date-column");var o=$("<span class='schedule-time'></span>"),_=i[l.index+"_data"];switch(i.type){case r.TOTAL:if(o=$("<span class='schedule-time total'></span>"),-1===this.select_layout.data.display_columns.indexOf(l.index)&&-1===["user_full_name","shifts","absences","total_time","total_time_wage"].indexOf(l.index)){if(!e)e={shifts:0,absences:0,total_time:0,total_time_wage:0};var n=$("<span class='schedule-time total'></span>"),c=LocalCacheData.getCurrentCurrencySymbol();o.text("S: "+e.shifts+" A: "+e.absences),n.text(Global.getTimeUnit(e.total_time)+" = "+c+Global.MoneyRound(e.total_time_wage)),d.prepend(n),d.prepend(o),d.css("height","auto")}else o.text(e),d.prepend(o),t.pos===s.length-1&&d.css("padding-right","15px");break;case r.EMPTY:Global.isSet(e)||o.text(""),o.addClass("empty"),d.prepend(o);break;default:Global.isSet(_)&&((!Global.isSet(_.id)||!_.id||_.id&&_.id==TTUUID.zero_id)&&o.addClass("no-id"),20==_.status_id&&o.addClass("red"),_.user_id===TTUUID.zero_id&&d.addClass("yellow-outline")),Global.isSet(e)?(Global.isSet(_)&&_.note&&-1==e.indexOf("*")&&(e="*"+e),t.pos===s.length-1&&d.css("padding-right","15px"),o.text(e)):o.text(""),d.prepend(o)}return d.get(0).outerHTML}onCellFormat(e,t,i){var a=!0;if("user_full_name"==t.colModel.index)a=!1;else for(var s in this.all_columns)if(t.colModel.label==this.all_columns[s].label){a=!1;break}switch(this.getMode()){case l.WEEK:return this.buildWeekCell(e,t,i,a);case l.MONTH:return this.buildMonthCell(e,t,i,a);case l.YEAR:return this.buildYearCell(e,t,i,a);case l.DAY:return this.buildDayCell(e,t,i,a)}return""}onSelectRow(e,t,i){var a=$(i).find("#"+t);a.removeClass("ui-state-highlight").attr("aria-selected",!0);var s=this.select_cells_Array,r=this.select_cells_Array.length;this.select_all_shifts_array=[],this.select_shifts_array=[],this.select_recurring_shifts_array=[],this.select_cellls_and_shifts_array=[];for(var l=0;l<r;l++){var d=s[l];a=$(i).find("#"+d.row_id),$(a.find("td")[d.cell_index]).addClass("ui-state-highlight").attr("aria-selected",!0),d.row_id=d.row_id-0,d.shift?(Global.isSet(d.shift.start_date)?d.shift.start_date_num=Global.strToDateTime(d.shift.start_date).getTime():d.shift.start_date_num=d.time_stamp_num,d.shift.row_index=d.row_id-1,d.shift.cell_index=d.cell_index-1,d.shift.orginal_row_index=d.row_id,d.shift.orginal_cell_index=d.cell_index,this.select_all_shifts_array.push(d.shift),this.select_cellls_and_shifts_array.push(d),d.shift.id&&d.shift_id!=TTUUID.zero_id?this.select_shifts_array.push(d.shift):this.select_recurring_shifts_array.push(d.shift),this.select_all_shifts_array.sort((function(e,t){if(e.cell_index<t.cell_index)return-1;if(e.cell_index>t.cell_index)return 1;if(e.cell_index===t.cell_index){if(e.row_index<t.row_index)return-1;if(e.row_index>t.row_index)return 1}return 0}))):this.select_cellls_and_shifts_array.push(d),this.select_cellls_and_shifts_array.sort((function(e,t){if(e.cell_index<t.cell_index)return-1;if(e.cell_index>t.cell_index)return 1;if(e.cell_index===t.cell_index){if(e.row_id<t.row_id)return-1;if(e.row_id>t.row_id)return 1}return 0}))}this.setDefaultMenu()}getCellRelatedDate(e,t,i,a){var s,r=this.schedule_source.indexOf(this.month_date_row_array[0]),l=this.schedule_source.indexOf(this.month_date_row_array[1]),d=this.schedule_source.indexOf(this.month_date_row_array[2]),o=this.schedule_source.indexOf(this.month_date_row_array[3]);return e<r?s=Global.strToDate(t[i].index,this.full_format):e>=r&&e<l?s=Global.strToDate(this.month_date_row_array[0][a+"_full_date"],this.full_format):e>=l&&e<d?s=Global.strToDate(this.month_date_row_array[1][a+"_full_date"],this.full_format):e>=d&&e<o?s=Global.strToDate(this.month_date_row_array[2][a+"_full_date"],this.full_format):e>=o&&(s=Global.strToDate(this.month_date_row_array[3][a+"_full_date"],this.full_format)),s}getDataByCellIndex(e,t){var i=this.schedule_source[e],a=this.grid.getGridParam("colModel");return a&&a[t]&&i?i[a[t].name+"_data"]:null}onCellSelect(e,t,i,a,s,r){if($("#ribbon_view_container .context-menu:visible a").click(),!(i<0)){var d,o,_,n,c,h,u=this,m=[],p=this.getMode();m=u.select_cells_Array,d=u.select_cells_Array.length,o=u.schedule_source[t-1];var b=u.schedule_source.indexOf(o);c=o[(n=(_=u.grid.getGridParam("colModel"))[i].name)+"_data"],(!(h=p===l.MONTH?u.getCellRelatedDate(b,_,i,n):Global.strToDate(n,this.full_format))||h.getTime()<-1)&&(h=new Date);for(var g=0;g<d;g++){var f=m[g],v=$(s).find("#"+f.row_id),y=$(v.find("td")[f.cell_index]);y.removeClass("ui-state-highlight").attr("aria-selected",!1)}if(h)var w=h.format(),T=Global.strToDate(w).getTime();else w="",T=0;if(r.ctrlKey||r.metaKey){var C=!1;for(g=0;g<d;g++)if(f=m[g],parseInt(t)===f.row_id&&i===f.cell_index){m.splice(g,1),C=!0;break}C||(m.push({row_id:t,cell_index:i,cell_val:a,shift:c,date:w,time_stamp_num:T,user_id:o.user_id,branch_id:o.branch_id,department_id:o.department_id,job_id:o.job_id,job_item_id:o.job_item_id}),u.select_cells_Array=m,this.select_cells_Array.sort((function(e,t){return Global.compare(e,t,"time_stamp_num")})))}else if(r.shiftKey){var D=t,I=i,A=t,S=i;for(g=0;g<d;g++)f=m[g],parseInt(f.row_id)<parseInt(D)?D=f.row_id:parseInt(f.row_id)>parseInt(A)&&(A=f.row_id),parseInt(f.cell_index)<parseInt(I)?I=f.cell_index:parseInt(f.cell_index)>parseInt(S)&&(S=f.cell_index);m[m.length-1]&&m[0]&&m[m.length-1].cell_index>=i&&m[0].cell_index<=i&&m[m.length-1].row_id>=t&&m[0].row_id<=t&&(A=t,S=i),D=parseInt(D),A=parseInt(A),m=[];for(g=D;g<=A;g++)for(var x=g,M=I;M<=S;M++){var k=M;v=$(s).find("#"+x),a=(y=$(v.find("td")[k]))[0].outerHTML,o=u.schedule_source[x-1],b=u.schedule_source.indexOf(o),c=o[(n=(_=u.grid.getGridParam("colModel"))[k].name)+"_data"],(h=p===l.MONTH?u.getCellRelatedDate(b,_,k,n):Global.strToDate(n,this.full_format))&&h.getTime()>0?(w=h.format(),T=Global.strToDate(w).getTime()):(w="",T=0),m.push({row_id:x.toString(),cell_index:k,cell_val:a,shift:c,date:w,time_stamp_num:T,user_id:o.user_id,branch_id:o.branch_id,department_id:o.department_id,job_id:o.job_id,job_item_id:o.job_item_id})}u.select_cells_Array=m,this.select_cells_Array.sort((function(e,t){return Global.compare(e,t,"time_stamp_num")}))}else m=[{row_id:t,cell_index:i,cell_val:a,shift:c,date:w,time_stamp_num:T,user_id:o.user_id,branch_id:o.branch_id,department_id:o.department_id,job_id:o.job_id,job_item_id:o.job_item_id}],u.select_cells_Array=m,h&&h.getYear()>0&&(this.setDatePickerValue(h.format(Global.getLoginUserDateFormat())),this.highLightSelectDay());u.onSelectRow(e,t,s);var E=$(s).find("#"+t),G=$(E.find("td")[i]);if(G.attr("infor_column")){var P=E.index(),V=parseInt(G.attr("rowspan"));isNaN(V)&&(V=1);var U=E.parent().children().eq(P+V-1),j=U.children().eq(U.children().length-1),R=U.attr("id"),F=U.children().length-1,B=j.find(".schedule-time").text();u.onCellSelect("timesheet_grid",R,F,B,this.grid.grid,{shiftKey:!0})}}}highLightSelectDay(){var e=this.getMode();if($(".highlight-header").removeClass("highlight-header"),e===l.MONTH){var t=Global.strToDate(this.start_date_picker.getValue()),i=t.getDay();t=t.format(this.full_format);var a=$("#"+this.ui_id+"_grid_"+i),s=$(a.children()[1]).text();this.highlight_header=$("#"+this.ui_id+"_grid_"+t),1!==this.highlight_header.length?this.highlight_header=$("#"+this.ui_id+"_grid_"+i):s===this.highlight_header.text()&&($(".highlight-header").removeClass("highlight-header"),a.addClass("highlight-header"))}else(t=Global.strToDate(this.start_date_picker.getValue()))||(t=new Date,this.setDatePickerValue(t.format())),t=t.format(this.full_format),this.highlight_header=$("#"+this.ui_id+"_grid_"+t);e!==l.DAY&&(e===l.MONTH&&this.highlight_header.parent().addClass("highlight-header"),this.highlight_header.addClass("highlight-header"))}buildAllModeCommonColumns(){var e=this;this.shift_key_name_array=["user_id"];for(var t=this.buildDisplayColumns(this.select_layout.data.display_columns),i=t.length,a=0;a<i;a++){var s=t[a],r={name:s.value,index:s.value,label:s.label,width:122,sortable:!1,title:!1,fixed:!0,resizable:!1,formatter:function(){return e.onCellFormat(arguments[0],arguments[1],arguments[2],arguments[3])},cellattr:function(e,t,i,a,s){return'class="'+a.index+'_cell" infor_column="true"'}};this.schedule_columns.push(r),this.shift_key_name_array.push(s.value+"_id")}var l={name:"user_full_name",index:"user_full_name",label:$.i18n._("Employee"),width:122,sortable:!1,title:!1,fixed:!0,resizable:!1,formatter:function(){return e.onCellFormat(arguments[0],arguments[1],arguments[2],arguments[3])},cellattr:function(e,t,i,a,s){return'class="'+a.index+'_cell" infor_column="true"'}};this.schedule_columns.push(l)}buildMonthRows(){this.end_date.getTime(),this.start_date.getTime();var e=new Date(this.start_date.getTime()).getDay();this.schedule_source=[];var t=new Date(new Date(this.start_date.getTime()).setDate(this.start_date.getDate()+7));this.month_date_row_array=[];for(var i=1,a=0;i<5;){var s=e,l=this.getEmptyWeeklyRow();l.type=r.DATE;for(var d=0;d<7;d++){var o=new Date(new Date(t.getTime()).setDate(t.getDate()+a));if(o.getTime()>this.end_date.getTime())break;l[s]=o.format(this.weekly_format),l[s]=this.setHolidayHeader(l[s]),l[s+"_full_date"]=o.format(this.full_format),l[s+"_time"]=o.getTime(),7===(s+=1)&&(s=0),a+=1}this.month_date_row_array.push(l),i+=1,this.schedule_source.push(l)}}getEmptyWeeklyRow(){for(var e={user_full_name:"",last_name:"",user_id:"",branch_id:"",department_id:"",schedule_policy_id:"",job_id:"",job_item_id:""},t=this.select_layout.data.display_columns,i=t.length,a=0;a<i;a++){e[t[a]]=""}return e}buildMonthColumns(){var e=this;this.schedule_columns=[],this.buildAllModeCommonColumns(),this.month_date_row_tr_ids={};for(var t=0;t<7;t++){var i=new Date(this.start_date.getTime()),a=new Date(i.setDate(i.getDate()+t)),s=a.getDay(),l=a.format(this.weekly_format),d=s;7===d&&(d=0),l=this.setHolidayHeader(l);var o=a.format(this.full_format),_={resizable:!1,name:d.toString(),index:o,label:l,width:150,fixed:!0,sortable:!1,title:!1,formatter:function(){return e.onCellFormat(arguments[0],arguments[1],arguments[2],arguments[3])},cellattr:function(t,i,a,s,l){a.type===r.DATE&&(e.month_date_row_tr_ids[t]=!0)},is_static_size:!0};this.schedule_columns.push(_)}this.buildWeeklyTotalColumns(),this.schedule_columns.push({name:"scrollbar_spacer",index:"scrollbar_spacer",label:"",width:15,sortable:!1,title:!1,fixed:!0,is_static_size:!0}),this.buildMonthRows()}getDayByDayNum(e){switch(e){case 0:e=$.i18n._("S");break;case 1:e=$.i18n._("M");break;case 2:e=$.i18n._("T");break;case 3:e=$.i18n._("W");break;case 4:e=$.i18n._("T");break;case 5:e=$.i18n._("F");break;case 6:e=$.i18n._("S")}return e}buildYearColumns(){var e=this;this.schedule_columns=[],this.buildAllModeCommonColumns();for(var t=new Date(this.start_date.getTime()),i=new Date(this.end_date.getTime()),a=0;t.format(this.full_format)!==i.format(this.full_format);){(t=new Date(new Date(this.start_date.getTime()).setDate(this.start_date.getDate()+a))).format(this.weekly_format);var s={name:t.format(this.full_format),index:a,label:this.getDayByDayNum(t.getDay())+"<br>"+t.getDate(),width:22,sortable:!1,title:!1,fixed:!0,is_static_size:!0,formatter:function(){return e.onCellFormat(arguments[0],arguments[1],arguments[2],arguments[3])}};this.schedule_columns.push(s),a+=1}this.schedule_columns.push({name:"scrollbar_spacer",index:a,label:"",width:15,sortable:!1,title:!1,fixed:!0,is_static_size:!0})}buildDayColumns(){var e=this;this.schedule_columns=[],this.buildAllModeCommonColumns();var t=new Date(this.start_date.getTime()),i=(t.format(this.weekly_format),t.format(this.full_format)),a={fixed:!0,resizable:!1,width:500,name:i,index:i,label:"daily_header_replace",is_static_size:!0,sortable:!1,title:!1,display_total_column:!0,formatter:function(){return e.onCellFormat(arguments[0],arguments[1],arguments[2],arguments[3])}};this.schedule_columns.push(a),a={fixed:!0,resizable:!1,width:122,name:"total",index:"total",label:"Total Time",sortable:!1,title:!1,formatter:function(){return e.onCellFormat(arguments[0],arguments[1],arguments[2],arguments[3])}},this.schedule_columns.push(a),this.schedule_columns.push({name:"scrollbar_spacer",index:"scrollbar_spacer",label:"",width:15,sortable:!1,title:!1,fixed:!0})}buildWeekColumns(){var e=this;if(this.schedule_columns=[],this.buildAllModeCommonColumns(),this.start_date){for(var t=new Date(this.start_date.getTime()),i=new Date(this.end_date.getTime()),a=0;t.format(this.full_format)!==i.format(this.full_format);){var s=(t=new Date(new Date(this.start_date.getTime()).setDate(this.start_date.getDate()+a))).format(this.weekly_format),r=t.format(this.full_format);s=this.setHolidayHeader(s);var l={resizable:!1,name:r.toString(),index:r,label:s,width:150,fixed:!0,sortable:!1,title:!1,formatter:function(){return e.onCellFormat(arguments[0],arguments[1],arguments[2],arguments[3])},is_static_size:!0};this.schedule_columns.push(l),a+=1}return this.buildWeeklyTotalColumns(),this.schedule_columns.push({name:"scrollbar_spacer",index:"scrollbar_spacer",label:"",width:15,sortable:!1,title:!1,fixed:!0,is_static_size:!0}),this.schedule_columns}}setHolidayHeader(e,t){return this.holiday_data_dic&&this.holiday_data_dic[e]&&(e=t?e+" ("+this.holiday_data_dic[e].name+")":e+"<br>"+this.holiday_data_dic[e].name),e}buildWeeklyTotalColumns(){var e=this;if(this.weekly_totals_btn.getValue()){var t={name:"shifts",index:"shifts",label:$.i18n._("Shifts"),width:50,sortable:!1,title:!1,formatter:function(){return e.onCellFormat(arguments[0],arguments[1],arguments[2],arguments[3])},fixed:!0},i={name:"absences",index:"absences",label:$.i18n._("Absences"),width:70,sortable:!1,title:!1,formatter:function(){return e.onCellFormat(arguments[0],arguments[1],arguments[2],arguments[3])},fixed:!0},a={name:"total_time",index:"total_time",label:$.i18n._("Total Time"),width:70,sortable:!1,title:!1,formatter:function(){return e.onCellFormat(arguments[0],arguments[1],arguments[2],arguments[3])},fixed:!0},s={name:"total_time_wage",index:"total_time_wage",label:$.i18n._("Wages"),width:90,sortable:!1,title:!1,formatter:function(){return e.onCellFormat(arguments[0],arguments[1],arguments[2],arguments[3])},fixed:!0};this.schedule_columns.push(t),this.schedule_columns.push(i),this.schedule_columns.push(a),this.schedule_columns.push(s)}}buildScheduleColumns(){switch(this.shift_key_name_array=["user_id"],this.schedule_columns=[],this.getMode()){case l.WEEK:this.buildWeekColumns();break;case l.MONTH:this.buildMonthColumns();break;case l.YEAR:this.buildYearColumns();break;case l.DAY:this.buildDayColumns()}}setScheduleGridRowSpan(){for(var e=this,t=this.select_layout.data.display_columns,i=t.length,a=0;a<i;a++){s(t[a])}function s(t){var i=e.grid.grid.find("[aria-describedby="+e.ui_id+"_grid_"+t+"]"),a=i.length,s=0,r=null,l=null,d=[],o=a-1;!function(){for(var e=o;e>=0;e--){var t=$(i[e]),_=$(i[e]).children().eq(0).children().eq(0).text();if(e===a-1)r=_,s+=1,l=t;else if(r!==_){r=_,l.attr("rowspan",s);for(var n=0;n<d.length;n++){var c=d[n],h=c[0];h.parentNode&&(h.style.display="none")}c=[],s=1,l=t}else if(0===e){if(s+=1,d.push(l),s>1){t.attr("rowspan",s);for(n=0;n<d.length;n++)c=d[n],(h=c[0]).parentNode&&(h.style.display="none")}}else s+=1,d.push(l),l=t}}()}s("user_full_name")}onSetSearchFilterFinished(){}onBuildBasicUIFinished(){}onBuildAdvUIFinished(){}reSetURL(){var e,t=this.getMode();t?(e="#!m="+this.viewId+"&mode="+t,Global.setURLToBrowser(Global.getBaseURL()+e)):(e="#!m="+this.viewId,Global.setURLToBrowser(Global.getBaseURL()+e)),LocalCacheData.setAllURLArgs(Global.buildArgDic(e.split("&")))}setURL(){var e="";switch(LocalCacheData.current_doing_context_action){case"new":case"edit":case"view":e=LocalCacheData.current_doing_context_action;break;case"copy_as_new":e="new"}if(this.canSetURL()){var t=this.edit_view_tab?this.edit_view_tab.find(".edit-view-tab-bar-label").children().eq(this.getEditViewTabIndex()).text():"";t=t.replace(/\/|\s+/g,"");var i=this.getMode();this.current_edit_record&&this.current_edit_record.id&&this.current_edit_record.id!=TTUUID.zero_id?(e?Global.setURLToBrowser(Global.getBaseURL()+"#!m="+this.viewId+"&mode="+i+"&a="+e+"&id="+this.current_edit_record.id+"&tab="+t):Global.setURLToBrowser(Global.getBaseURL()+"#!m="+this.viewId+"&mode="+i+"&id="+this.current_edit_record.id),Global.trackView(this.viewId,LocalCacheData.current_doing_context_action)):e?"edit"===e?Global.setURLToBrowser(Global.getBaseURL()+"#!m="+this.viewId+"&mode="+i+"&a=new&tab="+t):Global.setURLToBrowser(Global.getBaseURL()+"#!m="+this.viewId+"&mode="+i+"&a="+e+"&tab="+t):Global.setURLToBrowser(Global.getBaseURL()+"#!m="+this.viewId+"&mode="+i)}}clearSelection(){this.grid&&this.grid.grid&&this.grid.grid.jqGrid("resetSelection"),this.select_cells_Array=[],this.select_cellls_and_shifts_array=[],this.select_all_shifts_array=[],this.setDefaultMenu()}render(){var e=this;super.render();var t=$(this.el).find(".control-bar"),i=t.find(".date-chooser-div"),s=t.find(".action-chooser-div");this.start_date_picker=Global.loadWidgetByName(FormItemType.DATE_PICKER),this.start_date_picker.TDatePicker({field:"start_date"});var r=$("<span class='label'>"+$.i18n._("Date")+":</span><img class='left-arrow arrow' src="+Global.getRealImagePath("images/left_arrow.png")+"><div class='date-picker-div'></div><img class='right-arrow arrow' src="+Global.getRealImagePath("images/right_arrow.png")+">");i.append(r),i.find(".date-picker-div").append(this.start_date_picker);var d=i.find(".left-arrow"),o=i.find(".right-arrow");d.bind("click",(function(){var t,i=e.getMode(),a=e.start_date;if(e.clearSelection(),a){switch(i){case l.WEEK:a=Global.strToDate(e.getSelectDate()?e.getSelectDate():(new Date).format());t=new Date(new Date(a.getTime()).setDate(a.getDate()-7));break;case l.YEAR:t=new Date(new Date(a.getTime()).setDate(a.getDate()-56));break;case l.DAY:case l.MONTH:default:t=new Date(new Date(a.getTime()).setDate(a.getDate()-1))}e.setDatePickerValue(t.format()),e.search(!1,!0)}})),o.bind("click",(function(){var t,i=e.getMode();if(a=e.end_date){switch(e.clearSelection(),i){case l.WEEK:var a=Global.strToDate(e.getSelectDate()?e.getSelectDate():(new Date).format());t=new Date(new Date(a.getTime()).setDate(a.getDate()+7));break;case l.YEAR:t=new Date(new Date(a.getTime()).setDate(a.getDate()+56));break;case l.DAY:case l.MONTH:default:t=new Date(new Date(a.getTime()).setDate(a.getDate()+1))}e.setDatePickerValue(t.format()),e.search(!1,!0)}})),this.start_date_picker.bind("formItemChange",(function(){e.clearSelection(),e.search(!1,!0)})),$(this.search_panel.find("#layout_selector")).off("change").on("change",(function(){e.layout_changed=!0;for(var t=e.search_panel.find("#layout_selector").find("option:selected").attr("value"),i=e.search_panel.getLayoutsArray(),a=i.length,s=0;s<a;s++){var r=i[s];if(r.id==t){e.select_layout=r,e.setSelectLayout(),e.search(!1,!0);break}}Global.triggerAnalyticsNavigationOther("searchpanel:layout_change","click",e.viewId)})),this.all_employee_btn=s.find("#all_employee"),this.daily_totals_btn=s.find("#daily_totals"),this.weekly_totals_btn=s.find("#weekly_totals"),this.strict_range_btn=s.find("#strict_range"),this.all_employee_btn=this.all_employee_btn.SwitchButton({icon:a.SwitchButtonIcon.all_employee,tooltip:$.i18n._("Show Unscheduled Employees")}),this.daily_totals_btn=this.daily_totals_btn.SwitchButton({icon:a.SwitchButtonIcon.daily_total,tooltip:$.i18n._("Daily Totals")}),this.weekly_totals_btn=this.weekly_totals_btn.SwitchButton({icon:a.SwitchButtonIcon.weekly_total,tooltip:$.i18n._("Weekly Totals")}),this.strict_range_btn=this.strict_range_btn.SwitchButton({icon:a.SwitchButtonIcon.strict_range,tooltip:$.i18n._("Strict Range")}),this.all_employee_btn.click((function(){e.onShowEmployeeClick()})),this.daily_totals_btn.click((function(){e.onDailyTotalsClick()})),this.weekly_totals_btn.click((function(){e.onWeeklyTotalClick()})),this.strict_range_btn.setValue(!0),this.strict_range_btn.click((function(){e.onStrictRangeClick()})),this.toggle_button=$(this.el).find(".toggle-button-div");var _=[{label:$.i18n._("Day"),value:"day"},{label:$.i18n._("Week"),value:"week"},{label:$.i18n._("Month"),value:"month"},{label:$.i18n._("Year"),value:"year"}];this.toggle_button=this.toggle_button.TToggleButton({data_provider:_}),this.toggle_button.bind("change",(function(t,i){e.scroll_position=0,e.select_all_shifts_array=[],e.select_shifts_array=[],e.select_recurring_shifts_array=[],e.setToggleButtonUrl(),e.search(!0,!0)}))}onShowEmployeeClick(){this.search()}onStrictRangeClick(){this.search(!1,!0)}onWeeklyTotalClick(){this.checkScheduleData()&&(this.buildCalendars(),this.onResizeGrid())}onDailyTotalsClick(){this.getMode();this.checkScheduleData()&&this.grid&&this.grid.grid&&(this.buildCalendars(!0),this.onResizeGrid(),this.setScheduleGridRowSpan(),this.setMonthDateRowPosition(),this.setGridColumnsWidth())}checkScheduleData(){return!0!==this.full_schedule_data}showWeeklyTotal(){if(this.weekly_totals_btn.getValue())for(var e=0,t=0,i=0,a=0,s=this.getMode(),d=this.schedule_source.length,o=0;o<d;o++){var _=this.schedule_source[o];if(_.type!==r.DATE){for(var n in _){var c=Global.isSet(_[n])?_[n]:"";if(Global.isSet(c.user_id)||Global.isArray(c)&&s===l.YEAR)if(s===l.YEAR)for(var h=c.length,u=0;u<h;u++){var m=c[u];m.total_time_wage=parseFloat(m.total_time_wage),m.total_time=parseFloat(m.total_time),Global.isSet(m.user_id)&&(a=m.total_time_wage+a,10==m.status_id?(i=m.total_time+i,e+=1):20==c.status_id&&c.absence_policy_id!=TTUUID.zero_id&&c.absence_policy_id!=TTUUID.not_exist_id&&(i=m.total_time+i,t+=1))}else c.total_time_wage=parseFloat(c.total_time_wage),c.total_time=parseFloat(c.total_time),a=c.total_time_wage+a,10==c.status_id?(i=c.total_time+i,e+=1):20==c.status_id&&c.absence_policy_id!=TTUUID.zero_id&&c.absence_policy_id!=TTUUID.not_exist_id&&(i=c.total_time+i,t+=1);else Global.isSet(c.shifts)?(c.total_time_wage=parseFloat(c.total_time_wage),c.total_time=parseFloat(c.total_time),i=c.total_time+i,a=c.total_time_wage+a,e+=c.shifts,t+=c.absences):(_.type,r.DATE)}_.total_time=Global.getTimeUnit(i),_.total_time_wage=LocalCacheData.getCurrentCurrencySymbol()+Global.MoneyRound(a),_.shifts=e,_.absences=t,i=0,a=0,e=0,t=0}}}buildTotalShiftsValues(e,t){var i=Global.strToDateTime(t.start_date),a=Global.strToDateTime(t.end_date),s=i.getMinutes(),r=a.getMinutes();i.setMinutes(0),a.setMinutes(0);var l=i.format("hA"),d=a.format("hA"),o=Math.ceil(function(e,t){e||(e=new Date);return((t.getTime()-e.getTime())/1e3).toFixed(0)}(i,a)/60/60);if(o<1)e[d].value=e[d].value+Number((r/60).toFixed(0));else{e[l].value=0==s?e[l].value+1:e[l].value+Number(((60-s)/60).toFixed(2));for(var _=1;_<o;_++)i.setHours(i.getHours()+1),l=i.format("hA"),e.hasOwnProperty(l)&&(e[l].value=_==o-1&&r>0?e[l].value+Number((r/60).toFixed(2)):e[l].value+1)}}showDailyTotal(){if(this.daily_totals_btn.getValue()){for(var e=!0,t=null,i=[],a={},s=this.select_layout.data.display_columns,d=s.length,o=0;o<d;o++){var _=s[o];i.push({key:_,row:null,value:null})}var n=i.length;for(o=0;o<this.schedule_source.length;o++){var c=this.schedule_source[o];if(e){for(var h=0;h<n;h++){var u=i[h];(t={type:r.TOTAL})[u.key]=$.i18n._("Totals"),u.row=t,u.value=c[u.key]}(a={type:r.TOTAL}).user_full_name=$.i18n._("Overall Totals")}for(var m=n-1;m>=0;m--)c[(u=i[m]).key]!==u.value&&o>0&&!e&&0!==o&&(this.schedule_source.splice(o,0,u.row),o+=1,(t={type:r.TOTAL})[u.key]=$.i18n._("Totals"),u.row=t,u.value=c[u.key]);if(e&&(e=!1),c.type!==r.DATE){for(var p in c){for(var b=Global.isSet(c[p])?c[p]:"",g=0;g<n;g++)if(t=(u=i[g]).row,b&&Global.isSet(b.user_id)){var f=p.replace("_data",""),v=t[f];v&&Global.isSet(v.total_time)?v.total_time=parseInt(v.total_time):(t[f]={},(v=t[f]).total_time=0,v.total_shifts_dic=Global.clone(this.total_shifts_dic)),Global.isSet(v.shifts)||(v.shifts=0),Global.isSet(v.absences)||(v.absences=0),Global.isSet(v.total_time_wage)||(v.total_time_wage=0);var y=c[f+"_data"];y.total_time=parseInt(y.total_time),v.total_time_wage=Global.MoneyRound(parseFloat(parseFloat(y.total_time_wage)+parseFloat(v.total_time_wage))),10==y.status_id?(v.total_time=parseFloat(y.total_time)+parseFloat(v.total_time),v.shifts=v.shifts+1,this.getMode()===l.DAY&&this.buildTotalShiftsValues(v.total_shifts_dic,c[p])):20==y.status_id&&y.absence_policy_id!=TTUUID.zero_id&&y.absence_policy_id!=TTUUID.not_exist_id&&(v.total_time=parseFloat(y.total_time)+parseFloat(v.total_time),v.absences=v.absences+1)}b&&Global.isSet(b.user_id)&&((v=a[f=p.replace("_data","")])&&Global.isSet(v.total_time)||(a[f]={},(v=a[f]).total_time=0,v.total_shifts_dic=Global.clone(this.total_shifts_dic)),Global.isSet(v.shifts)||(v.shifts=0),Global.isSet(v.absences)||(v.absences=0),Global.isSet(v.total_time_wage)||(v.total_time_wage=0),y=c[f+"_data"],v.total_time_wage=Global.MoneyRound(parseFloat(parseFloat(y.total_time_wage)+parseFloat(v.total_time_wage))),10==y.status_id?(v.total_time=parseFloat(y.total_time)+parseFloat(v.total_time),v.shifts=v.shifts+1,this.getMode()===l.DAY&&this.buildTotalShiftsValues(v.total_shifts_dic,c[p])):20==y.status_id&&y.absence_policy_id!=TTUUID.zero_id&&y.absence_policy_id!=TTUUID.not_exist_id&&(v.total_time=parseFloat(y.total_time)+parseFloat(v.total_time),v.absences=v.absences+1))}if(o===this.schedule_source.length-1){for(h=i.length-1;h>=0;h--)this.schedule_source.push(i[h].row);this.schedule_source.push(a);break}}else this.schedule_source.splice(o,0,a),(a={type:r.TOTAL}).user_full_name=$.i18n._("Overall Totals"),o+=1}}}buildSearchFields(){super.buildSearchFields();var e=this,t={permission_section:"schedule"};PermissionManager.validate(this.permission_id,"view")||PermissionManager.validate(this.permission_id,"view_child")?this.search_fields=[new SearchField({label:$.i18n._("Status"),in_column:1,field:"status_id",multiple:!0,basic_search:!0,adv_search:!0,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Schedule Branch"),in_column:1,field:"schedule_branch_ids",layout_name:"global_branch",api_class:TTAPI.APIBranch,multiple:!0,basic_search:!0,adv_search:!0,script_name:"BranchView",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Schedule Department"),in_column:1,field:"department_ids",layout_name:"global_department",api_class:TTAPI.APIDepartment,multiple:!0,basic_search:!0,adv_search:!0,script_name:"DepartmentView",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Default Branch"),in_column:1,field:"default_branch_ids",layout_name:"global_branch",api_class:TTAPI.APIBranch,multiple:!0,basic_search:!1,adv_search:!0,script_name:"BranchView",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Default Department"),in_column:1,field:"default_department_ids",layout_name:"global_department",api_class:TTAPI.APIDepartment,multiple:!0,basic_search:!1,adv_search:!0,script_name:"DepartmentView",form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Group"),in_column:2,multiple:!0,field:"group_ids",layout_name:"global_tree_column",tree_mode:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Title"),field:"title_id",in_column:2,layout_name:"global_job_title",api_class:TTAPI.APIUserTitle,multiple:!0,basic_search:!0,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Job"),in_column:2,field:"job_id",layout_name:"global_job",api_class:Global.getProductEdition()>=20?TTAPI.APIJob:null,multiple:!0,basic_search:!1,adv_search:this.show_job_ui&&Global.getProductEdition()>=20,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Task"),in_column:2,field:"job_item_id",layout_name:"global_job_item",api_class:Global.getProductEdition()>=20?TTAPI.APIJobItem:null,multiple:!0,basic_search:!1,adv_search:this.show_job_item_ui&&Global.getProductEdition()>=20,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Recurring Template"),field:"recurring_schedule_template_control_id",in_column:2,layout_name:"global_recurring_schedule_control",api_class:TTAPI.APIRecurringScheduleTemplateControl,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Absence Policy"),field:"absence_policy_id",in_column:3,layout_name:"global_absences",api_class:TTAPI.APIAbsencePolicy,multiple:!0,basic_search:!1,adv_search:!0,form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Include Employees"),in_column:3,field:"include_user_ids",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!1,adv_search:!0,default_args:t,addition_source_function:function(t,i){return e.onEmployeeSourceCreate(t,i)},form_item_type:FormItemType.AWESOME_BOX}),new SearchField({label:$.i18n._("Exclude Employees"),in_column:3,field:"exclude_user_ids",layout_name:"global_user",api_class:TTAPI.APIUser,multiple:!0,basic_search:!1,adv_search:!0,default_args:t,addition_source_function:function(t,i){return e.onEmployeeSourceCreate(t,i)},form_item_type:FormItemType.AWESOME_BOX})]:(this.search_fields=[],this.search_fields.push(new SearchField({label:$.i18n._("Status"),in_column:1,field:"status_id",multiple:!0,basic_search:!0,adv_search:!1,layout_name:"global_option_column",form_item_type:FormItemType.AWESOME_BOX})),(PermissionManager.validate("punch","edit_branch")||PermissionManager.validate(this.permission_id,"edit_branch"))&&this.search_fields.push(new SearchField({label:$.i18n._("Schedule Branch"),in_column:1,field:"schedule_branch_ids",layout_name:"global_branch",api_class:TTAPI.APIBranch,multiple:!0,basic_search:!0,adv_search:!1,script_name:"BranchView",form_item_type:FormItemType.AWESOME_BOX})),(PermissionManager.validate("punch","edit_department")||PermissionManager.validate(this.permission_id,"edit_department"))&&this.search_fields.push(new SearchField({label:$.i18n._("Schedule Department"),in_column:1,field:"department_ids",layout_name:"global_department",api_class:TTAPI.APIDepartment,multiple:!0,basic_search:!0,adv_search:!1,script_name:"DepartmentView",form_item_type:FormItemType.AWESOME_BOX})))}onSourceDataCreate(e,t){var i=this,a=e.getDisplayColumns(),s={},r={};return $.each(a,(function(e,t){return s.id=TTUUID.not_exist_id,s[t.name]=Global.default_item,i.select_cells_Array.length>0&&!i.is_mass_editing&&(r.id="-2",r[t.name]=Global.selected_item),!1})),t&&"array"===$.type(t)||(t=[]),this.select_cells_Array.length>0&&!i.is_mass_editing&&t.unshift(r),t.unshift(s),t}onEmployeeSourceCreate(e,t){if(!this.checkOpenPermission())return t;var i=e.getDisplayColumns(),a={};return $.each(i,(function(e,t){return a.id=TTUUID.zero_id,a[t.name]=Global.open_item,!1})),t&&"array"===$.type(t)||(t=[]),t.unshift(a),t}addOPenField(e,t){}cleanWhenUnloadView(e){$("#schedule_view_container").remove(),super.cleanWhenUnloadView(e)}setAddRequestIcon(e,t,i){(Global.getProductEdition()<=10||!this.addPermissionValidate("request")||this.edit_only_mode)&&e.addClass("invisible-image"),!0===this.enableAddRequestButton()?e.removeClass("disable-image"):e.addClass("disable-image")}}var r=function(){};r.TOTAL=1,r.DATE=2,r.EMPTY=3;var l=function(){};l.DAY="day",l.WEEK="week",l.MONTH="month",l.YEAR="year"}}]);
//# sourceMappingURL=attendance-schedule-ScheduleViewController.bundle.js.map?v=9b205c2635aa9c3f999d