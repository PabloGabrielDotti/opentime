(self.webpackChunktimetrex=self.webpackChunktimetrex||[]).push([["wizard-import_csv-ImportCSVWizardController","filebrowser-TImageBrowser"],{3536:()=>{!function(t){t.fn.TImageBrowser=function(e){Global.addCss("global/widgets/filebrowser/TImageBrowser.css");var a,i,r=t.extend({},t.fn.TImageBrowser.defaults,e),n=this,s="filedata",l="",o=177,d=42;this.setEnabled=function(t){t;var e=this.find(".browser-form input");t?(e.removeAttr("disabled"),e.removeClass("disable-element")):(e.attr("disabled",!0),e.removeClass("disable-element").addClass("disable-element"))},this.clearErrorStyle=function(){},this.getFileName=function(){return i.val()},this.getField=function(){return a},this.setEnableDelete=function(t){var e=n.find(".image");t?e.attr("enable-delete",1):e.removeAttr("enable-delete")},this.getValue=function(){return i&&i.val()?"undefined"==typeof FormData?n.find(".browser-form"):new FormData(t(n.find(".browser-form"))[0]):null},this.getImageSrc=function(){return n.find(".image").attr("src")},this.setImage=function(t){var e=n.find(".image");if(!t)return e.attr("src",""),void e.hide();var a=new Date;e.hide(),e.attr("src",t+"&t="+a.getTime()),e.css("height","auto"),e.css("width","auto")};return this.setValue=function(t){t||(t="")},this.each((function(){var e=t.meta?t.extend({},r,t(this).data()):r;a=e.field,e.default_width>0&&(o=e.default_width),e.default_height>0&&(d=e.default_height),Global.isSet(e.name)&&(s=e.name),Global.isSet(l)&&(l=e.accept_filter),i=t(this).find(".browser");var p=t(this).find(".image");p.hide(),p.on("load",(function(){!function(e){var a=t(e).height()>0?t(e).height():e.naturalHeight,i=t(e).width()>0?t(e).width():e.naturalWidth;a>d&&t(e).css("height",d),i>o&&(t(e).css("width",o),t(e).css("height","auto")),n.trigger("setSize"),a<5?t(e).hide():t(e).show()}(this)})),l?i.attr("accept",l):(l="image/*",i.attr("accept","image/*")),i.attr("id","file_browser"),i.attr("name",s),Global.isSet(e.changeHandler)&&n.bind("imageChange",e.changeHandler),Global.isSet(e.deleteImageHandler)&&this.find(".file-browser").on("deleteClick",(function(){e.deleteImageHandler()})),i.bind("change",(function(){if(p.hide(),"undefined"!=typeof FileReader){var t=this.files?this.files:[];if(!t.length||!window.FileReader)return;if("image/*"===l){var e=new FileReader;e.readAsDataURL(t[0]),e.onloadend=function(){var t=this.result;p.attr("src",t)}}}n.trigger("imageChange",[n])}))})),this},t.fn.TImageBrowser.defaults={}}(jQuery)},8884:(t,e,a)=>{"use strict";a.r(e),a.d(e,{"ImportCSVWizardController":()=>i});a(3536);class i extends BaseWizardController{constructor(t={}){_.defaults(t,{el:".wizard-bg",api_import:null,parse_hint_source:null,field_source:null,select_grid_last_row:null,last_id:0,saved_layout_array:null,column_map_data:null}),super(t)}init(t){this.title=$.i18n._("Import Wizard"),this.steps=6,this.current_step=1,this.wizard_id="ProcessPayrollWizard",this.api_import=TTAPI.APIImport,this.render()}render(){super.render(),this.initCurrentStep()}buildCurrentStepUI(){var t=this;switch(this.content_div.empty(),this.current_step){case 1:var e=this.getLabel();e.text($.i18n._("Select the type of objects that you wish to import")+":");var a=this.getComboBox("import_class"),i=this.getLabel();i.text($.i18n._("Download example CSV file")),i.css("text-decoration","underline"),i.css("cursor","pointer"),i.css("margin-top","25px"),this.stepsWidgetDic[this.current_step]={},this.stepsWidgetDic[this.current_step][a.getField()]=a,i.unbind("click").bind("click",(function(){var e=t.stepsWidgetDic[t.current_step].import_class.getValue().toLowerCase(),a=ServiceCaller.getURLByObjectType("import_csv_example")+"import_"+e+"_example.csv";window.open(a,"_blank")})),this.stepsWidgetDic[this.current_step].example_label=i,a.unbind("change").bind("change",(function(t){i.text($.i18n._("Download example")+" "+a.getLabel()+" "+$.i18n._("CSV file"))})),this.content_div.append(e),this.content_div.append(a),this.content_div.append(i);break;case 2:(e=this.getLabel()).text($.i18n._("Upload Comma Separated Value (CSV) text file"));var r=this.getFileBrowser("file_uploader",".csv");this.stepsWidgetDic[this.current_step]={},this.stepsWidgetDic[this.current_step][r.getField()]=r,this.content_div.append(e),this.content_div.append(r),r.unbind("imageChange").bind("imageChange",(function(){r.getValue()&&(Global.setWidgetEnabled(t.back_btn,!0),Global.setWidgetEnabled(t.next_btn,!0))}));break;case 3:(e=this.getLabel()).text($.i18n._("Map columns from the uploaded file")+":"),this.stepsWidgetDic[this.current_step]={};var n=$("<div></div>"),s=$("<span></span>");n.append(s),s.text($.i18n._("Save Mapping As")+":");var l=Global.loadWidget("global/widgets/text_input/TTextInput.html");l=$(l).TTextInput();var o=$("<input class='t-button' style='margin-left: 5px' type='button' value='"+$.i18n._("Save")+"'></input>");n.append(l),n.append(o),s=$("<span style='margin-left: 5px' >"+$.i18n._("Saved Mapping")+":</span>");var d=Global.loadWidgetByName(FormItemType.COMBO_BOX);(d=d.TComboBox()).setValueKey("id"),d.setLabelKey("name");var p=$("<input class='t-button' style='margin-left: 5px' type='button' value='"+$.i18n._("Update")+"'></input>"),u=$("<input class='t-button' style='margin-left: 5px' type='button' value='"+$.i18n._("Delete")+"'></input>");o.unbind("click").bind("click",(function(){l.getValue()?t.saveNewMapping(l.getValue()):TAlertManager.showAlert($.i18n._("Mapping Name is blank"))})),p.unbind("click").bind("click",(function(){t.updateSelectMapping(d.getValue())})),u.unbind("click").bind("click",(function(){t.deleteSelectMapping(d.getValue())})),n.append(s),n.append(d),n.append(p),n.append(u),this.stepsWidgetDic[this.current_step].saved_mapping=d,d.bind("formItemChange",(function(e,a){t.onSavedLayoutChange(a.getValue())}));var c=$('<div style="margin-left: 15px;text-align: left; margin-bottom: 5px;"></div>'),_=$('<button class="plus-icon" style="margin-right: 5px;"></button>'),h=$('<button class="minus-icon"></button>');c.append(_),c.append(h),this.content_div.append(e),this.content_div.append(n),this.content_div.append(c);var m="import_data",g=$("<div class='grid-div wizard-grid-div'> <table id='import_data'></table></div>");this.setImportGrid(m,g),_.bind("click",(function(){t.addRow()})),h.bind("click",(function(){t.minusRow()}));break;case 4:(e=this.getLabel()).text($.i18n._("Select import settings")),this.content_div.append(e),this.stepsWidgetDic[this.current_step]={}}}onSavedLayoutChange(t){for(var e=this.stepsWidgetDic[this.current_step].import_data,a=this.saved_layout_array.length,i=1,r={},n=0;n<a;n++){var s=this.saved_layout_array[n];if(s.id===t){r=s.data;break}}for(n=0;n<r.length;n++){var l=r[n];l.id="csv"+i,l.field=l.field?l.field:TTUUID.zero_id,i+=1}this.last_id=i,r=this.setSampleRowBaseOnImportFile(r).slice(0),e.setData(r),this.bindGridRenderEvents(e)}setSampleRowBaseOnImportFile(t){if(this.import_data&&t){for(var e=0;e<t.length;e++){var a=t[e];a.row_1="";for(var i=0;i<this.import_data.length;i++){var r=this.import_data[i];if(a&&a.map_column_name&&r&&r.map_column_name&&a.map_column_name.trim()===r.map_column_name.trim()){a.row_1=r.row_1;break}}}return t}}getSavedMapping(t){var e=this,a={},i={};i.script="import_wizard"+this.stepsDataDic[1].import_class,i.deleted=!1,a.filter_data=i,TTAPI.APIUserGenericData.getUserGenericData(a,{onResult:function(a){var i=a.getResult();"array"!==$.type(i)?e.saveNewMapping(BaseViewController.default_layout_name,!0):(i.sort((function(t,e){return Global.compare(t,e,"name")})),e.saved_layout_array=i,t||(t=i[0].id,1==i[0].is_default||i[0].name==BaseViewController.default_layout_name?e.updateSelectMapping(t):e.saveNewMapping(BaseViewController.default_layout_name,!0)),e.setSavedMappingOptions(i,t))}})}getLayoutById(t){for(var e=this.saved_layout_array.length,a=0;a<e;a++){var i=this.saved_layout_array[a];if(i.id===t)return i}}deleteSelectMapping(t){var e=this,a=this.getLayoutById(t);1!=a.is_default&&a.name!==BaseViewController.default_layout_name?TAlertManager.showConfirmAlert($.i18n._("Are you sure you wish to continue?"),null,(function(a){a&&TTAPI.APIUserGenericData.deleteUserGenericData(t,{onResult:function(t){e.onSavedLayoutChange(e.saved_layout_array[0].id),e.getSavedMapping()}})})):TAlertManager.showAlert($.i18n._("Can't delete default layout"))}updateSelectMapping(t){var e=this;this.saveCurrentStep();var a=this.getLayoutById(t);a.data=this.stepsDataDic[this.current_step].import_data_for_layout,TTAPI.APIUserGenericData.setUserGenericData(a,{onResult:function(a){e.getSavedMapping(t)}})}saveNewMapping(t,e){this.saveCurrentStep();var a=this,i={};i.script="import_wizard"+this.stepsDataDic[1].import_class,i.name=t,i.is_default=!(!e||1!=e),i.data=this.stepsDataDic[this.current_step].import_data_for_layout,TTAPI.APIUserGenericData.setUserGenericData(i,{onResult:function(t){t.isValid()?a.getSavedMapping(t.getResult()):TAlertManager.showErrorAlert(t)}})}setSavedMappingOptions(t,e){var a=this;if(1==Global.isSet(a.stepsWidgetDic[a.current_step].saved_mapping)){var i=a.stepsWidgetDic[a.current_step].saved_mapping;i.setSourceData(t),e&&i.setValue(e)}a.saved_layout_array=t}addRow(){var t=this.stepsWidgetDic[this.current_step].import_data,e=t.getData(),a={};a.id="csv"+this.last_id,a.field=TTUUID.zero_id,a.default_value="",a.parse_hint="",a.map_column_name=$.i18n._("New Field Column"),a.row_1="",this.last_id=this.last_id+1,e.push(a),t.setData(e,!1),t.grid.jqGrid("setSelection",a.id),this.bindGridRenderEvents(t)}minusRow(){var t=this.stepsWidgetDic[this.current_step].import_data,e=t.getGridParam("selrow");if(e){for(var a=t.getGridParam("data"),i=a.length-1;i>=0;i--){a[i].id===e&&a.splice(i,1)}t.setData(a,!1),t.grid.jqGrid("setSelection",a[a.length-1].id)}}getGridColumns(t,e){var a=[],i=this;switch(t){case"import_data":var r={name:"map_column_name",index:"map_column_name",label:$.i18n._("File Column"),width:100,sortable:!1,title:!1,formatter:function(t,e,a){return i.onTextInputRender(t,e,a)}};a.push(r),r={name:"field",index:"field",label:$.i18n._("Field"),width:100,sortable:!1,title:!1,formatter:function(t,e,a){return i.onFieldRender(t,e,a)}},a.push(r),r={name:"default_value",index:"default_value",label:$.i18n._("Default Value"),width:100,sortable:!1,title:!1,formatter:function(t,e,a){return i.onTextInputRender(t,e,a)}},a.push(r),r={name:"parse_hint",index:"parse_hint",label:$.i18n._("Parse Hint"),width:100,sortable:!1,title:!1,formatter:function(t,e,a){return i.onParseHintRender(t,e,a)}},a.push(r),r={name:"row_1",index:"row_1",label:$.i18n._("Sample Row"),width:100,sortable:!1,title:!1},a.push(r)}e(a)}onParseHintRender(t,e,a){var i,r=e.colModel,n=e.rowId;if(this.parse_hint_source[a.field]){(i=(i=Global.loadWidgetByName(FormItemType.COMBO_BOX)).TComboBox({set_empty:!1})).attr("custom_cell","true"),i.attr("render_type","combobox"),i.attr("id",n+"_"+r.name),i.width("97%");var s=Global.buildRecordArray(this.parse_hint_source[a.field]);i.setSourceData(s),t?i.setValue(t):(i.setValue(s[0].value),a.parse_hint=s[0].value)}else(i=$('<input custom_cell="true" render_type="text" id="'+n+"_"+r.name+'" type="text" class="t-text-input" style="width: 97%">')).text(t);return i.get(0).outerHTML}onFieldRender(t,e,a){if(t){var i=e.colModel,r=e.rowId,n=Global.loadWidgetByName(FormItemType.COMBO_BOX);return(n=n.TComboBox({set_empty:!0})).attr("custom_cell","true"),n.attr("render_type","combobox"),n.attr("id",r+"_"+i.name),n.width("97%"),n.setSourceData(this.field_source),$(n[0]).find("[value="+t+"]").attr("selected",!0),n.get(0).outerHTML}}onTextInputRender(t,e,a){var i=e.colModel;return'<input custom_cell="true" render_type="text" id="'+e.rowId+"_"+i.name+'" value="'+t+'" type="text" class="t-text-input" style="width: 97%">'}buildCurrentStepData(){var t,e=this,a=this.stepsDataDic[this.current_step],i=this.stepsWidgetDic[this.current_step];switch(this.current_step){case 1:this.api_import.getImportObjects({onResult:function(t){var r=i.import_class,n=Global.buildRecordArray(t.getResult());r.setSourceData(n),a?r.setValue(a.import_class):e.default_data&&r.setValue(e.default_data),i.example_label.text($.i18n._("Download example")+" "+r.getLabel()+" "+$.i18n._("CSV file")),e.setButtonsStatus()}});break;case 3:if(t=i.import_data,a&&a.import_data_for_layout)return a.import_data_for_layout=this.setSampleRowBaseOnImportFile(a.import_data_for_layout),t.setData(a.import_data_for_layout),e.bindGridRenderEvents(t),e.setSavedMappingOptions(e.saved_layout_array,a.saved_mapping),void e.setButtonsStatus();this.api_import.getOptions("parse_hint",{onResult:function(t){e.parse_hint_source=t.getResult()}}),this.api_import.getOptions("columns",{onResult:function(a){e.field_source=Global.buildRecordArray(a.getResult()),e.api_import.getRawData(1,{onResult:function(a){var i=a.getResult();i=e.buildMappingGridDataArray(i[0]),e.api_import.generateColumnMap({onResult:function(a){e.column_map_data=a.getResult();var r=i.length;for(var n in e.column_map_data)for(var s=0;s<r;s++){var l=i[s],o=e.column_map_data[n];l.map_column_name==o.map_column_name&&(l.field=n,l.default_value=e.column_map_data[n].default_value?e.column_map_data[n].default_value:"",l.parse_hint=e.column_map_data[n].parse_hint?e.column_map_data[n].parse_hint:"")}i.sort((function(t,e){return Global.compare(t,e,"map_column_name")})),e.import_data=i,t.setData(i),e.bindGridRenderEvents(t),e.getSavedMapping(),e.setButtonsStatus()}})}})}});break;case 4:this.api_import.getOptions("import_options",{onResult:function(t){for(var i=Global.buildRecordArray(t.getResult()),r=$('<div style="text-align: left;margin-left: 15px;"></div>'),n=0;n<i.length;n++){var s=i[n],l=e.getCheckBox(s.value);a&&a[s.value]&&l.setValue(a[s.value]);var o=$('<label class="wizard-checkbox-label" style="display: block;">'+s.label+"</label>");o.prepend(l),e.stepsWidgetDic[e.current_step][s.value]=l,r.append(o)}e.content_div.append(r),e.setButtonsStatus()}});break;case 5:var r=this.stepsDataDic[3].import_data,n=this.stepsDataDic[4];this.api_import.import(r,n,!0,{onResult:function(t){if(5==e.current_step){if(t.isValid()){var a=e.getLabel();a.text($.i18n._("Data verification successful")),e.content_div.append(a)}else{var i=e.createErrorSource(t.getDetails());e.showErrorGrid($.i18n._("Verification failed due to the following reasons")+": ",i,$.i18n._("Continue to the next step to skip importing invalid records."),t.getRecordDetails())}e.setButtonsStatus()}}});break;case 6:r=this.stepsDataDic[3].import_data,n=this.stepsDataDic[4],this.api_import.setIsIdempotent(!0),this.api_import.import(r,n,!1,{onResult:function(t){if(6==e.current_step){if(t.isValid()){var a=e.getLabel();a.text($.i18n._("Import successful")),e.content_div.append(a)}else{var i=e.createErrorSource(t.getDetails());e.showErrorGrid($.i18n._("Import failed due to the following reasons")+":",i,$.i18n._("Invalid records have been skipped, all other records have been imported successfully."),t.getRecordDetails())}e.setButtonsStatus()}}});break;default:e.setButtonsStatus()}}showErrorGrid(t,e,a,i){var r=$("<span class='top-des clear-both-div'></span>");r.text(t),this.content_div.append(r);var n=$('<table id="error_grid"></table>'),s=[],l={name:"rowIndex",index:"rowIndex",label:$.i18n._("Row"),width:60,sortable:!1,title:!1,fixed:!0};s.push(l),l={name:"row",index:"row",label:$.i18n._("File Column"),width:100,sortable:!1,title:!1},s.push(l),l={name:"column",index:"column",label:$.i18n._("Field"),width:100,sortable:!1,title:!1},s.push(l),l={name:"message",index:"message",label:$.i18n._("Message"),width:100,sortable:!1,title:!1},s.push(l),this.content_div.append(n),(r=$("<span class='total-des clear-both-div'></span>")).text($.i18n._("Records")+":"+$.i18n._("Total")+": "+i.total+" "+$.i18n._("Valid")+": "+i.valid+" "+$.i18n._("Invalid")+": "+i.invalid),this.content_div.append(r),(r=$("<span class='bottom-des clear-both-div'></span>")).text(a),this.content_div.append(r),(n=new TTGrid("error_grid",{sortable:!1,width:this.content_div.width()-2},s)).setData(e),n.setGridColumnsWidth(null,{max_grid_width:this.content_div.width()-2})}createErrorSource(t){if(this.stepsDataDic&&this.stepsDataDic[3]){var e=this.stepsDataDic[3].import_data,a=[],i={};for(var r in t){var n=t[r].error;for(var s in n)if(n.hasOwnProperty(s)){for(var l in(i={}).rowIndex=parseInt(r)+2,i.row=$.i18n._("Unknown"),i.column=s,i.message=n[s][0],e)if(l==s){i.row=e[l].map_column_name,i.column=e[l].field_name;break}a.push(i)}}return a}}bindGridRenderEvents(t){var e=this,a=t.grid.find('input[custom_cell="true"]'),i=t.grid.find('select[custom_cell="true"]');a.unbind("change").bind("change",(function(t){e.onCellInputChange(t)})),i.unbind("change").bind("change",(function(t){e.onCellInputChange(t)})),a.unbind("focusin").bind("focusin",(function(t){e.onCellFocusIn(t)})),i.unbind("focusin").bind("focusin",(function(t){e.onCellFocusIn(t)}))}onCellFocusIn(t){var e=this.stepsWidgetDic[this.current_step].import_data,a=$(t.target).attr("id").split("_")[0];e.grid.jqGrid("setSelection",a)}onCellInputChange(t){for(var e=this,a=this.stepsWidgetDic[this.current_step].import_data,i=$(t.target),r=i.attr("id"),n=r.split("_")[0],s=r.substring(r.indexOf("_")+1,r.length),l=a.getData(),o=i.val(),d=l.length,p=0;p<d;p++){var u=l[p];if(u.id===n){u[s]=o;break}}"field"===s&&function(){var t,a=i.parent().parent().find("#"+n+"_parse_hint");a.attr("render_type");if(u.parse_hint="",e.parse_hint_source[o]){(t=(t=Global.loadWidgetByName(FormItemType.COMBO_BOX)).TComboBox({set_empty:!1})).attr("custom_cell","true"),t.attr("render_type","combobox"),t.attr("id",n+"_parse_hint"),t.width("97%");var r=Global.buildRecordArray(e.parse_hint_source[o]);t.setSourceData(Global.buildRecordArray(e.parse_hint_source[o])),t.setValue(r[0].value),u.parse_hint=r[0].value,a.parent().append(t),a.remove()}else t=$('<input custom_cell="true" render_type="text" id="'+n+'_parse_hint" value="" type="text" class="t-text-input" style="width: 97%">'),a.parent().append(t),a.remove();t.bind("change",(function(t){e.onCellInputChange(t)}))}()}setImportGrid(t,e,a){a||(a=!1);var i=this;this.content_div.append(e),this.getGridColumns(t,(function(e){i.stepsWidgetDic[i.current_step][t]=new TTGrid(t,{sortable:!1,height:300,multiselect:a,multiboxonly:a,editurl:"clientArray"},e),i.setGridSize(i.stepsWidgetDic[i.current_step][t]),i.setGridGroupColumns(t)}))}buildMappingGridDataArray(t){var e=[],a=1;for(var i in t)if(t.hasOwnProperty(i)){var r=t[i],n={};n.id="csv"+a,n.field=r.field?r.field:TTUUID.zero_id,n.default_value=r.default_value?r.default_value:"",n.parse_hint=r.parse_hint?r.parse_hint:"",n.map_column_name=r.map_column_name?r.map_column_name:i,n.row_1=r.row_1?r.row_1:r,e.push(n),a+=1}return this.last_id=a,e}onDoneClick(){this.cleanStepsData(),LocalCacheData.current_open_wizard_controller=null,this.saveAllStepsToUserGenericData((function(){})),this.call_back&&this.call_back(),$(this.el).remove()}initCurrentStep(){var t=this;t.progress_label.text("Step "+t.current_step+" of "+t.steps),t.progress.attr("max",t.steps),t.progress.val(t.current_step),t.buildCurrentStepUI(),t.buildCurrentStepData(),t.setCurrentStepValues()}onNextClick(){var t=this;this.saveCurrentStep();var e=this.stepsDataDic[this.current_step];if(Global.setWidgetEnabled(this.back_btn,!1),Global.setWidgetEnabled(this.next_btn,!1),2===this.current_step){if(!e.file_uploader)return void TAlertManager.showAlert($.i18n._("Please choose a CSV file first"));t.api_import.uploadFile(e.file_uploader,"object_type=import&object_id="+this.api_import.className,{onResult:function(e){"true"===e.toLowerCase()?(t.current_step=t.current_step+1,t.stepsDataDic[t.current_step]=null,t.initCurrentStep()):t.setButtonsStatus()}})}else this.current_step=this.current_step+1,this.initCurrentStep()}buildImportMapping(t){for(var e,a={},i=t.length,r=0;r<i;r++){var n=t[r];n.field&&((e={}).field=n.field,e.map_column_name=n.map_column_name,e.default_value=n.default_value,e.parse_hint=n.parse_hint,a[n.field]=e)}return a}saveCurrentStep(){this.stepsDataDic[this.current_step]={};var t=this.stepsDataDic[this.current_step],e=this.stepsWidgetDic[this.current_step];switch(this.current_step){case 1:t.import_class=e.import_class.getValue();var a=t.import_class.charAt(0).toUpperCase()+t.import_class.slice(1);this.api_import.className="APIImport"+a,this.api_import.key_name="Import"+a;break;case 2:t.file_uploader=e.file_uploader.getValue();break;case 3:var i=e.import_data;t.import_data=this.buildImportMapping(i.getData()),t.import_data_for_layout=i.getData(),t.saved_mapping=e.saved_mapping.getValue();break;case 4:for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r].getValue())}}setDefaultDataToSteps(){if(!this.default_data)return null}}}}]);
//# sourceMappingURL=wizard-import_csv-ImportCSVWizardController.bundle.js.map?v=a331ab4eb4e50843d311