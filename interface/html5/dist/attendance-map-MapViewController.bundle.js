(self.webpackChunktimetrex=self.webpackChunktimetrex||[]).push([["attendance-map-MapViewController","leaflet-timetrex"],{590:(t,e,a)=>{"use strict";a.r(e),a.d(e,{"MapViewController":()=>n});var i=a(6889);class n extends BaseViewController{constructor(t={}){_.defaults(t,{el:"#map_view_container",colors:[{name:"red",value:"#c0392b"},{name:"orange",value:"#d35400"},{name:"yellow",value:"#f39c12"},{name:"green",value:"#16a085"},{name:"lightblue",value:"#27ae60"},{name:"blue",value:"#2980b9"},{name:"purple",value:"#8e44ad"}],moved_unsaved_markers:null,punches_dic:{},punch_api:null,layers:null,circle_layers:null,display_mode:null,geo_labels:null,zoom_changed_timer:null,dragend_timer:null,popups:[],info_panel_dic:{},map_control:null,search_typing_delay:0,stop_suggestions:!1,map_last_bounds:null,geofence_filters:null,distances_grid:null,calculatedRouteData:null}),super(t)}init(){Global.getProductEdition()>=15&&(this.edit_only_mode=!0,this.moved_unsaved_markers={},this.edit_view_tpl="MapEditView.html",this.permission_id="punch",this.sub_view_mode=!0,this.viewId="Map",this.script_name="MapView",this.context_menu_name=$.i18n._("Map"),this.navigation_label=$.i18n._("Map")+":",this.punch_api=this.api=TTAPI.APIPunch,this.map_last_bounds=new L.LatLngBounds,this.calculatedRouteData={},Global.getProductEdition()>=20&&(this.geo_fence_api=TTAPI.APIGEOFence),this.user_api=TTAPI.APIUser,this.render(),this.buildContextMenu(),this.initData(),this.setSelectRibbonMenuIfNecessary())}getCustomContextMenuModel(){return{exclude:["default"],include:[ContextMenuIconName.save,ContextMenuIconName.cancel,ContextMenuIconName.export_excel]}}setEditMenuSaveIcon(t,e){this.parent_view_controller&&this.parent_view_controller.editPermissionValidate("punch")&&!this.parent_view_controller.is_mass_editing&&"geo_fence"!==this.display_mode||t.addClass("invisible-image"),this.is_changed&&!this.parent_view_controller.is_viewing||t.addClass("disable-image")}setDefaultMenuExportIcon(t,e,a){this.distances_grid||t.addClass("disable-image")}openEditView(t){this.incoming_data=t,this.user_generic_data_api=TTAPI.APIUserGenericData,this.edit_view||this.initEditViewUI(this.viewId,this.edit_view_tpl),this.initEditView()}buildEditViewUI(){super.buildEditViewUI();var t={"tab_map":{"label":$.i18n._("Map"),"init_callback":"initMapTabView"},"tab_map_distances":{"label":$.i18n._("Distances"),"init_callback":"initDistancesTableTabView"}};this.current_edit_record={},this.setTabModel(t),Global.getProductEdition()>=15&&(this.initLeafletMap(),this.populateLeafletMap(this.incoming_data),this.map_control._internal._leaflet_map.on("moveend",this.callbackMapPanning.bind(this)),ProgressBar.cancelProgressBar()),this.setEditViewDataDone()}initMapTabView(){this.buildContextMenu(!0),this.setEditMenu()}initDistancesTableTabView(){this.initDistanceGrid(),this.buildContextMenu(!0),this.setEditMenu()}checkTabPermissions(t){var e=!0;switch(t){case"tab_map_distances":e=!!(this.incoming_data&&this.incoming_data.tt_map_data&&this.incoming_data.tt_map_data.tt_routes&&this.incoming_data.tt_map_data.tt_routes.length>0)}return e}setEditViewDataDone(){super.setEditViewDataDone()}onSaveClick(t){var e=this;this.parent_view_controller.onMapSaveClick?this.parent_view_controller.onMapSaveClick(_.values(this.moved_unsaved_markers),(function(){e.is_changed=!1,e.moved_unsaved_markers={},e.removeEditView(),ProgressBar.closeOverlay()})):Debug.Text("ERROR: Save function does not exist on parent ViewController. Missing function or marker should not be set to draggable.","MapViewController.js","MapViewController","onSaveClick",1)}onExportClick(t){ProgressBar.showOverlay(),this.distances_grid?this.distances_grid.grid2csv("driving_distances"):Debug.Text("ERROR: Exporting Grid To CSV Failed, grid does not exist.","MapViewController.js","MapViewController","onExportClick",1),ProgressBar.closeOverlay()}initLeafletMap(){var t;if("timetrex"==APIGlobal.pre_login_data.map_provider){var e=APIGlobal.pre_login_data.map_tile_url+"/{z}/{x}/{y}.png?tt_key="+APIGlobal.pre_login_data.registration_key;t=new L.TileLayer(e,{minZoom:3,maxZoom:18,attribution:'Map data by Â©<a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>.',noWrap:!0})}else t=L.tileLayer.provider(APIGlobal.pre_login_data.map_provider);this.map_control=new i.TTMap("map",{autoPan:!1,maxBoundsViscosity:1,layers:[t]});var a=this.map_control.getCenter(),n=this.startMapCoordinates();!1===a.equals(n)&&this.map_control.setView(n,10),this.initRoutingLogic();this.map_control.createLayer("markers",{type:"marker-cluster",cluster_layer_options:{maxClusterRadius:55,spiderfyDistanceMultiplier:5,showCoverageOnHover:!1}}),this.map_control.createLayer("lines"),this.map_control.createLayer("marker-circles"),this.map_control.createLayer("geofences"),this.initSearchBox()}initRoutingLogic(){var t={routing_url:APIGlobal.pre_login_data.map_routing_url};this.map_control.createLayer("routes"),this.map_control.initRoutingEngine(t)}populateLeafletMap(t){if(t.length>0&&t[0].hasOwnProperty("geo_type_id")){var e=this.drawGeoFences(t);return this.extendMapBounds(e),!0}if(!t||!t.options||!t.tt_map_data)return Debug.Text("Error: TTMapData is in an invalid format. Abort.","MapViewController.js","MapViewController","populateLeafletMap",1),!1;window.map_control=this.map_control;var a={callbackDistanceResults:this.callbackDistanceResults.bind(this)};if(!0===t.options.single_marker_draggable&&t.tt_map_data.tt_markers&&0===t.tt_map_data.tt_markers.length){var i={draggable:!0,callbacks:{onMarkerDragend:this.callbackTriggerMarkerMove.bind(this),onMarkerAddNew:this.callbackTriggerMarkerMove.bind(this)}};this.map_control.addMarkerInteractive(i),Debug.Text("Note: No markers found in data. May be new record/existing with no gps","MapViewController.js","MapViewController","populateLeafletMap",10)}t.tt_map_data.tt_markers&&1===t.tt_map_data.tt_markers.length&&(t.tt_map_data.tt_markers[0].callbacks=t.tt_map_data.tt_markers[0].callbacks||{},t.tt_map_data.tt_markers[0].callbacks.onMarkerDragend&&Debug.Text("Error: Duplicate onMarkerDragEnd callback found. Overwriting parent view callback.","MapViewController.js","MapViewController","populateLeafletMap",1),t.tt_map_data.tt_markers[0].callbacks.onMarkerDragend=this.callbackTriggerMarkerMove.bind(this)),t.tt_map_data.tt_markers&&t.tt_map_data.tt_markers.length>0?this.map_control.addTTMapData(t.tt_map_data,a):Debug.Text("Error: No data to plot for map.","MapViewController.js","MapViewController","populateLeafletMap",1);var n=this.generateMarkerBounds();if(this.extendMapBounds(n),t.geofence_filters&&Object.keys(t.geofence_filters).length>0&&void 0===t.geofence_filters.length){this.geofence_filters=t.geofence_filters;var r=this;setTimeout((function(){r.initGeoFences("initial-map-load")}),1e3)}}callbackTriggerMarkerMove(t,e){var a=this;a.is_changed=!0,a.setEditMenu();var i=t.options.punch_id;a.moved_unsaved_markers[i]={id:i,latitude:e.lat.toFixed(6),longitude:e.lng.toFixed(6),position_accuracy:0},Debug.Text("Marker position change:\nOriginal: "+t.getLatLng().toString()+"\n=> New: "+e.toString(),"MapViewController.js","MapViewController","callbackTriggerMarkerMove",10)}callbackMapPanning(){clearTimeout(this._mapZoomEndTimer);var t=this;this._mapZoomEndTimer=setTimeout((function(){t.initGeoFences("map-panning-end")}),500)}callbackDistanceResults(t,e){this.calculatedRouteData[t]=e}initSearchBox(){var t=this,e=$("#pac-input");e.bind("focus",(function(t){$(this).select()})),e.bind("keyup",(function(e){13===e.keyCode?$("#suggestion-box div").first().click():(t.search_key_delay=parseInt(Date.now()),window.setTimeout((function(){parseInt(Date.now())-t.search_key_delay>=250&&(t.stop_suggestions=!1,t.searchSuggest())}),300))}))}searchSuggest(){var t=$("#suggestion-box");t.html("");var e=this,a=$("#pac-input");if(a.val().length>=3){a.css("border","1px dotted green");var i=APIGlobal.pre_login_data.map_geocode_url+"?q="+encodeURIComponent(a.val())+"&format=json&tt_key="+APIGlobal.pre_login_data.registration_key;$.get(i,(function(i){if(a.css("border","none"),!1===e.stop_suggestions)for(var n in t.html(""),i){var r=i[n].display_name,o=new L.LatLng(i[n].lat,i[n].lon),s=i[n].boundingbox,l=(i[n].lat,i[n].lon,$('<div class="map-suggest"></div>'));l.text(r),l.data("latlng",o),l.data("bounds",s),l.css({display:"block",position:"relative",cursor:"pointer",padding:"7px",background:"white"}),l.on("click",(function(){var a=$(this).data("latlng"),i=$(this).data("bounds"),n=new L.LatLngBounds([i[0],i[2]],[i[1],i[3]]);e.map_control.panTo(a),e.map_control.fitBounds(n,{padding:[20,20]}),e.map_control.panTo(n.getCenter()),t.fadeOut("fast"),t.html(""),e.stop_suggestions=!0})),t.append(l),t.fadeIn("fast")}}))}}initGeoFences(t){if(this.geo_fence_api&&this.geofence_filters){var e=this,a=e.map_control.getCenter(),i={center:[a.lat,a.lng],radius:this.getViewAreaRadius()},n=this.geofence_filters,r=n.branch_id,o=n.department_id,s=n.job_id,l=n.job_item_id;e.geo_fence_api.getGEOFenceByGEOLocationAndBranchAndDepartmentAndJobAndTask(i,r,o,s,l,{onResult:function(a){var i=a.getResult();if(i&&i.length>0){var n=e.drawGeoFences(i);"initial-map-load"===t&&e.extendMapBounds(n)}}})}else Debug.Text("_InitGeoFence() Denied. Functionality unavailable in this product edition.","MapViewController.js","MapViewController","_initGeoFence",10)}drawGeoFences(t){if(t&&t.length>0){this.map_control.getLayer("geofences").clear(),this.geo_labels=[];for(var e=new L.LatLngBounds,a=0,i=t.length;a<i;a++){var n=t[a];10==n.geo_type_id&&n.geo_polygon?e.extend(this.map_control.drawGeoFencePolygon(n)):20==n.geo_type_id&&n.geo_circle&&e.extend(this.map_control.drawGeoFenceCircle(n))}return e}}extendMapBounds(t,e){return void 0!==t&&((a=e?new L.LatLngBounds:this.map_last_bounds).extend(t),this.map_last_bounds=a,this.map_control.fitBounds(a,{padding:[15,15],maxZoom:13}),!0);var a}generateMarkerBounds(){var t=Object.values(this.map_control.getLayer("markers").get());if(!(t.length<1)){var e=new L.LatLngBounds;return t.map((function(t){e.extend(t.getLatLng())})),e}}getViewAreaRadius(){var t=this.map_control.getBounds();if(!t)return 0;var e=t.getCenter(),a=t.getNorthEast(),i=e.lat/57.2958,n=e.lng/57.2958,r=a.lat/57.2958,o=a.lng/57.2958;return 1609.344*(3963*Math.acos(Math.sin(i)*Math.sin(r)+Math.cos(i)*Math.cos(r)*Math.cos(o-n)))}initDistanceGrid(){if(!this.distances_grid){var t=this.edit_view_tab.find("#tab_map_distances_content_div");this.distances_grid=this.buildDistancesGrid("distance_grid_table"),t.append(this.distances_grid)}}buildDistancesGrid(t){var e=[],a={name:"default",index:"default",label:$.i18n._("Default"),sortable:!0,formatter:"select",editable:!1,title:!1,edittype:"select"};function i(t,i,n){var r={name:t,index:t,label:i};n&&jQuery.extend(r,n),e.push(jQuery.extend({},a,r))}i("first_name",$.i18n._("First Name")),i("last_name",$.i18n._("Last Name")),i("branch",$.i18n._("Branch")),i("department",$.i18n._("Department")),i("job_manual_id",$.i18n._("Job Code")),i("job",$.i18n._("Job")),i("job_item_manual_id",$.i18n._("Task Code")),i("job_item",$.i18n._("Task")),i("in_time_stamp",$.i18n._("In Punch")),i("out_time_stamp",$.i18n._("Out Punch")),i("total_time",$.i18n._("Total Time")),i("duration",$.i18n._("Driving Duration")),i("distance",$.i18n._("Driving Distance")),i("in_latitude",$.i18n._("In Latitude")),i("in_longitude",$.i18n._("In Longitude")),i("out_latitude",$.i18n._("Out Latitude")),i("out_longitude",$.i18n._("Out Longitude"));var n=this,r=this.getDistancesGridData();return new TTGrid(t,{data:r,gridComplete:function(){n.setDistancesTableGridSize()},multiselect:!1},e)}getDistancesGridData(){var t=this,e=[],a=this.incoming_data.tt_map_data.tt_routes;return!(!a||a.length<1)&&(Object.values(a).map((function(a){var n=a.route_markers[0].punch,r=a.route_markers[1].punch;"In"===n.status&&"Out"===r.status||Debug.Text("ERROR: in_punch and out_punch have data mismatch punch In/Out status","MapViewController.js","MapViewController","getDistancesGridData",1),n.first_name===r.first_name&&n.last_name===r.last_name&&n.branch===r.branch&&n.department===r.department&&n.job===r.job&&n.job_item===r.job_item||Debug.Text("ERROR: in_punch and out_punch have data mismatch.","MapViewController.js","MapViewController","getDistancesGridData",1);var o,s=[!1,void 0,null,"false","undefined","null"],l={first_name:Global.filterOutput(n.first_name,s),last_name:Global.filterOutput(n.last_name,s),in_time_stamp:Global.filterOutput(n.time_stamp,s),in_latitude:Global.filterOutput(n.latitude,s),in_longitude:Global.filterOutput(n.longitude,s),out_time_stamp:Global.filterOutput(r.time_stamp,s),out_latitude:Global.filterOutput(r.latitude,s),out_longitude:Global.filterOutput(r.longitude,s),distance:"",duration:"",branch:Global.filterOutput(n.branch,s),department:Global.filterOutput(n.department,s),job_manual_id:Global.filterOutput(n.job_manual_id,s),job:Global.filterOutput(n.job,s),job_item_manual_id:Global.filterOutput(n.job_item_manual_id,s),job_item:Global.filterOutput(n.job_item,s),total_time:Global.filterOutput(Global.getTimeUnit(n.total_time),s)};if(a.route_distance&&a.route_duration)o={distance:i.TTConvertMapData.convertMetersToUserUnits(a.route_distance).distance_in_user_format,duration:Global.getTimeUnit(a.route_duration)},jQuery.extend(l,o);else if(a.foundDuplicateLine&&t.calculatedRouteData[a.ref_id]){var d=t.calculatedRouteData[a.ref_id];o={distance:i.TTConvertMapData.convertMetersToUserUnits(d.route_distance).distance_in_user_format,duration:Global.getTimeUnit(d.route_duration)},jQuery.extend(l,o)}else Debug.Text("Note: No distance data found for entry. Leaving as empty strings","MapViewController.js","MapViewController","getDistancesGridData",10);e.push(l)})),e)}setDistancesTableGridSize(t){if(t){var e=this.edit_view.find("#tab_map_distances_content_div");t.grid.setGridWidth(e.width()),t.grid.setGridHeight(e.height()),t.setGridColumnsWidth()}}}}}]);
//# sourceMappingURL=attendance-map-MapViewController.bundle.js.map?v=85d9db9f6464fa6b6266